const express = require("express");
const cors = require("cors");

const app = express();
app.use(cors());
app.use(express.json());
const path = require("path");
// 🟡 이 코드 추가 (정적 파일 경로 설정)
app.use(express.static(path.join(__dirname)));

// 🟡 이 코드 추가 (gagl.html 요청 시 해당 파일 반환)
app.get("/gagl.html", (req, res) => {
    res.sendFile(path.join(__dirname, "gagl.html"));
});

app.post("/attack", (req, res) => {
    const 유저 = req.body.유저데이터;
    const 몬스터 = req.body.몬스터;

    // 1️⃣ 아이언바디로 체력 회복
    const 추가회복 = 아이언바디회복(유저);
    유저.남은체력 = Math.min(유저.최대체력, 유저.남은체력 + 추가회복);

    // 2️⃣ 전투 시뮬레이션 실행
    const 전투 = 전투시뮬레이션(유저, 몬스터);

    // 3️⃣ 패배면 그대로 응답
    if (전투.결과 === "패배") {
        return res.json({
            결과: "패배",
            유저남은체력: 전투.유저남은체력,
            유저데이터: { ...유저, 남은체력: 유저.최대체력, 현재악마번호: Math.floor(Math.random() * 72) + 1, 강림몬스터: null }
        });
    }

    // 4️⃣ 승리면 보상 적용
    const 기본보상 = 보상계산(유저.현재층);

    // 추가 보정
    기본보상.숙련도 += 인사이트추가숙련도(유저);
    기본보상.경험치 += 인텔리전스추가경험치(유저);
    기본보상.골드 = Math.floor(기본보상.골드 * 획득금화발굴(유저));

    const 레벨업 = 레벨업판정(유저.경험치 + 기본보상.경험치, 유저.레벨);
    const 드레인 = 드레인회복(유저);

    // 새 유저 데이터 계산
    const 새유저 = 전투보상반영(유저, 기본보상, 드레인, 레벨업);

    res.json({
        결과: "승리",
        유저남은체력: 새유저.남은체력,
        보상: 기본보상,
        레벨업,
        회복: 드레인,
        유저데이터: 새유저
    });
});

app.listen(3000, () => {
    console.log("서버 실행 중: http://localhost:3000");
});

function 공격스킬적용(유저) {
    const 스킬 = 유저.스킬 || {};
    const 결과 = {
        크리티컬배율: 1,
        버서커배율: 1,
        체력소모: 1,
    };

    // 크리티컬
    const 크리계열 = [
        { 이름: "알파 크리티컬", 배율: 0.2 },
        { 이름: "베타 크리티컬", 배율: 0.4 },
        { 이름: "감마 크리티컬", 배율: 0.6 },
        { 이름: "델타 크리티컬", 배율: 0.8 },
        { 이름: "엡실론 크리티컬", 배율: 1.0 },
        { 이름: "제타 크리티컬", 배율: 1.2 },
        { 이름: "에타 크리티컬", 배율: 1.4 },
    ];
    const 크리레벨 = 스킬["크리티컬"] || 0;
    for (let i = 0; i < 크리계열.length; i++) {
        const 시작 = i * 10;
        const 현재 = Math.max(0, Math.min(크리레벨 - 시작, 10));
        if (현재 <= 0) break;
        const 확률 = 현재 >= 10 ? 1 : 현재 * 0.1;
        if (Math.random() < 확률) {
            결과.크리티컬배율 += (크리계열[i].배율);
        } else break;
    }

    // 버서커
    const 버서커계열 = [
        { 이름: "앵거 버서커", 배율: 0.4, 소모: 1 },
        { 이름: "레이지 버서커", 배율: 0.8, 소모: 2 },
        { 이름: "프렌지 버서커", 배율: 1.2, 소모: 3 },
        { 이름: "매드니스 버서커", 배율: 1.6, 소모: 4 },
        { 이름: "하울 버서커", 배율: 2.0, 소모: 5 },
        { 이름: "새비지 버서커", 배율: 2.4, 소모: 6 },
        { 이름: "블러드 버서커", 배율: 2.8, 소모: 7 },
        { 이름: "카오스 버서커", 배율: 3.2, 소모: 8 },
    ];
    const 버서커레벨 = 스킬["버서커"] || 0;
    for (let i = 0; i < 버서커계열.length; i++) {
        const 시작 = i * 10;
        const 현재 = Math.max(0, Math.min(버서커레벨 - 시작, 10));
        if (현재 <= 0) break;
        const 확률 = 현재 >= 10 ? 1 : 현재 * 0.1;
        if (Math.random() < 확률) {
            결과.버서커배율 += 버서커계열[i].배율;
            결과.체력소모 += 버서커계열[i].소모;
        } else break;
    }

    return 결과;
}

function 데미지계산(유저, 몬스터, 스킬결과) {
    const 방어력 = 몬스터.방어력 || 0;
    const 랜덤보정 = Math.random() * 0.2 + 0.8;

    const 기본데미지 = Math.max(0, 유저.공격력 - 방어력);
    const 랜덤데미지 = Math.floor(기본데미지 * 랜덤보정);

    const 최종배율 = (스킬결과.크리티컬배율) * (스킬결과.버서커배율);
    const 최종데미지 = Math.floor(랜덤데미지 * 최종배율);

    return 최종데미지;
}

function 전투시뮬레이션(유저, 몬스터) {
    let 유저HP = 유저.남은체력;
    let 몬스터HP = 몬스터.체력;

    while (유저HP > 0 && 몬스터HP > 0) {
        const 스킬 = 공격스킬적용(유저);
        const 데미지 = 데미지계산(유저, 몬스터, 스킬);

        몬스터HP -= 데미지;
        유저HP -= 스킬.체력소모;

        몬스터HP = Math.max(0, 몬스터HP);
        유저HP = Math.max(0, 유저HP);
    }

    return {
        결과: 유저HP <= 0 ? "패배" : "승리",
        유저남은체력: 유저HP,
        몬스터남은체력: 몬스터HP
    };
}

function 보상계산(층) {
    const 경험치 = Math.floor(층 * 1 * 108);
    const 골드 = (Math.floor(Math.random() * 100) + 층 * 100) * 108;
    const 숙련도 = Math.floor(층 * 1 * 108);

    return { 경험치, 골드, 숙련도 };
}

function 레벨업판정(현재경험치, 현재레벨) {
    const 새레벨 = Math.floor(현재경험치 / 1000) + 1;

    const 증가량 = 새레벨 - 현재레벨;

    return {
        새레벨,
        증가한레벨: 증가량,
        공격력증가: 증가량 * 1 // 레벨 1당 공격력 +1
    };
}

function 드레인회복(유저) {
    const 스킬 = 유저.스킬 || {};
    const 드레인레벨 = 스킬["드레인"] || 0;

    const 스킬들 = [
        { 이름: "기가 드레인", 회복: 1 },
        { 이름: "테라 드레인", 회복: 2 },
        { 이름: "페타 드레인", 회복: 3 },
        { 이름: "엑사 드레인", 회복: 4 },
        { 이름: "제타 드레인", 회복: 5 },
        { 이름: "요타 드레인", 회복: 6 },
        { 이름: "로나 드레인", 회복: 7 },
        { 이름: "쿼카 드레인", 회복: 8 },
    ];

    let 총회복량 = 0;

    for (let i = 0; i < 스킬들.length; i++) {
        const 시작 = i * 10;
        const 현재레벨 = Math.max(0, Math.min(드레인레벨 - 시작, 10));
        if (현재레벨 <= 0) break;

        const 확률 = 현재레벨 >= 10 ? 1 : 현재레벨 * 0.1;
        if (Math.random() < 확률) {
            총회복량 += 스킬들[i].회복;
        } else break;
    }

    return 총회복량;
}

function 아이언바디회복(유저) {
    const 스킬 = 유저.스킬 || {};
    const 아이언레벨 = 스킬["아이언바디"] || 0;

    const 스킬들 = [
        { 이름: "스톤 아이언바디", 회복: 1 },
        { 이름: "스틸 아이언바디", 회복: 2 },
        { 이름: "티탄 아이언바디", 회복: 3 },
        { 이름: "플레이트 아이언바디", 회복: 4 },
        { 이름: "미스릴 아이언바디", 회복: 5 },
    ];

    let 공격전회복량 = 0;

    for (let i = 0; i < 스킬들.length; i++) {
        const 시작 = i * 10;
        const 현재 = Math.max(0, Math.min(아이언레벨 - 시작, 10));
        if (현재 <= 0) break;

        const 확률 = 현재 >= 10 ? 1 : 현재 * 0.1;
        if (Math.random() < 확률) {
            공격전회복량 += 스킬들[i].회복;
        } else break;
    }

    return 공격전회복량;
}

function 인사이트추가숙련도(유저) {
    const 스킬 = 유저.스킬 || {};
    const 인사이트레벨 = 스킬["인사이트"] || 0;

    const 스킬들 = [
        { 이름: "마이크로 인사이트", 추가: 108 },
        { 이름: "나노 인사이트", 추가: 316 },
    ];

    let 추가숙련도 = 0;

    for (let i = 0; i < 스킬들.length; i++) {
        const 시작 = i * 10;
        const 현재 = Math.max(0, Math.min(인사이트레벨 - 시작, 10));
        if (현재 <= 0) break;

        const 확률 = 현재 >= 10 ? 1 : 현재 * 0.1;
        if (Math.random() < 확률) {
            추가숙련도 += 스킬들[i].추가;
        } else break;
    }

    return 추가숙련도;
}

function 인텔리전스추가경험치(유저) {
    const 스킬 = 유저.스킬 || {};
    const 인텔리레벨 = 스킬["인텔리전스"] || 0;

    const 스킬들 = [
        { 이름: "클레어 인텔리전스", 추가: 108 },
        { 이름: "옵저브 인텔리전스", 추가: 316 },
    ];

    let 추가경험치 = 0;

    for (let i = 0; i < 스킬들.length; i++) {
        const 시작 = i * 10;
        const 현재 = Math.max(0, Math.min(인텔리레벨 - 시작, 10));
        if (현재 <= 0) break;

        const 확률 = 현재 >= 10 ? 1 : 현재 * 0.1;
        if (Math.random() < 확률) {
            추가경험치 += 스킬들[i].추가;
        } else break;
    }

    return 추가경험치;
}

function 획득금화발굴(유저) {
    const 스킬 = 유저.스킬 || {};
    const 발굴레벨 = 스킬["발굴"] || 0;

    const 스킬들 = [
        { 이름: "루비 발굴", 증가: 0.2 },
        { 이름: "사파이어 발굴", 증가: 0.4 },
        { 이름: "에메랄드 발굴", 증가: 0.6 },
        { 이름: "다이아몬드 발굴", 증가: 0.8 },
        { 이름: "토파즈 발굴", 증가: 1.0 },
    ];

    let 금화배율 = 0;

    for (let i = 0; i < 스킬들.length; i++) {
        const 시작 = i * 10;
        const 현재 = Math.max(0, Math.min(발굴레벨 - 시작, 10));
        if (현재 <= 0) break;

        const 확률 = 현재 >= 10 ? 1 : 현재 * 0.1;
        if (Math.random() < 확률) {
            금화배율 += 스킬들[i].배율;
        } else break;
    }

    return 1 + 금화배율; // 곱셈용
}

function 전투보상반영(유저, 보상, 회복량, 레벨업정보) {
    const 새유저 = { ...유저 };

    새유저.경험치 += 보상.경험치;
    새유저.골드 += 보상.골드;
    새유저.숙련도 += 보상.숙련도;

    새유저.레벨 += 레벨업정보.증가한레벨;
    새유저.공격력 += 레벨업정보.공격력증가;

    새유저.남은체력 = Math.min(
        새유저.최대체력,
        새유저.남은체력 + 회복량
    );

    새유저.현재악마번호 = Math.floor(Math.random() * 72) + 1;
    새유저.강림몬스터 = null;

    return 새유저;
}

