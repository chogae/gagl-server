const express = require("express");
const cors = require("cors");
const path = require("path");

const { createClient } = require("@supabase/supabase-js"); // ğŸŸ¡ Supabase Adminìš©

const app = express();
app.use(cors());
app.use(express.json());

// ğŸŸ¡ gagl.html ìš”ì²­ ì‹œ í•´ë‹¹ íŒŒì¼ ë°˜í™˜
app.get("/gagl.html", (req, res) => {
    res.sendFile(path.join(__dirname, "gagl.html"));
});

// âœ… Supabase Admin client ì„¤ì • (íšŒì›íƒˆí‡´ìš©, ì ˆëŒ€ í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œê¸ˆì§€)
const supabaseAdmin = createClient(
    "https://piafesfywtvpachbfoxr.supabase.co", // í”„ë¡œì íŠ¸ URL
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpYWZlc2Z5d3R2cGFjaGJmb3hyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NDc4NDAxOCwiZXhwIjoyMDYwMzYwMDE4fQ.inGkUGNirltn3arVtb3rPvLpzoxK28OCDOx04rAH0EE"           // ì„œë¹„ìŠ¤ ë¡¤ í‚¤
);



app.post("/get-user", async (req, res) => {
    const { ìœ ì €UID } = req.body;

    if (!ìœ ì €UID) {
        return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });
    }

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) {
        return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });
    }




    const now = new Date();
    const formatter = new Intl.DateTimeFormat("ko-KR", {
        weekday: "short",
        timeZone: "Asia/Seoul"
    });
    const parts = formatter.formatToParts(now);
    const ìš”ì¼ = parts.find(p => p.type === "weekday")?.value;

    if (ìš”ì¼ === "ì¼") {
        const { data: ì „ì²´í•©, error: í•©ê³„ì—ëŸ¬ } = await supabaseAdmin
            .from("users")
            .select("ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€");

        if (í•©ê³„ì—ëŸ¬ || !ì „ì²´í•©) {
            return res.status(500).json({ ì˜¤ë¥˜: "í«ë‹¨ê³„ ê³„ì‚° ì‹¤íŒ¨ (ì´í•© ì¡°íšŒ ì—ëŸ¬)" });
        }

        const ëˆ„ì ë°ë¯¸ì§€ì´í•© = ì „ì²´í•©
            .filter(u => u.ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€ > 0)
            .reduce((í•©, u) => í•© + Number(u.ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€), 0);

        if (ëˆ„ì ë°ë¯¸ì§€ì´í•© != 0) {
            const { data: ìƒìœ„ìœ ì €ë“¤, error: ìˆœìœ„ì—ëŸ¬ } = await supabaseAdmin
                .from("users")
                .select("ìœ ì €UID, ê³¨ë“œ")
                .gt("ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€", 0)               // ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€ê°€ 0ì´ˆê³¼ì¸ ìœ ì €ë§Œ
                .order("ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€", { ascending: false })
                .limit(9);

            if (!ìˆœìœ„ì—ëŸ¬) {
                for (let i = 0; i < ìƒìœ„ìœ ì €ë“¤.length; i++) {
                    const user = ìƒìœ„ìœ ì €ë“¤[i];
                    const ì§€ê¸‰í‹°ì¼“ = 10 - i;

                    const { data: í˜„ì¬ìœ ì €, error: fetchErr } = await supabaseAdmin
                        .from("users")
                        .select("ìš°í¸í•¨, ìœ ì €ì•„ì´ë””") // âœ… ìš°í¸í•¨ë„ í•¨ê»˜ ê°€ì ¸ì˜¤ê¸°
                        .eq("ìœ ì €UID", user.ìœ ì €UID)
                        .single();

                    if (fetchErr || !í˜„ì¬ìœ ì €) {
                        console.error(`ìš°í¸í•¨ ì¡°íšŒ ì‹¤íŒ¨ (${user.ìœ ì €UID}):`, fetchErr);
                        continue;
                    }

                    const oldMail = í˜„ì¬ìœ ì €.ìš°í¸í•¨ || [];
                    const ìƒˆìš°í¸ = { ì´ë¦„: "í‹°ì¼“", ìˆ˜ëŸ‰: ì§€ê¸‰í‹°ì¼“ };
                    const newMail = [...oldMail, ìƒˆìš°í¸];

                    const { error: updateErr } = await supabaseAdmin
                        .from("users")
                        .update({ ìš°í¸í•¨: newMail })
                        .eq("ìœ ì €UID", user.ìœ ì €UID);

                    if (updateErr) {
                        console.error(`ìš°í¸ ì§€ê¸‰ ì‹¤íŒ¨ (${user.ìœ ì €UID}):`, updateErr);
                        await ë¡œê·¸ê¸°ë¡(í˜„ì¬ìœ ì €.ìœ ì €ì•„ì´ë””, `âŒ í‹°ì¼“ ${ì§€ê¸‰í‹°ì¼“}ì¥ ìš°í¸ ì§€ê¸‰ ì‹¤íŒ¨`);
                    } else {
                        await ë¡œê·¸ê¸°ë¡(í˜„ì¬ìœ ì €.ìœ ì €ì•„ì´ë””, `í‹°ì¼“ ${ì§€ê¸‰í‹°ì¼“}ì¥ ìš°í¸ ì§€ê¸‰`);
                    }
                }
            }

            let í«ë‹¨ê³„ = 0;
            if (ëˆ„ì ë°ë¯¸ì§€ì´í•© >= 99_999_999) {
                í«ë‹¨ê³„ = 3;
            } else if (ëˆ„ì ë°ë¯¸ì§€ì´í•© >= 9_999_999) {
                í«ë‹¨ê³„ = 2;
            } else if (ëˆ„ì ë°ë¯¸ì§€ì´í•© >= 999_999) {
                í«ë‹¨ê³„ = 1;
            }

            await supabaseAdmin
                .from("users")
                .update({ í«ë‹¨ê³„ })
                .neq("í«ë‹¨ê³„", í«ë‹¨ê³„);

            await supabaseAdmin
                .from("users")
                .update({ ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€: 0 })
                .neq("ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€", 0); // 0ì´ ì•„ë‹Œ ìœ ì €ë§Œ ì—…ë°ì´íŠ¸ (ë¶ˆí•„ìš”í•œ ì“°ê¸° ë°©ì§€)

            const { data: ëŒ€í‘œìœ ì €, error: ë³´ìŠ¤ì—ëŸ¬ } = await supabaseAdmin
                .from("users")
                .select("ë³´ìŠ¤ë„˜ë²„")
                .not("ë³´ìŠ¤ë„˜ë²„", "is", null)
                .eq("ìœ ì €ì•„ì´ë””", "ê°€ê¸€ì£¼ì¸ì¥")
                .single();

            if (!ëŒ€í‘œìœ ì € || ë³´ìŠ¤ì—ëŸ¬) {
                return res.status(500).json({ ì˜¤ë¥˜: "ë³´ìŠ¤ë„˜ë²„ ì¡°íšŒ ì‹¤íŒ¨" });
            }


            //ë³´ìŠ¤ì¶”ê°€
            const í˜„ì¬ë³´ìŠ¤ë²ˆí˜¸ = ëŒ€í‘œìœ ì €.ë³´ìŠ¤ë„˜ë²„ ?? 0;
            const ë‹¤ìŒë³´ìŠ¤ë²ˆí˜¸ = (í˜„ì¬ë³´ìŠ¤ë²ˆí˜¸ + 1) % 10;

            await supabaseAdmin
                .from("users")
                .update({ ë³´ìŠ¤ë„˜ë²„: ë‹¤ìŒë³´ìŠ¤ë²ˆí˜¸ })
                .neq("ë³´ìŠ¤ë„˜ë²„", ë‹¤ìŒë³´ìŠ¤ë²ˆí˜¸);

        }

    }



    // const { data: ì „ì²´ìœ ì €, error: ìœ ì €ì—ëŸ¬ } = await supabaseAdmin
    //     .from("users")
    //     .select("ìœ ì €UID, ì¥ë¹„ëª©ë¡");

    // if (!ìœ ì €ì—ëŸ¬ && ì „ì²´ìœ ì €) {
    //     for (const ìœ ì € of ì „ì²´ìœ ì €) {
    //         let ë³€ê²½ = false;
    //         const ì¥ë¹„ëª©ë¡ = ìœ ì €.ì¥ë¹„ëª©ë¡ || [];

    //         for (const ì¥ë¹„ of ì¥ë¹„ëª©ë¡) {
    //             if (ì¥ë¹„.ì´ë¦„ === "ë£¨ì‹œí¼ì˜ ì‹¬ì¥" && ì¥ë¹„.ë“±ê¸‰ === "íƒ€ë½") {
    //                 const ê¸°ì¡´ê°•í™” = ì¥ë¹„.ê°•í™” || 0;
    //                 ì¥ë¹„.ê³µê²©ë ¥ = 1200;
    //                 ì¥ë¹„.ìˆ˜ëŸ‰ = (ì¥ë¹„.ìˆ˜ëŸ‰ || 0) + ê¸°ì¡´ê°•í™”;
    //                 ì¥ë¹„.ê°•í™” = 0;
    //                 ë³€ê²½ = true;
    //             }
    //         }

    //         if (ë³€ê²½) {
    //             const ì¥ë¹„ê³µê²©ë ¥ = Math.max(...ì¥ë¹„ëª©ë¡.map(e => e.ê³µê²©ë ¥ || 0));
    //             const ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°({
    //                 ...ìœ ì €,
    //                 ì¥ë¹„ê³µê²©ë ¥
    //             });

    //             await supabaseAdmin
    //                 .from("users")
    //                 .update({
    //                     ì¥ë¹„ëª©ë¡,
    //                     ì¥ë¹„ê³µê²©ë ¥,
    //                     ìµœì¢…ê³µê²©ë ¥
    //                 })
    //                 .eq("ìœ ì €UID", ìœ ì €.ìœ ì €UID);
    //         }
    //     }
    // }


    // const { data: ì‹±ê¸€ìœ ì €, error: ìœ ì €ì—ëŸ¬ } = await supabaseAdmin
    //     .from("users")
    //     .select("ìœ ì €UID, ì¥ë¹„ëª©ë¡")
    //     .eq("ìœ ì €ì•„ì´ë””", "í…ŒìŠ¤íŠ¸ì•„ì´ë””")
    //     .single(); // â¬…ï¸ í•œ ëª…ë§Œ ì¡°íšŒ

    // if (!ìœ ì €ì—ëŸ¬ && ì‹±ê¸€ìœ ì €) {
    //     const ì¥ë¹„ëª©ë¡ = ìœ ì €.ì¥ë¹„ëª©ë¡ || [];
    //     let ë³€ê²½ = false;

    //     for (const ì¥ë¹„ of ì¥ë¹„ëª©ë¡) {
    //         if (ì¥ë¹„.ì´ë¦„ === "ë£¨ì‹œí¼ì˜ ì‹¬ì¥" && ì¥ë¹„.ë“±ê¸‰ === "íƒ€ë½") {
    //             const ê¸°ì¡´ê°•í™” = ì¥ë¹„.ê°•í™” || 0;
    //             ì¥ë¹„.ê³µê²©ë ¥ = 1200;
    //             ì¥ë¹„.ìˆ˜ëŸ‰ = (ì¥ë¹„.ìˆ˜ëŸ‰ || 0) + ê¸°ì¡´ê°•í™”;
    //             ì¥ë¹„.ê°•í™” = 0;
    //             ë³€ê²½ = true;
    //         }
    //     }

    //     if (ë³€ê²½) {
    //         const ì¥ë¹„ê³µê²©ë ¥ = Math.max(...ì¥ë¹„ëª©ë¡.map(e => e.ê³µê²©ë ¥ || 0));
    //         const ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°({
    //             ...ìœ ì €,
    //             ì¥ë¹„ê³µê²©ë ¥
    //         });

    //         await supabaseAdmin
    //             .from("users")
    //             .update({
    //                 ì¥ë¹„ëª©ë¡,
    //                 ì¥ë¹„ê³µê²©ë ¥,
    //                 ìµœì¢…ê³µê²©ë ¥
    //             })
    //             .eq("ìœ ì €UID", ìœ ì €.ìœ ì €UID);
    //     }
    // }


    if ((ìœ ì €.í˜„ì§ˆ ?? 0) >= 1) {
        const now = new Date();
        const kstNow = new Date(
            now.toLocaleString("en-US", { timeZone: "Asia/Seoul" })
        );
        const today = kstNow.toISOString().slice(0, 10);

        if (ìœ ì €.í˜„ì§ˆê¸°í•œì²´í¬ !== today) {
            // 1) í˜„ì§ˆê¸°í•œ 1 ì¦ê°€
            let newí˜„ì§ˆê¸°í•œ = (ìœ ì €.í˜„ì§ˆê¸°í•œ ?? 0) + 1;
            const updates = { í˜„ì§ˆê¸°í•œì²´í¬: today };

            // 2) 31ì¼ ë„ë‹¬ ì‹œ ì´ˆê¸°í™”
            if (newí˜„ì§ˆê¸°í•œ >= 31) {
                const newí˜„ì§ˆ = (ìœ ì €.í˜„ì§ˆ ?? 1) - 1;

                const nextí˜„ì§ˆê¸°í•œ = newí˜„ì§ˆ >= 1 ? 1 : 0;
                const nextí˜„ì§ˆê¸°í•œì²´í¬ = newí˜„ì§ˆ >= 1 ? today : null;
                const nextíŒ”ë ˆíŠ¸ = newí˜„ì§ˆ >= 1 ? (ìœ ì €.ë§ˆë²•ì˜íŒ”ë ˆíŠ¸ ?? null) : null;

                updates.í˜„ì§ˆ = newí˜„ì§ˆ;
                updates.í˜„ì§ˆê¸°í•œ = nextí˜„ì§ˆê¸°í•œ;
                updates.í˜„ì§ˆê¸°í•œì²´í¬ = nextí˜„ì§ˆê¸°í•œì²´í¬;
                updates.ë§ˆë²•ì˜íŒ”ë ˆíŠ¸ = nextíŒ”ë ˆíŠ¸;

                // ë©”ëª¨ë¦¬ ë°˜ì˜
                ìœ ì €.í˜„ì§ˆ = newí˜„ì§ˆ;
                ìœ ì €.í˜„ì§ˆê¸°í•œ = nextí˜„ì§ˆê¸°í•œ;
                ìœ ì €.í˜„ì§ˆê¸°í•œì²´í¬ = nextí˜„ì§ˆê¸°í•œì²´í¬;
                ìœ ì €.ë§ˆë²•ì˜íŒ”ë ˆíŠ¸ = nextíŒ”ë ˆíŠ¸;
            } else {
                // 3) ì¼ë°˜ì ì¸ ë‚ ì§œ ì¦ê°€ë§Œ
                updates.í˜„ì§ˆê¸°í•œ = newí˜„ì§ˆê¸°í•œ;
                ìœ ì €.í˜„ì§ˆê¸°í•œ = newí˜„ì§ˆê¸°í•œ;
            }

            // 4) DB ì—…ë°ì´íŠ¸
            const { error: incErr } = await supabaseAdmin
                .from("users")
                .update(updates)
                .eq("ìœ ì €UID", ìœ ì €UID);
        }

    }


    if ((ìœ ì €.í–„ë²„ê±°í˜„ì§ˆ ?? 0) >= 1) {
        const now = new Date();
        const kstNow = new Date(
            now.toLocaleString("en-US", { timeZone: "Asia/Seoul" })
        );
        const today = kstNow.toISOString().slice(0, 10);

        if (ìœ ì €.í–„ë²„ê±°í˜„ì§ˆê¸°í•œì²´í¬ !== today) {
            // 1) í–„ë²„ê±°í˜„ì§ˆê¸°í•œ 1 ì¦ê°€
            let newí–„ë²„ê±°í˜„ì§ˆê¸°í•œ = (ìœ ì €.í–„ë²„ê±°í˜„ì§ˆê¸°í•œ ?? 0) + 1;
            const updates = { í–„ë²„ê±°í˜„ì§ˆê¸°í•œì²´í¬: today };

            // 2) 31ì¼ì§¸ ë„ë‹¬ ì‹œ ë¦¬ì…‹
            if (newí–„ë²„ê±°í˜„ì§ˆê¸°í•œ >= 31) {
                const newí–„ë²„ê±°í˜„ì§ˆ = (ìœ ì €.í–„ë²„ê±°í˜„ì§ˆ ?? 1) - 1;

                const nextê¸°í•œ = newí–„ë²„ê±°í˜„ì§ˆ >= 1 ? 1 : 0;
                const nextì²´í¬ = newí–„ë²„ê±°í˜„ì§ˆ >= 1 ? today : null;

                updates.í–„ë²„ê±°í˜„ì§ˆ = newí–„ë²„ê±°í˜„ì§ˆ;
                updates.í–„ë²„ê±°í˜„ì§ˆê¸°í•œ = nextê¸°í•œ;
                updates.í–„ë²„ê±°í˜„ì§ˆê¸°í•œì²´í¬ = nextì²´í¬;

                ìœ ì €.í–„ë²„ê±°í˜„ì§ˆ = newí–„ë²„ê±°í˜„ì§ˆ;
                ìœ ì €.í–„ë²„ê±°í˜„ì§ˆê¸°í•œ = nextê¸°í•œ;
                ìœ ì €.í–„ë²„ê±°í˜„ì§ˆê¸°í•œì²´í¬ = nextì²´í¬;

                // âœ… ì¤„ì–´ë“  ê°’ì´ 1 ì´ìƒì´ë©´ í–„ë²„ê±° ìœ ë¬¼ë„ ì§€ê¸‰
                if (newí–„ë²„ê±°í˜„ì§ˆ >= 1) {
                    const newëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡ };
                    const current = Number(newëª©ë¡["í–„ë²„ê±°"] || 0);
                    newëª©ë¡["í–„ë²„ê±°"] = current + 1;
                    updates.ìœ ë¬¼ëª©ë¡ = newëª©ë¡;
                    ìœ ì €.ìœ ë¬¼ëª©ë¡ = newëª©ë¡;
                }

            } else {
                // 3) ì¼ë°˜ì ì¸ ë‚ ì§œ ì¦ê°€ ë° ìœ ë¬¼ ì§€ê¸‰
                updates.í–„ë²„ê±°í˜„ì§ˆê¸°í•œ = newí–„ë²„ê±°í˜„ì§ˆê¸°í•œ;
                ìœ ì €.í–„ë²„ê±°í˜„ì§ˆê¸°í•œ = newí–„ë²„ê±°í˜„ì§ˆê¸°í•œ;

                const newëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡ };
                const current = Number(newëª©ë¡["í–„ë²„ê±°"] || 0);
                newëª©ë¡["í–„ë²„ê±°"] = current + 1;
                updates.ìœ ë¬¼ëª©ë¡ = newëª©ë¡;
                ìœ ì €.ìœ ë¬¼ëª©ë¡ = newëª©ë¡;
            }


            // 4) DB ì—…ë°ì´íŠ¸
            const { error: incErr } = await supabaseAdmin
                .from("users")
                .update(updates)
                .eq("ìœ ì €UID", ìœ ì €UID);

            if (incErr) {
                console.error("í–„ë²„ê±°í˜„ì§ˆê¸°í•œ ì¦ê°€/ì´ˆê¸°í™” ì‹¤íŒ¨:", incErr);
            }
        }
    }


    const kstNow = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
    const ì˜¤ëŠ˜ë‚ ì§œ = kstNow.toISOString().slice(0, 10); // â¬…ï¸ í•œêµ­ ë‚ ì§œ (YYYY-MM-DD)

    const ë§ˆì§€ë§‰ì§€ê¸‰ë‚ ì§œ = ìœ ì €.í•˜ë£¨í•œë²ˆ
        ? new Date(new Date(ìœ ì €.í•˜ë£¨í•œë²ˆ).toLocaleString("en-US", { timeZone: "Asia/Seoul" }))
            .toISOString()
            .slice(0, 10)
        : null;

    if (ë§ˆì§€ë§‰ì§€ê¸‰ë‚ ì§œ !== ì˜¤ëŠ˜ë‚ ì§œ) {
        const ìƒˆë¡œìš´ìœ ë¬¼ëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡ };
        ìƒˆë¡œìš´ìœ ë¬¼ëª©ë¡["ìŠ¤í”¼ì»¤"] = 9;
        // const í˜„ì¬ì—´ì‡  = ìƒˆë¡œìš´ìœ ë¬¼ëª©ë¡["ì—´ì‡ "] || 0;
        // if (í˜„ì¬ì—´ì‡  < 9) {
        //     ìƒˆë¡œìš´ìœ ë¬¼ëª©ë¡["ì—´ì‡ "] = í˜„ì¬ì—´ì‡  + 1;
        // }


        const { error: í•˜ë£¨ì—…ë°ì´íŠ¸ì—ëŸ¬ } = await supabaseAdmin
            .from("users")
            .update({
                ìœ ë¬¼ëª©ë¡: ìƒˆë¡œìš´ìœ ë¬¼ëª©ë¡,
                í•˜ë£¨í•œë²ˆ: kstNow.toISOString()
            })
            .eq("ìœ ì €UID", ìœ ì €UID);

        if (!í•˜ë£¨ì—…ë°ì´íŠ¸ì—ëŸ¬) {
            ìœ ì €.ìœ ë¬¼ëª©ë¡ = ìƒˆë¡œìš´ìœ ë¬¼ëª©ë¡;
            ìœ ì €.í•˜ë£¨í•œë²ˆ = kstNow.toISOString();
        }
    }


    let ìƒˆë¡œê³ ì¹¨í•˜ì = false;

    // âœ… ìŠ¤íƒœë¯¸ë„ˆ íšŒë³µ ì²˜ë¦¬ (ì‹œê°„ ê¸°ë°˜)
    const í˜„ì¬ì •ê°ì‹œê°„ = Math.floor(Date.now() / 1000 / 3600); // ì‹œê°„ ë‹¨ìœ„ ê¸°ì¤€ (ì •ìˆ˜)
    const ì €ì¥ëœì •ê°ì‹œê°„ = ìœ ì €.ìŠ¤íƒœë¯¸ë„ˆê°±ì‹ ì‹œê°„ ?? í˜„ì¬ì •ê°ì‹œê°„;
    const ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ = ìœ ì €.ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ ?? 2000;
    const ì´ì „ìŠ¤íƒœë¯¸ë„ˆ = ìœ ì €.í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ ?? 2000;

    const ê²½ê³¼ì‹œê°„ = í˜„ì¬ì •ê°ì‹œê°„ - ì €ì¥ëœì •ê°ì‹œê°„;
    const íšŒë³µëŸ‰ = ê²½ê³¼ì‹œê°„ * 120;
    const íšŒë³µí›„ìŠ¤íƒœë¯¸ë„ˆ = Math.min(ì´ì „ìŠ¤íƒœë¯¸ë„ˆ + íšŒë³µëŸ‰, ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ);


    ìœ ì €.í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ = íšŒë³µí›„ìŠ¤íƒœë¯¸ë„ˆ;
    ìœ ì €.ìŠ¤íƒœë¯¸ë„ˆê°±ì‹ ì‹œê°„ = í˜„ì¬ì •ê°ì‹œê°„;

    if (íšŒë³µëŸ‰ > 0) {
        ìƒˆë¡œê³ ì¹¨í•˜ì = true;


        const ìœ ì €ì•„ì´ë”” = ìœ ì €.ìœ ì €ì•„ì´ë””;

        function ì‹œê°„ë³€í™˜(ì •ê°ì‹œê°„) {
            const ms = ì •ê°ì‹œê°„ * 3600 * 1000;
            return new Date(ms).toLocaleString("ko-KR", { timeZone: "Asia/Seoul" });
        }

        const í˜„ì¬KST = new Date().toLocaleString("ko-KR", {
            timeZone: "Asia/Seoul",
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
        });

        await ë¡œê·¸ê¸°ë¡(ìœ ì €ì•„ì´ë””,
            `\n` +
            `- ê¸°ì¡´ ì €ì¥ ì‹œê° (KST): ${ì‹œê°„ë³€í™˜(ì €ì¥ëœì •ê°ì‹œê°„)}\n` +
            `- í˜„ì¬ ì ‘ì† ì‹œê° (KST): ${í˜„ì¬KST}\n` +
            `- ê²½ê³¼ ì‹œê°„ (ì‹œê°„): ${ê²½ê³¼ì‹œê°„}\n` +
            `- íšŒë³µëŸ‰: ${íšŒë³µëŸ‰}\n` +
            `- ê¸°ì¡´ í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ: ${ì´ì „ìŠ¤íƒœë¯¸ë„ˆ}\n` +
            `- íšŒë³µ ì ìš© í›„ ìµœì¢… ìŠ¤íƒœë¯¸ë„ˆ: ${íšŒë³µí›„ìŠ¤íƒœë¯¸ë„ˆ}`
        );


    }



    if (ìœ ì €.ìƒˆë¡œê³ ì¹¨ == true) {
        ìƒˆë¡œê³ ì¹¨í•˜ì = true;
        ìœ ì €.ìƒˆë¡œê³ ì¹¨ = false;
    }



    let ì ê²€í•˜ì = false;
    if (ìœ ì €.ì ê²€ == true) {
        ì ê²€í•˜ì = true;
        // ìœ ì €.ì ê²€ = false;
    }





    ìœ ì €.ë²„ì „ì—… = 8;


    const calculatedLevel = Math.floor(ìœ ì €.ê²½í—˜ì¹˜ / 1000) + 1;
    ìœ ì €.ë ˆë²¨ = calculatedLevel;
    ìœ ì €.ë ˆë²¨ê³µê²©ë ¥ = 10 + (calculatedLevel - 1);

    const ì¥ë¹„ëª©ë¡ = ìœ ì €.ì¥ë¹„ëª©ë¡ || [];
    ìœ ì €.ì¥ë¹„ê³µê²©ë ¥ = Math.max(0, ...ì¥ë¹„ëª©ë¡.map(e => e.ê³µê²©ë ¥ || 0));
    ìœ ì €.ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìœ ì €);

    ìœ ì €.ìµœëŒ€ì²´ë ¥ = ìµœëŒ€ì²´ë ¥ê³„ì‚°(ìœ ì €);


    const { error: ì—…ë°ì´íŠ¸ì—ëŸ¬ } = await supabaseAdmin
        .from("users")
        .update({
            ë§ˆë²•ì˜íŒ”ë ˆíŠ¸: ìœ ì €.ë§ˆë²•ì˜íŒ”ë ˆíŠ¸,
            ìƒˆë¡œê³ ì¹¨: ìœ ì €.ìƒˆë¡œê³ ì¹¨,
            ë²„ì „ì—…: ìœ ì €.ë²„ì „ì—…,
            ì ê²€: ìœ ì €.ì ê²€,
            ë ˆë²¨: ìœ ì €.ë ˆë²¨,
            ë ˆë²¨ê³µê²©ë ¥: ìœ ì €.ë ˆë²¨ê³µê²©ë ¥,
            ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥,
            í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ: ìœ ì €.í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ,
            ìŠ¤íƒœë¯¸ë„ˆê°±ì‹ ì‹œê°„: ìœ ì €.ìŠ¤íƒœë¯¸ë„ˆê°±ì‹ ì‹œê°„,
            ìµœëŒ€ì²´ë ¥: ìœ ì €.ìµœëŒ€ì²´ë ¥
        })
        .eq("ìœ ì €UID", ìœ ì €UID);

    if (ì—…ë°ì´íŠ¸ì—ëŸ¬) {
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
    }

    return res.json({ ìœ ì €ë°ì´í„°: { ...ìœ ì € }, ìƒˆë¡œê³ ì¹¨í•˜ì, ì ê²€í•˜ì });
});










app.post("/boss-ranking", async (req, res) => {
    try {
        const { ìœ ì €UID } = req.body;

        // âœ… ëª¨ë“  ìœ ì €ì˜ ëˆ„ì  ë°ë¯¸ì§€ í•©ì‚°
        const { data: ì „ì²´í•©, error: í•©ê³„ì—ëŸ¬ } = await supabaseAdmin
            .from("users")
            .select("ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€");

        if (í•©ê³„ì—ëŸ¬ || !ì „ì²´í•©) {
            return res.status(500).json({ ì˜¤ë¥˜: "ì´í•© ê³„ì‚° ì‹¤íŒ¨" });
        }

        const ëˆ„ì ë°ë¯¸ì§€ì´í•© = ì „ì²´í•©
            .filter(u => u.ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€ > 0)
            .reduce((í•©, u) => í•© + Number(u.ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€), 0);

        // âœ… ìƒìœ„ 10ëª… ì¡°íšŒ
        const { data: ìœ ì €ë“¤, error: ìœ ì €ì—ëŸ¬ } = await supabaseAdmin
            .from("users")
            .select("ìœ ì €ì•„ì´ë””, ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€, ìœ ì €UID, ë§ˆë²•ì˜íŒ”ë ˆíŠ¸")
            .gt("ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€", 0)
            .order("ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€", { ascending: false })

        // ë‚´ ìˆœìœ„ ê³„ì‚°
        const ë‚´ìˆœìœ„ = ìœ ì €ë“¤.findIndex(u => u.ìœ ì €UID === ìœ ì €UID);
        const ë‚´ì •ë³´ = ë‚´ìˆœìœ„ >= 0 ? {
            ìˆœìœ„: ë‚´ìˆœìœ„ + 1,
            ìœ ì €ì•„ì´ë””: ìœ ì €ë“¤[ë‚´ìˆœìœ„].ìœ ì €ì•„ì´ë””,
            ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€: ìœ ì €ë“¤[ë‚´ìˆœìœ„].ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€,
            ë§ˆë²•ì˜íŒ”ë ˆíŠ¸: ìœ ì €ë“¤[ë‚´ìˆœìœ„].ë§ˆë²•ì˜íŒ”ë ˆíŠ¸
        } : null;


        if (ìœ ì €ì—ëŸ¬) {
            return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
        }

        res.json({ ìˆœìœ„: ìœ ì €ë“¤, ëˆ„ì ë°ë¯¸ì§€ì´í•©, ë‚´ì •ë³´ });

    } catch (e) {
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
    }
});


app.post("/attack-boss", async (req, res) => {
    const { ìœ ì €ë°ì´í„°, ë³´ìŠ¤ì´ë¦„ } = req.body;
    const { ìœ ì €UID } = ìœ ì €ë°ì´í„°;
    const ì „íˆ¬ë¡œê·¸ = [];

    if (!ìœ ì €UID) return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });


    const now = new Date();
    const formatter = new Intl.DateTimeFormat("ko-KR", {
        weekday: "short",
        timeZone: "Asia/Seoul"
    });
    const parts = formatter.formatToParts(now);
    const ìš”ì¼ = parts.find(p => p.type === "weekday")?.value;

    if (ìš”ì¼ === "í† ") {
        return res.status(403).json({ ì˜¤ë¥˜: "ë³´ìŠ¤ê°€ ì ì  ë©€ì–´ì§‘ë‹ˆë‹¤" });
    }
    if (ìš”ì¼ === "ì¼") {
        return res.status(403).json({ ì˜¤ë¥˜: "ìƒˆë¡œìš´ ë³´ìŠ¤ì˜ ê°•ë¦¼ìœ¼ë¡œ ëŒ€ì§€ê°€ ê°ˆë¼ì§€ëŠ” ì¤‘ì…ë‹ˆë‹¤" });
    }

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });

    let í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ = ìœ ì €.í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ ?? 0;
    if (í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ < 10) {
        return res.json({ ê²°ê³¼: "ë¶ˆê°€", ë©”ì‹œì§€: "ìŠ¤íƒœë¯¸ë„ˆ ë¶€ì¡±" });
    }

    const ì•”í¬ë¼ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ì•”í¬ë¼"] || 0;
    const ë°œë™í™•ë¥  = ì•”í¬ë¼ * 0.01;

    const ìŠ¤íƒœë¯¸ë„ˆê°ì†ŒëŸ‰ = Math.random() < ë°œë™í™•ë¥  ? 5 : 10;
    í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ -= ìŠ¤íƒœë¯¸ë„ˆê°ì†ŒëŸ‰;

    ìœ ì €.ìŠ¤íƒœë¯¸ë„ˆì†Œëª¨ì´ëŸ‰ = (ìœ ì €.ìŠ¤íƒœë¯¸ë„ˆì†Œëª¨ì´ëŸ‰ || 0) + ìŠ¤íƒœë¯¸ë„ˆê°ì†ŒëŸ‰;

    ìœ ì €.ë‚¨ì€ì²´ë ¥ = ìœ ì €.ìµœëŒ€ì²´ë ¥;
    let í˜„ì¬í„´ = 1;

    const ë³´ìŠ¤ = {
        ì´ë¦„: ë³´ìŠ¤ì´ë¦„ || "BOSS",
        ì²´ë ¥: 9999999,
        ë°©ì–´ë ¥: Math.floor(ìœ ì €.ìµœì¢…ê³µê²©ë ¥ * 0.9),
        // ë°©ì–´ë ¥: 0,
    };

    const ì „íˆ¬ê²°ê³¼ = ì „íˆ¬ì‹œë®¬ë ˆì´ì…˜(ìœ ì €, ë³´ìŠ¤, ì „íˆ¬ë¡œê·¸, í˜„ì¬í„´, true); // ë³´ìŠ¤ì „: true

    ìœ ì €.ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€ += ì „íˆ¬ê²°ê³¼.ëˆ„ì ë°ë¯¸ì§€;
    ìœ ì €.ë‚¨ì€ì²´ë ¥ = ìœ ì €.ìµœëŒ€ì²´ë ¥;

    await supabaseAdmin.from("users").update({
        í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ,
        ë‚¨ì€ì²´ë ¥: ìœ ì €.ìµœëŒ€ì²´ë ¥,
        ìŠ¤íƒœë¯¸ë„ˆì†Œëª¨ì´ëŸ‰: ìœ ì €.ìŠ¤íƒœë¯¸ë„ˆì†Œëª¨ì´ëŸ‰,
        ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€: ìœ ì €.ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€
    }).eq("ìœ ì €UID", ìœ ì €UID);

    return res.json({
        ê²°ê³¼: "ì™„ë£Œ",
        ëˆ„ì ë°ë¯¸ì§€: ì „íˆ¬ê²°ê³¼.ëˆ„ì ë°ë¯¸ì§€,
        ìœ ì €ë°ì´í„°: {
            ...ìœ ì €,
            í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ,
            ë‚¨ì€ì²´ë ¥: ìœ ì €.ìµœëŒ€ì²´ë ¥,
            ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€: ìœ ì €.ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€
        },
        ì „íˆ¬ë¡œê·¸
    });
});

app.post("/attack-normal", async (req, res) => {
    const { ìœ ì €ë°ì´í„° } = req.body;
    const { ìœ ì €UID, í˜„ì¬ì¸µ: í´ë¼ì´ì–¸íŠ¸ì¸µ } = ìœ ì €ë°ì´í„°;
    const ì „íˆ¬ë¡œê·¸ = [];
    if (!ìœ ì €UID) return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });

    const { data: ìœ ì € } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    let í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ = ìœ ì €.í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ ?? 1000;
    if (í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ <= 0) {
        return res.json({ ê²°ê³¼: "ë¶ˆê°€", ë©”ì‹œì§€: "ìŠ¤íƒœë¯¸ë„ˆê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤." });
    }

    const ëª¨ë˜ì‹œê³„ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ëª¨ë˜ì‹œê³„"] || 0;
    const í™•ë¥  = ëª¨ë˜ì‹œê³„ê°œìˆ˜ * 0.001;
    const ëª¨ë˜ì‹œê³„ë°œë™ = Math.random() <= í™•ë¥ ;

    if (!ëª¨ë˜ì‹œê³„ë°œë™) {
        í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ--;
    }

    ìœ ì €.ìŠ¤íƒœë¯¸ë„ˆì†Œëª¨ì´ëŸ‰++;

    const ëª¬ìŠ¤í„° = ì¼ë°˜ì•…ë§ˆë¶ˆëŸ¬ì˜¤ê¸°(í´ë¼ì´ì–¸íŠ¸ì¸µ || 1);

    const íšŒë³µì „ì²´ë ¥ = ìœ ì €.ë‚¨ì€ì²´ë ¥;
    const ì¶”ê°€íšŒë³µ = ì•„ì´ì–¸ë°”ë””íšŒë³µ(ìœ ì €);
    let í˜„ì¬í„´ = 0;

    if (ì¶”ê°€íšŒë³µ > 0) {
        ìœ ì €.ë‚¨ì€ì²´ë ¥ = Math.min(ìœ ì €.ìµœëŒ€ì²´ë ¥, íšŒë³µì „ì²´ë ¥ + ì¶”ê°€íšŒë³µ);

        ì „íˆ¬ë¡œê·¸.push({
            í„´: í˜„ì¬í„´,
            íƒ€ì…: "íšŒë³µ",  // íšŒë³µ íƒ€ì… ì¶”ê°€
            ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
            ìœ ì €ê³µê²©ë ¥: ìœ ì €.ê³µê²©ë ¥,
            ìœ ì €ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥,
            ìœ ì €ì²´ë ¥: ìœ ì €.ë‚¨ì€ì²´ë ¥,
            ìœ ì €ìµœëŒ€ì²´ë ¥: ìœ ì €.ìµœëŒ€ì²´ë ¥,
            ëª¬ìŠ¤í„°ì´ë¦„: ëª¬ìŠ¤í„°.ì´ë¦„,
            ëª¬ìŠ¤í„°ì²´ë ¥: ëª¬ìŠ¤í„°.ì²´ë ¥,
            ëª¬ìŠ¤í„°ìµœëŒ€ì²´ë ¥: ëª¬ìŠ¤í„°.ì²´ë ¥,
            ëª¬ìŠ¤í„°ë°©ì–´ë ¥: ëª¬ìŠ¤í„°.ë°©ì–´ë ¥,
            ì•„ì´ì½˜: ["ì•„ì´ì–¸ë°”ë””ì•„ì´ì½˜"],  // íšŒë³µ ìŠ¤í‚¬ ì•„ì´ì½˜
            íš¨ê³¼: `${ì¶”ê°€íšŒë³µ}`,  // "ì²´ë ¥ íšŒë³µ"ë§Œ í‘œì‹œ
        });
    }
    í˜„ì¬í„´++;

    const ì „íˆ¬ = ì „íˆ¬ì‹œë®¬ë ˆì´ì…˜(ìœ ì €, ëª¬ìŠ¤í„°, ì „íˆ¬ë¡œê·¸, í˜„ì¬í„´);

    if (ì „íˆ¬.ê²°ê³¼ === "íŒ¨ë°°") {
        const ìœ ì €ë³µêµ¬ = {
            ...ìœ ì €,
            ë‚¨ì€ì²´ë ¥: ìœ ì €.ìµœëŒ€ì²´ë ¥,
            í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ
        };

        await supabaseAdmin.from("users").update({
            ë‚¨ì€ì²´ë ¥: ìœ ì €ë³µêµ¬.ë‚¨ì€ì²´ë ¥,
            í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ,
            í˜„ì¬ì¸µ: í´ë¼ì´ì–¸íŠ¸ì¸µ,
        }).eq("ìœ ì €UID", ìœ ì €UID);

        return res.json({
            ê²°ê³¼: "íŒ¨ë°°",
            ëª¬ìŠ¤í„°,
            ìœ ì €ë‚¨ì€ì²´ë ¥: ì „íˆ¬.ìœ ì €ë‚¨ì€ì²´ë ¥,
            ìœ ì €ë°ì´í„°: ìœ ì €ë³µêµ¬,
            ì „íˆ¬ë¡œê·¸,
            ëª¨ë˜ì‹œê³„ë°œë™
        });
    }

    const ë³´ìƒ = ë³´ìƒê³„ì‚°(í´ë¼ì´ì–¸íŠ¸ì¸µ, ìœ ì €, ëª¬ìŠ¤í„°);
    ë³´ìƒ.ìˆ™ë ¨ë„ += ì¸ì‚¬ì´íŠ¸ì¶”ê°€ìˆ™ë ¨ë„(ìœ ì €);
    ë³´ìƒ.ê²½í—˜ì¹˜ = Math.floor(ë³´ìƒ.ê²½í—˜ì¹˜ * ì¸í…”ë¦¬ì „ìŠ¤ì¶”ê°€ê²½í—˜ì¹˜ë°°ìœ¨(ìœ ì €));
    ë³´ìƒ.ê³¨ë“œ = Math.floor(ë³´ìƒ.ê³¨ë“œ * íšë“ê¸ˆí™”ë°œêµ´(ìœ ì €));

    const ì¸ì‚¬ì´íŠ¸ë°œë™ = ì¸ì‚¬ì´íŠ¸ì¶”ê°€ìˆ™ë ¨ë„(ìœ ì €) > 0;
    const ì¸í…”ë¦¬ì „ìŠ¤ë°œë™ = ì¸í…”ë¦¬ì „ìŠ¤ì¶”ê°€ê²½í—˜ì¹˜ë°°ìœ¨(ìœ ì €) > 1;
    const ë°œêµ´ë°œë™ = íšë“ê¸ˆí™”ë°œêµ´(ìœ ì €) > 1;

    const ë ˆë²¨ì—… = ë ˆë²¨ì—…íŒì •(ìœ ì €.ê²½í—˜ì¹˜ + ë³´ìƒ.ê²½í—˜ì¹˜, ìœ ì €.ë ˆë²¨);
    const ë“œë ˆì¸ = ë“œë ˆì¸íšŒë³µ(ìœ ì €);

    if (ë“œë ˆì¸ > 0) {
        ì „íˆ¬ë¡œê·¸.push({
            í„´: "ì¢…ë£Œ", // ë§ˆì§€ë§‰ ì „íˆ¬ í„´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            íƒ€ì…: "íšŒë³µ",
            ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
            ìœ ì €ê³µê²©ë ¥: ìœ ì €.ê³µê²©ë ¥,
            ìœ ì €ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥,
            ìœ ì €ì²´ë ¥: Math.min(ìœ ì €.ìµœëŒ€ì²´ë ¥, ì „íˆ¬.ìœ ì €ë‚¨ì€ì²´ë ¥ + ë“œë ˆì¸),
            ìœ ì €ìµœëŒ€ì²´ë ¥: ìœ ì €.ìµœëŒ€ì²´ë ¥,
            ëª¬ìŠ¤í„°ì´ë¦„: ëª¬ìŠ¤í„°.ì´ë¦„,
            ëª¬ìŠ¤í„°ì²´ë ¥: ì „íˆ¬.ëª¬ìŠ¤í„°ë‚¨ì€ì²´ë ¥,
            ëª¬ìŠ¤í„°ìµœëŒ€ì²´ë ¥: ëª¬ìŠ¤í„°.ì²´ë ¥,
            ëª¬ìŠ¤í„°ë°©ì–´ë ¥: ëª¬ìŠ¤í„°.ë°©ì–´ë ¥,
            ì•„ì´ì½˜: ["ë“œë ˆì¸ì•„ì´ì½˜"],  // ë“œë ˆì¸ ì•„ì´ì½˜ í‘œì‹œ
            íš¨ê³¼: `${ë“œë ˆì¸}`  // íšŒë³µëŸ‰
        });
    }

    const ìƒˆìœ ì € = ì „íˆ¬ë³´ìƒë°˜ì˜(ìœ ì €, ë³´ìƒ, ë“œë ˆì¸, ë ˆë²¨ì—…, ì „íˆ¬.ìœ ì €ë‚¨ì€ì²´ë ¥);
    ìƒˆìœ ì €.í˜„ì¬ì¸µ = í´ë¼ì´ì–¸íŠ¸ì¸µ;

    const ë“œëìœ ë¬¼ = ìœ ë¬¼ë“œëíŒì •(ëª¬ìŠ¤í„°, ìœ ì €);
    if (ë“œëìœ ë¬¼) {
        ìƒˆìœ ì €.ìœ ë¬¼ëª©ë¡ = ìƒˆìœ ì €.ìœ ë¬¼ëª©ë¡ || {};
        ìƒˆìœ ì €.ìœ ë¬¼ëª©ë¡[ë“œëìœ ë¬¼] = (ìƒˆìœ ì €.ìœ ë¬¼ëª©ë¡[ë“œëìœ ë¬¼] || 0) + 1;
        // await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `${ë“œëìœ ë¬¼} ë“œë`);

    }

    const ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìƒˆìœ ì €);
    ìƒˆìœ ì €.ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥;
    const ìµœëŒ€ì²´ë ¥ = ìµœëŒ€ì²´ë ¥ê³„ì‚°(ìƒˆìœ ì €);
    ìƒˆìœ ì €.ìµœëŒ€ì²´ë ¥ = ìµœëŒ€ì²´ë ¥;

    let ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„ = ë ˆì–´ëª¬ìŠ¤í„°ë“±ì¥íŒì •(ìœ ì €);

    if (ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„) {
        // await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `'${ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„}' ì¡°ìš°`);

        if (í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ === 0) {
            í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ++;
        }
    }



    let ìƒˆë¡œê³ ì¹¨í•˜ì = false;
    if (ìœ ì €.ìƒˆë¡œê³ ì¹¨ == true) {
        ìƒˆë¡œê³ ì¹¨í•˜ì = true;
        ìœ ì €.ìƒˆë¡œê³ ì¹¨ = false;
    }

    let ì ê²€í•˜ì = false;
    if (ìœ ì €.ì ê²€ == true) {
        ì ê²€í•˜ì = true;
        // ìœ ì €.ì ê²€ = false;
    }



    await supabaseAdmin.from("users").update({
        ë ˆë²¨: ìƒˆìœ ì €.ë ˆë²¨,
        ë ˆë²¨ê³µê²©ë ¥: ìƒˆìœ ì €.ë ˆë²¨ê³µê²©ë ¥,
        ìµœì¢…ê³µê²©ë ¥: ìµœì¢…ê³µê²©ë ¥,
        ê²½í—˜ì¹˜: ìƒˆìœ ì €.ê²½í—˜ì¹˜,
        ê³¨ë“œ: ìƒˆìœ ì €.ê³¨ë“œ,
        ìµœëŒ€ì²´ë ¥: ìƒˆìœ ì €.ìµœëŒ€ì²´ë ¥,
        ë‚¨ì€ì²´ë ¥: ìƒˆìœ ì €.ë‚¨ì€ì²´ë ¥,
        ìˆ™ë ¨ë„: ìƒˆìœ ì €.ìˆ™ë ¨ë„,
        í˜„ì¬ì¸µ: ìƒˆìœ ì €.í˜„ì¬ì¸µ,
        ìŠ¤í‚¬: ìƒˆìœ ì €.ìŠ¤í‚¬,
        ìœ ë¬¼ëª©ë¡: ìƒˆìœ ì €.ìœ ë¬¼ëª©ë¡,
        í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ,
        ìŠ¤íƒœë¯¸ë„ˆì†Œëª¨ì´ëŸ‰: ìœ ì €.ìŠ¤íƒœë¯¸ë„ˆì†Œëª¨ì´ëŸ‰,
        ìƒˆë¡œê³ ì¹¨: ìœ ì €.ìƒˆë¡œê³ ì¹¨,
        ì ê²€: ìœ ì €.ì ê²€

    }).eq("ìœ ì €UID", ìƒˆìœ ì €.ìœ ì €UID);


    return res.json({
        ê²°ê³¼: "ìŠ¹ë¦¬",
        ëª¬ìŠ¤í„°,
        ìœ ì €ë‚¨ì€ì²´ë ¥: ìƒˆìœ ì €.ë‚¨ì€ì²´ë ¥,
        ë³´ìƒ,
        ë ˆë²¨ì—…,
        íšŒë³µ: ë“œë ˆì¸,
        ì¶”ê°€ê²½í—˜ì¹˜: ë³´ìƒ.ì¶”ê°€ê²½í—˜ì¹˜ || 0,
        ì¶”ê°€ê³¨ë“œ: ë³´ìƒ.ì¶”ê°€ê³¨ë“œ || 0,
        ì¶”ê°€ìˆ™ë ¨ë„: ë³´ìƒ.ì¶”ê°€ìˆ™ë ¨ë„ || 0,
        ìœ ì €ë°ì´í„°: {
            ...ìƒˆìœ ì €,
            í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ
        },
        ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„,
        ì „íˆ¬ë¡œê·¸,
        ë“œëìœ ë¬¼,
        ìŠ¤í‚¬ë°œë™: {
            ì¸ì‚¬ì´íŠ¸: ì¸ì‚¬ì´íŠ¸ë°œë™,   // true/false
            ì¸í…”ë¦¬ì „ìŠ¤: ì¸í…”ë¦¬ì „ìŠ¤ë°œë™, // true/false
            ë°œêµ´: ë°œêµ´ë°œë™              // true/false
        },
        ëª¨ë˜ì‹œê³„ë°œë™,
        ìƒˆë¡œê³ ì¹¨í•˜ì,
        ì ê²€í•˜ì
    });
});

app.post("/attack-rare", async (req, res) => {
    const { ìœ ì €ë°ì´í„°, ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„ } = req.body;
    const { ìœ ì €UID, í˜„ì¬ì¸µ: í´ë¼ì´ì–¸íŠ¸ì¸µ } = ìœ ì €ë°ì´í„°;
    const ì „íˆ¬ë¡œê·¸ = [];

    if (!ìœ ì €UID || !ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„) {
        return res.status(400).json({ ì˜¤ë¥˜: "ì…ë ¥ê°’ ëˆ„ë½" });
    }

    const { data: ìœ ì € } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    let í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ = ìœ ì €.í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ ?? 1000;
    if (í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ <= 0) {
        return res.json({ ê²°ê³¼: "ë¶ˆê°€", ë©”ì‹œì§€: "âš ï¸ ìŠ¤íƒœë¯¸ë„ˆê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤." });
    }

    const ëª¨ë˜ì‹œê³„ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ëª¨ë˜ì‹œê³„"] || 0;
    const í™•ë¥  = ëª¨ë˜ì‹œê³„ê°œìˆ˜ * 0.001;
    const ëª¨ë˜ì‹œê³„ë°œë™ = Math.random() <= í™•ë¥ ;

    if (!ëª¨ë˜ì‹œê³„ë°œë™) {
        í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ--;
    }

    ìœ ì €.ìŠ¤íƒœë¯¸ë„ˆì†Œëª¨ì´ëŸ‰++;

    const ëª¬ìŠ¤í„° = ë ˆì–´ì•…ë§ˆë¶ˆëŸ¬ì˜¤ê¸°(í´ë¼ì´ì–¸íŠ¸ì¸µ || 1, ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„);

    const íƒ€ì… = ëª¬ìŠ¤í„°.íƒ€ì… || "";

    const íšŒë³µì „ì²´ë ¥ = ìœ ì €.ë‚¨ì€ì²´ë ¥;
    const ì¶”ê°€íšŒë³µ = ì•„ì´ì–¸ë°”ë””íšŒë³µ(ìœ ì €);
    let í˜„ì¬í„´ = 0;

    if (ì¶”ê°€íšŒë³µ > 0) {
        ìœ ì €.ë‚¨ì€ì²´ë ¥ = Math.min(ìœ ì €.ìµœëŒ€ì²´ë ¥, íšŒë³µì „ì²´ë ¥ + ì¶”ê°€íšŒë³µ);

        ì „íˆ¬ë¡œê·¸.push({
            í„´: í˜„ì¬í„´,
            íƒ€ì…: "íšŒë³µ",  // íšŒë³µ íƒ€ì… ì¶”ê°€
            ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
            ìœ ì €ê³µê²©ë ¥: ìœ ì €.ê³µê²©ë ¥,
            ìœ ì €ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥,
            ìœ ì €ì²´ë ¥: ìœ ì €.ë‚¨ì€ì²´ë ¥,
            ìœ ì €ìµœëŒ€ì²´ë ¥: ìœ ì €.ìµœëŒ€ì²´ë ¥,
            ëª¬ìŠ¤í„°ì´ë¦„: ëª¬ìŠ¤í„°.ì´ë¦„,
            ëª¬ìŠ¤í„°ì²´ë ¥: ëª¬ìŠ¤í„°.ì²´ë ¥,
            ëª¬ìŠ¤í„°ìµœëŒ€ì²´ë ¥: ëª¬ìŠ¤í„°.ì²´ë ¥,
            ëª¬ìŠ¤í„°ë°©ì–´ë ¥: ëª¬ìŠ¤í„°.ë°©ì–´ë ¥,
            ì•„ì´ì½˜: ["ì•„ì´ì–¸ë°”ë””ì•„ì´ì½˜"],  // íšŒë³µ ìŠ¤í‚¬ ì•„ì´ì½˜
            íš¨ê³¼: `${ì¶”ê°€íšŒë³µ}`,  // "ì²´ë ¥ íšŒë³µ"ë§Œ í‘œì‹œ
        });
    }
    í˜„ì¬í„´++;

    const ì „íˆ¬ = ì „íˆ¬ì‹œë®¬ë ˆì´ì…˜(ìœ ì €, ëª¬ìŠ¤í„°, ì „íˆ¬ë¡œê·¸, í˜„ì¬í„´);

    if (ì „íˆ¬.ê²°ê³¼ === "íŒ¨ë°°") {
        const ìœ ì €ë³µêµ¬ = {
            ...ìœ ì €,
            ë‚¨ì€ì²´ë ¥: ìœ ì €.ìµœëŒ€ì²´ë ¥,
            í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ
        };

        // await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `${ëª¬ìŠ¤í„°.ì´ë¦„}ì—ê²Œ íŒ¨ë°°`);

        await supabaseAdmin.from("users").update({
            ë‚¨ì€ì²´ë ¥: ìœ ì €ë³µêµ¬.ë‚¨ì€ì²´ë ¥,
            í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ,
            í˜„ì¬ì¸µ: í´ë¼ì´ì–¸íŠ¸ì¸µ,
        }).eq("ìœ ì €UID", ìœ ì €UID);

        return res.json({
            ê²°ê³¼: "íŒ¨ë°°",
            ëª¬ìŠ¤í„°,
            ìœ ì €ë‚¨ì€ì²´ë ¥: ì „íˆ¬.ìœ ì €ë‚¨ì€ì²´ë ¥,
            ìœ ì €ë°ì´í„°: ìœ ì €ë³µêµ¬,
            ì „íˆ¬ë¡œê·¸,
            ëª¨ë˜ì‹œê³„ë°œë™
        });
    }

    // âœ… ë³´ìƒ ê³„ì‚°
    const ë³´ìƒ = ë³´ìƒê³„ì‚°(í´ë¼ì´ì–¸íŠ¸ì¸µ, ìœ ì €, ëª¬ìŠ¤í„°);
    ë³´ìƒ.ê²½í—˜ì¹˜ += Math.floor(ë³´ìƒ.ê²½í—˜ì¹˜ * ì¸í…”ë¦¬ì „ìŠ¤ì¶”ê°€ê²½í—˜ì¹˜ë°°ìœ¨(ìœ ì €));
    ë³´ìƒ.ê³¨ë“œ = Math.floor(ë³´ìƒ.ê³¨ë“œ * íšë“ê¸ˆí™”ë°œêµ´(ìœ ì €));
    ë³´ìƒ.ìˆ™ë ¨ë„ += ì¸ì‚¬ì´íŠ¸ì¶”ê°€ìˆ™ë ¨ë„(ìœ ì €);

    let ì¶”ê°€ê²½í—˜ì¹˜ = 0;
    let ì¶”ê°€ê³¨ë“œ = 0;
    let ì¶”ê°€ìˆ™ë ¨ë„ = 0;

    if (ëª¬ìŠ¤í„°.íƒ€ì… === "ê²½í—˜") {
        ì¶”ê°€ê²½í—˜ì¹˜ = ë³´ìƒ.ê²½í—˜ì¹˜ * 19;
        ë³´ìƒ.ê²½í—˜ì¹˜ *= 20;
    }

    if (ëª¬ìŠ¤í„°.íƒ€ì… === "í™©ê¸ˆ") {
        ì¶”ê°€ê³¨ë“œ = ë³´ìƒ.ê³¨ë“œ * 19;
        ë³´ìƒ.ê³¨ë“œ *= 20;
    }

    if (ëª¬ìŠ¤í„°.íƒ€ì… === "ê³„ì‹œ") {
        ì¶”ê°€ìˆ™ë ¨ë„ = ë³´ìƒ.ìˆ™ë ¨ë„ * 19;
        ë³´ìƒ.ìˆ™ë ¨ë„ *= 20;
    }



    const ì¸ì‚¬ì´íŠ¸ë°œë™ = ì¸ì‚¬ì´íŠ¸ì¶”ê°€ìˆ™ë ¨ë„(ìœ ì €) > 0;
    const ì¸í…”ë¦¬ì „ìŠ¤ë°œë™ = ì¸í…”ë¦¬ì „ìŠ¤ì¶”ê°€ê²½í—˜ì¹˜ë°°ìœ¨(ìœ ì €) > 1;
    const ë°œêµ´ë°œë™ = íšë“ê¸ˆí™”ë°œêµ´(ìœ ì €) > 1;

    const ë ˆë²¨ì—… = ë ˆë²¨ì—…íŒì •(ìœ ì €.ê²½í—˜ì¹˜ + ë³´ìƒ.ê²½í—˜ì¹˜, ìœ ì €.ë ˆë²¨);
    const ë“œë ˆì¸ = ë“œë ˆì¸íšŒë³µ(ìœ ì €);

    if (ë“œë ˆì¸ > 0) {
        ì „íˆ¬ë¡œê·¸.push({
            í„´: í˜„ì¬í„´, // ë§ˆì§€ë§‰ ì „íˆ¬ í„´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            íƒ€ì…: "íšŒë³µ",
            ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
            ìœ ì €ê³µê²©ë ¥: ìœ ì €.ê³µê²©ë ¥,
            ìœ ì €ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥,
            ìœ ì €ì²´ë ¥: Math.min(ìœ ì €.ìµœëŒ€ì²´ë ¥, ì „íˆ¬.ìœ ì €ë‚¨ì€ì²´ë ¥ + ë“œë ˆì¸),
            ìœ ì €ìµœëŒ€ì²´ë ¥: ìœ ì €.ìµœëŒ€ì²´ë ¥,
            ëª¬ìŠ¤í„°ì´ë¦„: ëª¬ìŠ¤í„°.ì´ë¦„,
            ëª¬ìŠ¤í„°ì²´ë ¥: ì „íˆ¬.ëª¬ìŠ¤í„°ë‚¨ì€ì²´ë ¥,
            ëª¬ìŠ¤í„°ìµœëŒ€ì²´ë ¥: ëª¬ìŠ¤í„°.ì²´ë ¥,
            ëª¬ìŠ¤í„°ë°©ì–´ë ¥: ëª¬ìŠ¤í„°.ë°©ì–´ë ¥,
            ì•„ì´ì½˜: ["ë“œë ˆì¸ì•„ì´ì½˜"],  // ë“œë ˆì¸ ì•„ì´ì½˜ í‘œì‹œ
            íš¨ê³¼: `${ë“œë ˆì¸}`  // íšŒë³µëŸ‰
        });
    }

    const ìƒˆìœ ì € = ì „íˆ¬ë³´ìƒë°˜ì˜(ìœ ì €, ë³´ìƒ, ë“œë ˆì¸, ë ˆë²¨ì—…, ì „íˆ¬.ìœ ì €ë‚¨ì€ì²´ë ¥);
    ìƒˆìœ ì €.í˜„ì¬ì¸µ = í´ë¼ì´ì–¸íŠ¸ì¸µ;

    // âœ… ë“œë ì¥ë¹„ íŒì •
    const ë“œëì¥ë¹„ = ì¥ë¹„ë“œëíŒì •(ëª¬ìŠ¤í„°, ìœ ì €);
    if (ë“œëì¥ë¹„) {
        ìƒˆìœ ì €.ì¥ë¹„ëª©ë¡ = ìƒˆìœ ì €.ì¥ë¹„ëª©ë¡ || [];
        const í‚¤ = `${ë“œëì¥ë¹„.ì´ë¦„}|${ë“œëì¥ë¹„.ë“±ê¸‰}`;
        const ê¸°ì¡´ = ìƒˆìœ ì €.ì¥ë¹„ëª©ë¡.find(j => j.ì´ë¦„ === ë“œëì¥ë¹„.ì´ë¦„ && j.ë“±ê¸‰ === ë“œëì¥ë¹„.ë“±ê¸‰);

        // await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `${ë“œëì¥ë¹„.ì´ë¦„} ë“œë`);

        if (ê¸°ì¡´) {
            ê¸°ì¡´.ìˆ˜ëŸ‰++;
        } else {
            ìƒˆìœ ì €.ì¥ë¹„ëª©ë¡.push(ë“œëì¥ë¹„);
        }

        if (ë“œëì¥ë¹„.ë“±ê¸‰ === "íƒœì´ˆ" || ë“œëì¥ë¹„.ë“±ê¸‰ === "íƒ€ë½") {
            const ë¬¸êµ¬ = `${ë“œëì¥ë¹„.ì´ë¦„}(ì„)ë¥¼ ë“œëí–ˆë‹¤!`;
            await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
                ìœ ì €UID: ìœ ì €.ìœ ì €UID,
                ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
                ë¬¸êµ¬
            });
        }

    }




    const ì¥ë¹„ëª©ë¡ = ìƒˆìœ ì €.ì¥ë¹„ëª©ë¡ || [];
    const maxê³µê²©ë ¥ = Math.max(...ì¥ë¹„ëª©ë¡.map(e => e.ê³µê²©ë ¥));
    ìœ ì €.ì¥ë¹„ê³µê²©ë ¥ = maxê³µê²©ë ¥;



    const ë“œëìœ ë¬¼ = ìœ ë¬¼ë“œëíŒì •(ëª¬ìŠ¤í„°, ìœ ì €);
    if (ë“œëìœ ë¬¼) {
        ìƒˆìœ ì €.ìœ ë¬¼ëª©ë¡ = ìƒˆìœ ì €.ìœ ë¬¼ëª©ë¡ || {};
        ìƒˆìœ ì €.ìœ ë¬¼ëª©ë¡[ë“œëìœ ë¬¼] = (ìƒˆìœ ì €.ìœ ë¬¼ëª©ë¡[ë“œëìœ ë¬¼] || 0) + 1;
        // await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `'${ë“œëìœ ë¬¼}' ë“œë`);

    }

    const ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìƒˆìœ ì €);
    ìƒˆìœ ì €.ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥;
    const ìµœëŒ€ì²´ë ¥ = ìµœëŒ€ì²´ë ¥ê³„ì‚°(ìƒˆìœ ì €);
    ìƒˆìœ ì €.ìµœëŒ€ì²´ë ¥ = ìµœëŒ€ì²´ë ¥;

    let ìƒˆë¡œìš´ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„ = ë ˆì–´ëª¬ìŠ¤í„°ë“±ì¥íŒì •(ìœ ì €);


    if (ìƒˆë¡œìš´ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„) {
        // await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `'${ìƒˆë¡œìš´ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„}' ì¡°ìš°`);

        if (í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ === 0) {
            í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ++;
        }
    }




    await supabaseAdmin.from("users").update({
        ë ˆë²¨: ìƒˆìœ ì €.ë ˆë²¨,
        ë ˆë²¨ê³µê²©ë ¥: ìƒˆìœ ì €.ë ˆë²¨ê³µê²©ë ¥,
        ì¥ë¹„ê³µê²©ë ¥: ìƒˆìœ ì €.ì¥ë¹„ê³µê²©ë ¥,
        ìµœì¢…ê³µê²©ë ¥: ìµœì¢…ê³µê²©ë ¥,
        ê²½í—˜ì¹˜: ìƒˆìœ ì €.ê²½í—˜ì¹˜,
        ê³¨ë“œ: ìƒˆìœ ì €.ê³¨ë“œ,
        ìˆ™ë ¨ë„: ìƒˆìœ ì €.ìˆ™ë ¨ë„,
        ìµœëŒ€ì²´ë ¥: ìµœëŒ€ì²´ë ¥,
        ë‚¨ì€ì²´ë ¥: ìƒˆìœ ì €.ë‚¨ì€ì²´ë ¥,
        í˜„ì¬ì¸µ: ìƒˆìœ ì €.í˜„ì¬ì¸µ,
        ìŠ¤í‚¬: ìƒˆìœ ì €.ìŠ¤í‚¬,
        ì¥ë¹„ëª©ë¡: ìƒˆìœ ì €.ì¥ë¹„ëª©ë¡,
        ìœ ë¬¼ëª©ë¡: ìƒˆìœ ì €.ìœ ë¬¼ëª©ë¡,
        í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ,
        ìŠ¤íƒœë¯¸ë„ˆì†Œëª¨ì´ëŸ‰: ìœ ì €.ìŠ¤íƒœë¯¸ë„ˆì†Œëª¨ì´ëŸ‰,
    }).eq("ìœ ì €UID", ìœ ì €UID);


    return res.json({
        ê²°ê³¼: "ìŠ¹ë¦¬",
        ëª¬ìŠ¤í„°,
        ìœ ì €ë‚¨ì€ì²´ë ¥: ìƒˆìœ ì €.ë‚¨ì€ì²´ë ¥,
        ë³´ìƒ,
        ë ˆë²¨ì—…,
        íšŒë³µ: ë“œë ˆì¸,
        ë“œëì¥ë¹„,
        ì¶”ê°€ê²½í—˜ì¹˜,
        ì¶”ê°€ê³¨ë“œ,
        ì¶”ê°€ìˆ™ë ¨ë„,
        ìœ ì €ë°ì´í„°: {
            ...ìƒˆìœ ì €,
            í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ
        },
        ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„: ìƒˆë¡œìš´ë ˆì–´ëª¬ìŠ¤í„°ì´ë¦„,
        ì „íˆ¬ë¡œê·¸,
        ë“œëìœ ë¬¼,
        ìŠ¤í‚¬ë°œë™: {
            ì¸ì‚¬ì´íŠ¸: ì¸ì‚¬ì´íŠ¸ë°œë™,   // true/false
            ì¸í…”ë¦¬ì „ìŠ¤: ì¸í…”ë¦¬ì „ìŠ¤ë°œë™, // true/false
            ë°œêµ´: ë°œêµ´ë°œë™              // true/false
        },
        ëª¨ë˜ì‹œê³„ë°œë™
    });
});

app.post("/use-salad", async (req, res) => {
    const { ìœ ì €UID } = req.body;
    if (!ìœ ì €UID) return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ, ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ, ìœ ë¬¼ëª©ë¡")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });

    const ë³´ìœ  = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ìƒëŸ¬ë“œ"] || 0;
    if (ë³´ìœ  < 1) return res.status(400).json({ ì˜¤ë¥˜: "ìƒëŸ¬ë“œê°€ ì—†ìŠµë‹ˆë‹¤" });

    const íšŒë³µëŸ‰ = 60;
    const í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ = ìœ ì €.í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ ?? 0;
    const ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ = ìœ ì €.ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ ?? 2000;

    // âœ… ì´ˆê³¼í•  ê²½ìš° ê±°ë¶€
    if (í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ + íšŒë³µëŸ‰ > ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ) {
        return res.status(400).json({ ì˜¤ë¥˜: "ìƒëŸ¬ë“œë¥¼ ë¨¹ê¸°ì—” ì´ë¦…ë‹ˆë‹¤" });
    }

    const ìƒˆìŠ¤íƒœë¯¸ë„ˆ = í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ + íšŒë³µëŸ‰;
    const ìœ ë¬¼ëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡, ìƒëŸ¬ë“œ: ë³´ìœ  - 1 };

    await supabaseAdmin
        .from("users")
        .update({ í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ: ìƒˆìŠ¤íƒœë¯¸ë„ˆ, ìœ ë¬¼ëª©ë¡ })
        .eq("ìœ ì €UID", ìœ ì €UID);

    return res.json({
        ê²°ê³¼: "ì„±ê³µ",
        í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ: ìƒˆìŠ¤íƒœë¯¸ë„ˆ,
        ìœ ë¬¼ëª©ë¡
    });
});

app.post("/use-Hamburger", async (req, res) => {
    const { ìœ ì €UID } = req.body;
    if (!ìœ ì €UID) return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ, ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ, ìœ ë¬¼ëª©ë¡")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });

    const ë³´ìœ  = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["í–„ë²„ê±°"] || 0;
    if (ë³´ìœ  < 1) return res.status(400).json({ ì˜¤ë¥˜: "í–„ë²„ê±°ê°€ ì—†ìŠµë‹ˆë‹¤" });

    const íšŒë³µëŸ‰ = 300;
    const í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ = ìœ ì €.í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ ?? 0;
    const ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ = ìœ ì €.ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ ?? 2000;

    // âœ… ì´ˆê³¼í•  ê²½ìš° ê±°ë¶€
    if (í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ + íšŒë³µëŸ‰ > ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ) {
        return res.status(400).json({ ì˜¤ë¥˜: "ë°°ë¶ˆëŸ¬ì„œ ëª»ë¨¹ê² ì–´ìš”" });
    }

    const ìƒˆìŠ¤íƒœë¯¸ë„ˆ = í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ + íšŒë³µëŸ‰;
    const ìœ ë¬¼ëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡, í–„ë²„ê±°: ë³´ìœ  - 1 };

    await supabaseAdmin
        .from("users")
        .update({ í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ: ìƒˆìŠ¤íƒœë¯¸ë„ˆ, ìœ ë¬¼ëª©ë¡ })
        .eq("ìœ ì €UID", ìœ ì €UID);

    return res.json({
        ê²°ê³¼: "ì„±ê³µ",
        í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ: ìƒˆìŠ¤íƒœë¯¸ë„ˆ,
        ìœ ë¬¼ëª©ë¡
    });
});

// â€œë§ˆë²•ì˜íŒ”ë ˆíŠ¸â€ ì‚¬ìš© ì²˜ë¦¬
app.post("/use-magic-palette", async (req, res) => {
    const { ìœ ì €UID } = req.body;
    if (!ìœ ì €UID) return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UIDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤" });

    // 1. ìœ ì € ì •ë³´ ì¡°íšŒ
    const { data: ìœ ì €, error: selectError } = await supabaseAdmin
        .from("users")
        .select("ìœ ë¬¼ëª©ë¡")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (selectError || !ìœ ì €) {
        return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" });
    }

    // 2. ë³´ìœ  ê°œìˆ˜ í™•ì¸ ë° ì°¨ê°
    const í˜„ì¬ëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡ };
    const íŒ”ë ˆíŠ¸ê°œìˆ˜ = Number(í˜„ì¬ëª©ë¡["ë§ˆë²•ì˜íŒ”ë ˆíŠ¸"] || 0);
    if (íŒ”ë ˆíŠ¸ê°œìˆ˜ < 1) {
        return res.status(400).json({ ì˜¤ë¥˜: "ë§ˆë²•ì˜íŒ”ë ˆíŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤" });
    }
    í˜„ì¬ëª©ë¡["ë§ˆë²•ì˜íŒ”ë ˆíŠ¸"] = íŒ”ë ˆíŠ¸ê°œìˆ˜ - 1;

    // 3. ëœë¤ íŒ”ë ˆíŠ¸ ìƒ‰ìƒ ì„ íƒ
    const íŒ”ë ˆíŠ¸ëª©ë¡ = [
        "ë¯¼ì´ˆ",
        "ì§€ì˜¥",
        "ë¸”ë¼ì„¬",
        "ê²¨ìš¸",
        "ë„¤ì˜¨ì‚¬ì¸",
        "í•‘í¬ì˜¤ì…˜",
        "í™©í˜¼í•˜ëŠ˜",
        "ì—ë©”ë„ë“œìˆ²",
        "ë…¸ë­",
        "ì´ˆë¡",
        "ë³´ë¼",
        "í•‘í¬",
    ];
    const ëœë¤ìƒ‰ = íŒ”ë ˆíŠ¸ëª©ë¡[Math.floor(Math.random() * íŒ”ë ˆíŠ¸ëª©ë¡.length)];


    const now = new Date();
    const kstNow = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
    const today = kstNow.toISOString().slice(0, 10);



    // 4. DB ì—…ë°ì´íŠ¸
    const { error: updateError } = await supabaseAdmin
        .from("users")
        .update({
            ìœ ë¬¼ëª©ë¡: í˜„ì¬ëª©ë¡,
            ë§ˆë²•ì˜íŒ”ë ˆíŠ¸: ëœë¤ìƒ‰,
            í˜„ì§ˆ: 1,
            í˜„ì§ˆê¸°í•œ: 1,
            í˜„ì§ˆê¸°í•œì²´í¬: today
        })
        .eq("ìœ ì €UID", ìœ ì €UID);


    if (updateError) {
        return res.status(500).json({ ì˜¤ë¥˜: "DB ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤" });
    }

    // 5. ê²°ê³¼ ë°˜í™˜
    return res.json({
        ê²°ê³¼: "ì„±ê³µ",
        ë§ˆë²•ì˜íŒ”ë ˆíŠ¸: ëœë¤ìƒ‰,
        ìœ ë¬¼ëª©ë¡: í˜„ì¬ëª©ë¡
    });
});

app.post("/use-flower", async (req, res) => {
    const { ìœ ì €UID } = req.body;
    if (!ìœ ì €UID) return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("ê³¨ë“œ, ìœ ë¬¼ëª©ë¡")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });

    const ë³´ìœ  = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["í”Œë¼ì›Œ"] || 0;
    if (ë³´ìœ  < 1) return res.status(400).json({ ì˜¤ë¥˜: "ê½ƒì´ ì—†ìŠµë‹ˆë‹¤" });

    const íŒë§¤ê³¨ë“œ = 100000;
    ìœ ì €.ê³¨ë“œ += íŒë§¤ê³¨ë“œ;
    const ìœ ë¬¼ëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡, í”Œë¼ì›Œ: ë³´ìœ  - 1 };

    await supabaseAdmin
        .from("users")
        .update({ ê³¨ë“œ: ìœ ì €.ê³¨ë“œ, ìœ ë¬¼ëª©ë¡ })
        .eq("ìœ ì €UID", ìœ ì €UID);

    return res.json({
        ê²°ê³¼: "ì„±ê³µ",
        ê³¨ë“œ: ìœ ì €.ê³¨ë“œ,
        ìœ ë¬¼ëª©ë¡
    });
});

app.post("/use-bone", async (req, res) => {
    const { ìœ ì €UID } = req.body;
    if (!ìœ ì €UID) return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("ê³¨ë“œ, ìœ ë¬¼ëª©ë¡")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });

    const ë³´ìœ  = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ë¼ˆë‹¤êµ¬"] || 0;
    if (ë³´ìœ  < 1) return res.status(400).json({ ì˜¤ë¥˜: "ë¼ˆë‹¤êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤" });

    const íŒë§¤ê³¨ë“œ = 100000;
    ìœ ì €.ê³¨ë“œ += íŒë§¤ê³¨ë“œ;
    const ìœ ë¬¼ëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡, ë¼ˆë‹¤êµ¬: ë³´ìœ  - 1 };

    await supabaseAdmin
        .from("users")
        .update({ ê³¨ë“œ: ìœ ì €.ê³¨ë“œ, ìœ ë¬¼ëª©ë¡ })
        .eq("ìœ ì €UID", ìœ ì €UID);

    return res.json({
        ê²°ê³¼: "ì„±ê³µ",
        ê³¨ë“œ: ìœ ì €.ê³¨ë“œ,
        ìœ ë¬¼ëª©ë¡
    });
});




app.post("/update-skill", async (req, res) => {
    const { ìœ ì €UID, ìŠ¤í‚¬ì´ë¦„, í–‰ë™ } = req.body;
    if (!ìœ ì €UID || !ìŠ¤í‚¬ì´ë¦„ || !í–‰ë™) {
        return res.status(400).json({ ì˜¤ë¥˜: "ì…ë ¥ê°’ ëˆ„ë½" });
    }

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("ìŠ¤í‚¬, ìˆ™ë ¨ë„, ìœ ë¬¼ëª©ë¡")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });

    let ìŠ¤í‚¬ = ìœ ì €.ìŠ¤í‚¬ || {};
    let ìˆ™ë ¨ë„ = ìœ ì €.ìˆ™ë ¨ë„ || 0;

    if (ìŠ¤í‚¬ì´ë¦„ === "ì „ì²´" && í–‰ë™ === "ì´ˆê¸°í™”") {
        const í”Œë¼ì›Œ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["í”Œë¼ì›Œ"] || 0;

        if (í”Œë¼ì›Œ < 1) {
            return res.status(400).json({ ì˜¤ë¥˜: "í”Œë¼ì›Œ ìœ ë¬¼ì´ ë¶€ì¡±í•©ë‹ˆë‹¤" });
        }

        const ì´íˆ¬ì = Object.values(ìŠ¤í‚¬).reduce((a, b) => a + b, 0);
        const í™˜ê¸‰ = 500 * ì´íˆ¬ì * (ì´íˆ¬ì + 1) / 2;

        ìˆ™ë ¨ë„ += í™˜ê¸‰;
        ìŠ¤í‚¬ = {};

        const ìœ ë¬¼ëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡, í”Œë¼ì›Œ: í”Œë¼ì›Œ - 1 }; // 1ê°œ ì°¨ê°

        const { error: ì €ì¥ì˜¤ë¥˜ } = await supabaseAdmin
            .from("users")
            .update({ ìŠ¤í‚¬, ìˆ™ë ¨ë„, ìœ ë¬¼ëª©ë¡ })  // â† ìœ ë¬¼ëª©ë¡ë„ ê°™ì´ ì €ì¥
            .eq("ìœ ì €UID", ìœ ì €UID);

        if (ì €ì¥ì˜¤ë¥˜) return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });

        return res.json({ ì„±ê³µ: true, ìŠ¤í‚¬, ìˆ™ë ¨ë„, ìŠ¤í‚¬ìƒíƒœ: {}, ìœ ë¬¼ëª©ë¡ }); // â† ìœ ë¬¼ëª©ë¡ë„ ê°™ì´ ë°˜í™˜
    }

    const ìŠ¤í‚¬ì •ë³´ = {
        ë²„ì„œì»¤: { ë‹¨ê³„: Array(23).fill(0) },
        ë“œë ˆì¸: { ë‹¨ê³„: Array(23).fill(0) },
        ë°œêµ´: { ë‹¨ê³„: Array(23).fill(0) },
        ì•„ì´ì–¸ë°”ë””: { ë‹¨ê³„: Array(23).fill(0) },
        ì¸ì‚¬ì´íŠ¸: { ë‹¨ê³„: Array(1).fill(0) },
        í¬ë¦¬í‹°ì»¬: { ë‹¨ê³„: Array(23).fill(0) },
        ë²„ë‹: { ë‹¨ê³„: Array(23).fill(0) },
        ì¸í…”ë¦¬ì „ìŠ¤: { ë‹¨ê³„: Array(23).fill(0) },
        ë¸Œë¡œí°: { ë‹¨ê³„: Array(23).fill(0) },
    };

    if (!ìŠ¤í‚¬ì •ë³´[ìŠ¤í‚¬ì´ë¦„]) {
        return res.status(400).json({ ì˜¤ë¥˜: "êµ¬í˜„ì¤‘ì…ë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”" });
    }

    const ë‹¨ê³„ìˆ˜ = ìŠ¤í‚¬ì •ë³´[ìŠ¤í‚¬ì´ë¦„].ë‹¨ê³„.length;
    const ìµœëŒ€ë ˆë²¨ = ë‹¨ê³„ìˆ˜;
    const í˜„ì¬ë ˆë²¨ = ìŠ¤í‚¬[ìŠ¤í‚¬ì´ë¦„] || 0;
    const ì´íˆ¬ì = Object.values(ìŠ¤í‚¬).reduce((a, b) => a + b, 0);

    if (í–‰ë™ === "ìŠµë“") {
        if (í˜„ì¬ë ˆë²¨ >= ìµœëŒ€ë ˆë²¨) return res.status(400).json({ ì˜¤ë¥˜: "ìµœì¢…ë‹¨ê³„ì…ë‹ˆë‹¤" });

        const íˆ¬ì = ì´íˆ¬ì;
        const í•„ìš”í•œìˆ™ë ¨ë„ = (íˆ¬ì + 1) * 500;

        if (ìˆ™ë ¨ë„ < í•„ìš”í•œìˆ™ë ¨ë„) return res.status(400).json({ ì˜¤ë¥˜: "ìˆ™ë ¨ë„ ë¶€ì¡±" });

        ìˆ™ë ¨ë„ -= í•„ìš”í•œìˆ™ë ¨ë„;
        ìŠ¤í‚¬[ìŠ¤í‚¬ì´ë¦„] = í˜„ì¬ë ˆë²¨ + 1;
    }

    else if (í–‰ë™ === "íšŒìˆ˜") {
        if (í˜„ì¬ë ˆë²¨ < 1) return res.status(400).json({ ì˜¤ë¥˜: "íšŒìˆ˜í•  ìŠ¤í‚¬ ì—†ìŒ" });

        const íˆ¬ì = ì´íˆ¬ì;
        const í™˜ê¸‰ìˆ™ë ¨ë„ = íˆ¬ì * 500;

        ìˆ™ë ¨ë„ += í™˜ê¸‰ìˆ™ë ¨ë„;
        ìŠ¤í‚¬[ìŠ¤í‚¬ì´ë¦„] = í˜„ì¬ë ˆë²¨ - 1;
    }

    else {
        return res.status(400).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
    }

    // âœ… ìŠ¤í‚¬ìƒíƒœ ê³„ì‚°: ê° ê³„ì—´ì˜ í˜„ì¬ ì´ë¦„ê³¼ ì„¤ëª…
    const ìŠ¤í‚¬ìƒíƒœ = {};
    for (const í‚¤ in ìŠ¤í‚¬ì •ë³´) {
        const ë ˆë²¨ = ìŠ¤í‚¬[í‚¤] || 0;
        const ì¸ë±ìŠ¤ = Math.min(ë ˆë²¨ - 1, ìŠ¤í‚¬ì •ë³´[í‚¤].ë‹¨ê³„.length - 1);
        if (ë ˆë²¨ > 0) {
            ìŠ¤í‚¬ìƒíƒœ[í‚¤] = {
                ì´ë¦„: ìŠ¤í‚¬ì •ë³´[í‚¤].ë‹¨ê³„[ì¸ë±ìŠ¤]
            };
        } else {
            ìŠ¤í‚¬ìƒíƒœ[í‚¤] = {
                ì´ë¦„: ìŠ¤í‚¬ì •ë³´[í‚¤].ë‹¨ê³„[0]
            };
        }
    }

    const { error: ì €ì¥ì˜¤ë¥˜ } = await supabaseAdmin
        .from("users")
        .update({ ìŠ¤í‚¬, ìˆ™ë ¨ë„ })
        .eq("ìœ ì €UID", ìœ ì €UID);

    if (ì €ì¥ì˜¤ë¥˜) return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });

    return res.json({ ì„±ê³µ: true, ìŠ¤í‚¬, ìˆ™ë ¨ë„, ìŠ¤í‚¬ìƒíƒœ });
});



app.post("/register-user", async (req, res) => {
    const { ìœ ì €UID, ìœ ì €ì•„ì´ë””, ê¸°ê¸°ID, ë¡œê·¸ì¸ì´ë©”ì¼ } = req.body;

    if (!ìœ ì €UID || !ìœ ì €ì•„ì´ë”” || !ê¸°ê¸°ID) {
        return res.status(400).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
    }

    const now = new Date();
    const formatter = new Intl.DateTimeFormat("ko-KR", {
        hour: "numeric",
        hour12: false,
        timeZone: "Asia/Seoul"
    });
    const parts = formatter.formatToParts(now);

    const kstNow = new Date(
        now.toLocaleString("en-US", { timeZone: "Asia/Seoul" })
    );
    const today = kstNow.toISOString().slice(0, 10);

    const í˜„ì¬ì •ê°ì‹œê°„ = Math.floor(Date.now() / 1000 / 3600); // ì‹œê°„ ë‹¨ìœ„ ê¸°ì¤€ (ì •ìˆ˜)

    const ìœ ë¬¼ëª©ë¡ = Object.fromEntries(
        Object.keys(ì‹ í™”ìœ ë¬¼ë°ì´í„°).map(ì´ë¦„ => [ì´ë¦„, 1])
    );

    ìœ ë¬¼ëª©ë¡["ìŠ¤í”¼ì»¤"] = 9;
    ìœ ë¬¼ëª©ë¡["ë§ˆë²•ì˜íŒ”ë ˆíŠ¸"] = 0;




    //ì‹ ê·œìœ ì €
    const ì‚½ì…ê°’ = {
        ìœ ì €UID,
        ìœ ì €ì•„ì´ë””,
        ë¡œê·¸ì¸ì´ë©”ì¼,
        ê¸°ê¸°ID,
        ë ˆë²¨: 1,
        ë ˆë²¨ê³µê²©ë ¥: 10,
        ì „ì§ê³µê²©ë ¥: 1,
        ìµœì¢…ê³µê²©ë ¥: 10,
        ì¥ë¹„ê³µê²©ë ¥: 0,
        í«ë‹¨ê³„: 0,
        ê²½í—˜ì¹˜: 0,
        ê³¨ë“œ: 1000000,
        ìµœëŒ€ì²´ë ¥: 10,
        ë‚¨ì€ì²´ë ¥: 10,
        ìˆ™ë ¨ë„: 0,
        í˜„ì¬ì¸µ: 1,
        í˜„ì¬ì•…ë§ˆë²ˆí˜¸: Math.floor(Math.random() * 72) + 1,
        ìŠ¤í‚¬: {},
        ìœ ë¬¼ëª©ë¡,
        ì¥ë¹„ëª©ë¡: [],
        ë²„ì „ì—…: 8,
        í˜„ì¬ìŠ¤íƒœë¯¸ë„ˆ: 2000,
        ìµœëŒ€ìŠ¤íƒœë¯¸ë„ˆ: 2000,
        ìŠ¤íƒœë¯¸ë„ˆê°±ì‹ ì‹œê°„: í˜„ì¬ì •ê°ì‹œê°„,
        ì „ì§ì •ë³´: {
            "ë°±ì¸ì¥": 0,
            "ì˜¤ë°±ì¸ì¥": 0,
            "ì²œì¸ì¥": 0,
            "ë§Œì¸ì¥": 0,
            "ë¶€ì¥êµ°": 0,
            "ì¥êµ°": 0,
            "ëŒ€ì¥êµ°": 0,
            "ëŒ€ì‚¬ë§ˆ": 0,
            "ìŠ¹ìƒ": 0,
            "í›„": 0,
            "ê³µ": 0,
            "ì œí›„": 0,
            "ì™•": 0,
            "í™©ì œ": 0,
            "ì²œí™©": 0,
            "ì œí™©": 0,
            "íƒœí™©": 0,
            "ì²œì œ": 0
        },
        ìƒì„±ì¼: today,
        ì§€í•˜ë˜ì „: 1,
        í•˜ë£¨í•œë²ˆ: today,
        ì•…ì„¸ì‚¬ë¦¬ì¥ë¹„ì¹¸: 1,

    };


    const ë¬¸êµ¬ = `ëŒ€ë¥™ì— ë“±ì¥í–ˆë‹¤`;
    await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
        ìœ ì €UID: ì‚½ì…ê°’.ìœ ì €UID,
        ìœ ì €ì•„ì´ë””: ì‚½ì…ê°’.ìœ ì €ì•„ì´ë””,
        ë¬¸êµ¬
    });




    const { error: ì‚½ì…ì˜¤ë¥˜ } = await supabaseAdmin
        .from("users")
        .insert(ì‚½ì…ê°’);

    if (ì‚½ì…ì˜¤ë¥˜) {
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
    }

    return res.json({ ìœ ì €ë°ì´í„°: ì‚½ì…ê°’ });
});

app.post("/ranking", async (req, res) => {
    const { ìœ ì €UID } = req.body;

    try {
        const { data: ìœ ì €ë“¤, error } = await supabaseAdmin
            .from("users")
            .select("*")
            .eq("ë²„ì „ì—…", 8)
            .not("ìµœì¢…ê³µê²©ë ¥", "is", null)
            .neq("ìœ ì €ì•„ì´ë””", "í…ŒìŠ¤íŠ¸ì•„ì´ë””")
            .order("ìµœì¢…ê³µê²©ë ¥", { ascending: false });

        if (error) {
            return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
        }

        const kstToday = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
        const todayDateOnly = new Date(kstToday.getFullYear(), kstToday.getMonth(), kstToday.getDate());

        // âœ… í•˜ë£¨í•œë²ˆ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ 25ì¼~27ì¼ ì ‘ì†ìë§Œ í•„í„°ë§
        const ìµœê·¼ì ‘ì†ìœ ì €ë“¤ = ìœ ì €ë“¤.filter(ìœ ì € => {
            const ì ‘ì†ì‹œê° = new Date(ìœ ì €.í•˜ë£¨í•œë²ˆ);
            const ì ‘ì†KST = new Date(ì ‘ì†ì‹œê°.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
            const ì ‘ì†DateOnly = new Date(ì ‘ì†KST.getFullYear(), ì ‘ì†KST.getMonth(), ì ‘ì†KST.getDate());

            const diffì¼ìˆ˜ = (todayDateOnly - ì ‘ì†DateOnly) / (1000 * 60 * 60 * 24); // ë°€ë¦¬ì´ˆ ì°¨ì´ë¥¼ ì¼ìˆ˜ë¡œ
            return diffì¼ìˆ˜ <= 2; // ì˜¤ëŠ˜, ì–´ì œ, ê·¸ì œ
        });

        // ì§ìœ„ ì²˜ë¦¬
        for (const ìœ ì € of ìµœê·¼ì ‘ì†ìœ ì €ë“¤) {
            ìœ ì €.ì§ìœ„ = ìµœê³ ì „ì§ëª…(ìœ ì €.ì „ì§ì •ë³´) || "";
        }

        // âœ… ë³´ìŠ¤ë­í‚¹ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
        const { data: ë³´ìŠ¤ë­í‚¹, error: ìœ ì €ì—ëŸ¬ } = await supabaseAdmin
            .from("users")
            .select("ìœ ì €ì•„ì´ë””, ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€, ìœ ì €UID")
            .gt("ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€", 0)
            .order("ë³´ìŠ¤ëˆ„ì ë°ë¯¸ì§€", { ascending: false });

        return res.json({ ìœ ì €ë“¤: ìµœê·¼ì ‘ì†ìœ ì €ë“¤, ë³´ìŠ¤ë­í‚¹ });
    } catch (e) {
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
    }
});

app.post("/delete-user", async (req, res) => {
    const { ìœ ì €UID } = req.body;

    if (!ìœ ì €UID) {
        return res.status(400).json({ ì˜¤ë¥˜: "UID ëˆ„ë½ë¨" });
    }

    try {
        // 1. users í…Œì´ë¸” ì‚­ì œ
        const { error: í…Œì´ë¸”ì‚­ì œì˜¤ë¥˜ } = await supabaseAdmin
            .from("users")
            .delete()
            .eq("ìœ ì €UID", ìœ ì €UID);

        if (í…Œì´ë¸”ì‚­ì œì˜¤ë¥˜) {
            console.error("ìœ ì € í…Œì´ë¸” ì‚­ì œ ì‹¤íŒ¨:", í…Œì´ë¸”ì‚­ì œì˜¤ë¥˜.message);
            return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
        }

        // 2. Supabase Auth ê³„ì • ì‚­ì œ
        const { error: ì¸ì¦ì‚­ì œì˜¤ë¥˜ } = await supabaseAdmin.auth.admin.deleteUser(ìœ ì €UID);

        if (ì¸ì¦ì‚­ì œì˜¤ë¥˜) {
            console.error("Auth ì‚­ì œ ì‹¤íŒ¨:", ì¸ì¦ì‚­ì œì˜¤ë¥˜.message);
            return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
        }

        return res.json({ ë©”ì‹œì§€: "ìœ ì € ë°ì´í„° ë° ì¸ì¦ ì‚­ì œ ì™„ë£Œ" });
    } catch (e) {
        console.error("ìœ ì € ì‚­ì œ ì¤‘ ì˜ˆì™¸:", e.message);
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
    }
});

app.post("/update-username", async (req, res) => {
    const { ìœ ì €UID, ìƒˆì•„ì´ë”” } = req.body;

    if (!ìœ ì €UID || !ìƒˆì•„ì´ë”” || ìƒˆì•„ì´ë””.length > 8) {
        return res.status(400).json({ ì˜¤ë¥˜: "ì…ë ¥ê°’ ëˆ„ë½ ë˜ëŠ” ê¸¸ì´ ì´ˆê³¼" });
    }

    // âœ… ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë”” ìˆëŠ”ì§€ í™•ì¸
    const { data: ì¤‘ë³µ, error: ì¡°íšŒì˜¤ë¥˜ } = await supabaseAdmin
        .from("users")
        .select("ìœ ì €UID")
        .eq("ìœ ì €ì•„ì´ë””", ìƒˆì•„ì´ë””)
        .neq("ìœ ì €UID", ìœ ì €UID);

    if (ì¡°íšŒì˜¤ë¥˜) {
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
    }

    if (ì¤‘ë³µ.length > 0) {
        return res.status(409).json({ ì˜¤ë¥˜: "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤" });
    }

    const { error: ì—…ë°ì´íŠ¸ì˜¤ë¥˜ } = await supabaseAdmin
        .from("users")
        .update({ ìœ ì €ì•„ì´ë””: ìƒˆì•„ì´ë”” })
        .eq("ìœ ì €UID", ìœ ì €UID);

    if (ì—…ë°ì´íŠ¸ì˜¤ë¥˜) {
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
    }

    return res.json({ ì„±ê³µ: true });
});

app.post("/get-job-info", async (req, res) => {
    const { ìœ ì €UID } = req.body;

    if (!ìœ ì €UID) return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("ì „ì§ì •ë³´, ê²½í—˜ì¹˜")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });

    return res.json({
        ì „ì§ì •ë³´: ìœ ì €.ì „ì§ì •ë³´,
        ê²½í—˜ì¹˜: ìœ ì €.ê²½í—˜ì¹˜
    });
});

app.post("/get-job-result", async (req, res) => {
    const { ìœ ì €UID } = req.body;

    if (!ìœ ì €UID) return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("ì§ì—…ê²°ì •, ê²½í—˜ì¹˜")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });

    return res.json({
        ì§ì—…ê²°ì •: ìœ ì €.ì§ì—…ê²°ì •,
        ê²½í—˜ì¹˜: ìœ ì €.ê²½í—˜ì¹˜
    });
});

app.post("/set-job-result", async (req, res) => {
    const { ìœ ì €UID, ê³„ì—´ì„ íƒ } = req.body;
    if (!ìœ ì €UID || !ê³„ì—´ì„ íƒ) {
        return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ë˜ëŠ” ê³„ì—´ ì •ë³´ ëˆ„ë½" });
    }

    try {
        // 1) í˜„ì¬ ì €ì¥ëœ ì§ì—…ê²°ì •(JSON) ì»¬ëŸ¼ + ê²½í—˜ì¹˜ ì¡°íšŒ
        const { data: ìœ ì €, error: ì¡°íšŒì—ëŸ¬ } = await supabaseAdmin
            .from("users")
            .select("*")
            .eq("ìœ ì €UID", ìœ ì €UID)
            .single();

        if (ì¡°íšŒì—ëŸ¬ || !ìœ ì €) {
            return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });
        }

        // 2) ê¸°ì¡´ì— ì €ì¥ëœ JSONì„ íŒŒì‹±í•˜ê±°ë‚˜, ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ë¡œ ì´ˆê¸°í™”
        const ê¸°ì¡´ì§ì—…ê²°ì • = ìœ ì €.ì§ì—…ê²°ì • || {};

        // 3) í•´ë‹¹ ê³„ì—´ì˜ ë‹¨ê³„ ê³„ì‚° (ì´ë¯¸ í‚¤ê°€ ìˆìœ¼ë©´ +1, ì—†ìœ¼ë©´ 1ë¶€í„° ì‹œì‘)
        const í˜„ì¬ë‹¨ê³„ = ê¸°ì¡´ì§ì—…ê²°ì •[ê³„ì—´ì„ íƒ] ?? 0;
        const ë‹¤ìŒë‹¨ê³„ = í˜„ì¬ë‹¨ê³„ + 1;

        // 4) ê²½í—˜ì¹˜ ë¹„ìš© ê³„ì‚° (ë‹¨ê³„ 1 â†’ 100,000p, ë‹¨ê³„ 2 â†’ 200,000p, â€¦)
        const cost = ë‹¤ìŒë‹¨ê³„ * 150000;

        // 5) ê²½í—˜ì¹˜ ì¶©ë¶„ ì—¬ë¶€ ê²€ì‚¬
        const í˜„ì¬ê²½í—˜ì¹˜ = ìœ ì €.ê²½í—˜ì¹˜ ?? 0;
        if (í˜„ì¬ê²½í—˜ì¹˜ < cost) {
            return res.status(400).json({ ì˜¤ë¥˜: `ê²½í—˜ì¹˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤` });
        }

        // 6) ìƒˆë¡œìš´ JSON ê°ì²´ ìƒì„±
        const ìƒˆë¡œìš´ì§ì—…ê²°ì • = {
            ...ê¸°ì¡´ì§ì—…ê²°ì •,
            [ê³„ì—´ì„ íƒ]: ë‹¤ìŒë‹¨ê³„
        };

        // 7) ìƒˆë¡œìš´ ê²½í—˜ì¹˜ ê³„ì‚°
        const ìƒˆë¡œìš´ê²½í—˜ì¹˜ = í˜„ì¬ê²½í—˜ì¹˜ - cost;

        const calculatedLevel = Math.floor(ìƒˆë¡œìš´ê²½í—˜ì¹˜ / 1000) + 1;      // ì¶”ê°€
        ìœ ì €.ë ˆë²¨ = calculatedLevel;                                      // ì¶”ê°€
        ìœ ì €.ë ˆë²¨ê³µê²©ë ¥ = 10 + (calculatedLevel - 1);                     // ì¶”ê°€
        ìœ ì €.ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìœ ì €);

        // 8) users í…Œì´ë¸”ì˜ ì§ì—…ê²°ì • + ê²½í—˜ì¹˜ ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
        const { error: ì—…ë°ì´íŠ¸ì—ëŸ¬ } = await supabaseAdmin
            .from("users")
            .update({
                ì§ì—…ê²°ì •: ìƒˆë¡œìš´ì§ì—…ê²°ì •,
                ê²½í—˜ì¹˜: ìƒˆë¡œìš´ê²½í—˜ì¹˜,
                ë ˆë²¨: ìœ ì €.ë ˆë²¨,
                ë ˆë²¨ê³µê²©ë ¥: ìœ ì €.ë ˆë²¨ê³µê²©ë ¥,
                ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥
            })
            .eq("ìœ ì €UID", ìœ ì €UID);


        const ë¬¸êµ¬ = `${ê³„ì—´ì„ íƒ} ${ë‹¤ìŒë‹¨ê³„}ì°¨ë¡œ ì „ì§í–ˆë‹¤`;
        await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
            ìœ ì €UID: ìœ ì €.ìœ ì €UID,
            ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
            ë¬¸êµ¬
        });



        if (ì—…ë°ì´íŠ¸ì—ëŸ¬) {
            return res.status(500).json({ ì˜¤ë¥˜: "DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨" });
        }

        return res.json({ ì„±ê³µ: true, ìƒˆë¡œìš´ê²½í—˜ì¹˜, ë ˆë²¨: ìœ ì €.ë ˆë²¨, ë ˆë²¨ê³µê²©ë ¥: ìœ ì €.ë ˆë²¨ê³µê²©ë ¥, ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥ });
    } catch (e) {
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ ì˜ˆì™¸ ë°œìƒ" });
    }
});

app.post("/promote-job", async (req, res) => {
    const { ìœ ì €UID, ì§ìœ„ } = req.body;

    if (!ìœ ì €UID || !ì§ìœ„) {
        return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ë˜ëŠ” ì§ìœ„ ëˆ„ë½" });
    }

    // ìœ ì € ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    const ì „ì§ì •ë³´ = ìœ ì €.ì „ì§ì •ë³´ ?? {};
    const ì™„ë£Œì „ì§ê°¯ìˆ˜ = Object.values(ì „ì§ì •ë³´).filter(v => v === 1).length;
    const ë¹„ìš© = (ì™„ë£Œì „ì§ê°¯ìˆ˜ + 1) * 50000;

    if (error || !ìœ ì €) {
        return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });
    }

    const ê²½í—˜ì¹˜ = ìœ ì €.ê²½í—˜ì¹˜ ?? 0;

    if (ê²½í—˜ì¹˜ < ë¹„ìš©) {
        return res.status(400).json({ ì˜¤ë¥˜: "ê²½í—˜ì¹˜ ë¶€ì¡±" });
    }

    if (ì „ì§ì •ë³´[ì§ìœ„] === 1) {
        return res.status(400).json({ ì˜¤ë¥˜: "ì´ë¯¸ ì „ì§ ì™„ë£Œëœ ì§ìœ„ì…ë‹ˆë‹¤" });
    }

    ì „ì§ì •ë³´[ì§ìœ„] = 1;

    ìœ ì €.ì „ì§ê³µê²©ë ¥ = ì™„ë£Œì „ì§ê°¯ìˆ˜ + 2;
    const ìƒˆë ˆë²¨ = Math.floor((ê²½í—˜ì¹˜ - ë¹„ìš©) / 1000) + 1;

    const ìƒˆë ˆë²¨ê³µê²©ë ¥ = 10 + (ìƒˆë ˆë²¨ - 1) * 1;
    ìœ ì €.ë ˆë²¨ê³µê²©ë ¥ = ìƒˆë ˆë²¨ê³µê²©ë ¥;

    const ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìœ ì €);
    ìœ ì €.ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥;

    const ì—…ë°ì´íŠ¸ = {
        ë ˆë²¨ê³µê²©ë ¥: ìƒˆë ˆë²¨ê³µê²©ë ¥,
        ìµœì¢…ê³µê²©ë ¥: ìµœì¢…ê³µê²©ë ¥,
        ê²½í—˜ì¹˜: ê²½í—˜ì¹˜ - ë¹„ìš©,
        ë ˆë²¨: ìƒˆë ˆë²¨,
        ì „ì§ì •ë³´,
        ì „ì§ê³µê²©ë ¥: ì™„ë£Œì „ì§ê°¯ìˆ˜ + 2
    };


    const { error: ì—…ë°ì´íŠ¸ì˜¤ë¥˜ } = await supabaseAdmin
        .from("users")
        .update(ì—…ë°ì´íŠ¸)
        .eq("ìœ ì €UID", ìœ ì €UID);

    if (ì—…ë°ì´íŠ¸ì˜¤ë¥˜) {
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ì˜¤ë¥˜" });
    }

    return res.json({ ì„±ê³µ: true, ì „ì§ì •ë³´: ì „ì§ì •ë³´, ê²½í—˜ì¹˜: ê²½í—˜ì¹˜ - ë¹„ìš©, ë ˆë²¨: ìƒˆë ˆë²¨, ìµœì¢…ê³µê²©ë ¥: ìµœì¢…ê³µê²©ë ¥, ë ˆë²¨ê³µê²©ë ¥: ìƒˆë ˆë²¨ê³µê²©ë ¥ });
});

function calcì „ì§í™˜ê¸‰(expInfo) {
    // expInfo ëŠ” JSON ê°ì²´. ì˜ˆ: { "ê³µ":0, "ì™•":1, "í›„":1, ... }
    const learnedCount = Object.values(expInfo).filter(v => v === 1).length;
    let total = 0;
    for (let i = 1; i <= learnedCount; i++) {
        total += 50000 * i;
    }
    return total;
}

// Helper: ì§ì—…ê²°ì • JSONì—ì„œ ë ˆë²¨ì„ êº¼ë‚´ì–´ ëˆ„ì  ê²½í—˜ì¹˜ ê³„ì‚° (150k * 1 + 150k * 2 + â€¦)
function calcì§ì—…í™˜ê¸‰(jobDecision) {
    // jobDecision ì€ null ì´ê±°ë‚˜ { "ê³„ì—´ëª…": ìˆ«ì } í˜•íƒœ
    if (!jobDecision) return 0;
    // Object.values(jobDecision)[0]ìœ¼ë¡œ ë ˆë²¨ì„ ê°€ì ¸ì˜´
    const level = Object.values(jobDecision)[0];
    if (typeof level !== 'number' || level < 1) return 0;

    let total = 0;
    for (let i = 1; i <= level; i++) {
        total += 150000 * i;
    }
    return total;
}

// index.js (ê¸°ì¡´ ì½”ë“œì—ì„œ /reset-job í•¸ë“¤ëŸ¬ë§Œ ë°œì·Œí•˜ì—¬ ìˆ˜ì •í•œ ì˜ˆì‹œ)

app.post('/reset-job', async (req, res) => {
    const { ìœ ì €UID } = req.body;
    if (!ìœ ì €UID) {
        return res.status(400).json({ ì˜¤ë¥˜: 'ìœ ì €UID ëˆ„ë½' });
    }

    try {
        // 1) ìœ ì € ì •ë³´ ì¡°íšŒ
        const { data: user, error: selectError } = await supabaseAdmin
            .from('users')
            .select('*')
            .eq('ìœ ì €UID', ìœ ì €UID)
            .single();

        if (selectError || !user) {
            return res.status(404).json({ ì˜¤ë¥˜: 'ìœ ì € ì •ë³´ ì—†ìŒ' });
        }

        // 2) "ë¼ˆë‹¤êµ¬" ìœ ë¬¼ì´ ìµœì†Œ 1ê°œ ìˆëŠ”ì§€ í™•ì¸
        const ìœ ë¬¼ëª©ë¡ = user.ìœ ë¬¼ëª©ë¡ || {};
        const í˜„ì¬ë¼ˆë‹¤êµ¬ê°œìˆ˜ = (ìœ ë¬¼ëª©ë¡['ë¼ˆë‹¤êµ¬'] ?? 0);
        if (í˜„ì¬ë¼ˆë‹¤êµ¬ê°œìˆ˜ < 1) {
            return res.status(400).json({ ì˜¤ë¥˜: 'ë¼ˆë‹¤êµ¬ ìœ ë¬¼ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.' });
        }

        // 3) ê¸°ì¡´ ì „ì§ì •ë³´ì—ì„œ í™˜ê¸‰ ê²½í—˜ì¹˜ ê³„ì‚°
        //    calcì „ì§í™˜ê¸‰() í•¨ìˆ˜ëŠ”, ê°’ì´ 1ì¸ í‚¤ì˜ ê°œìˆ˜ë§Œí¼ (50,000 Ã— ë ˆë²¨ë²ˆí˜¸)ë¥¼ ëˆ„ì í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
        const ì „ì§ì •ë³´ = user.ì „ì§ì •ë³´ || {};
        const ì „ì§í™˜ê¸‰ = calcì „ì§í™˜ê¸‰(ì „ì§ì •ë³´);  // :contentReference[oaicite:0]{index=0}

        // 4) ê¸°ì¡´ ì§ì—…ê²°ì •ì—ì„œ í™˜ê¸‰ ê²½í—˜ì¹˜ ê³„ì‚°
        //    calcì§ì—…í™˜ê¸‰() í•¨ìˆ˜ëŠ”, ì €ì¥ëœ ë ˆë²¨ì— ë”°ë¼ (150,000 Ã— ë ˆë²¨ë²ˆí˜¸)ë¥¼ ëˆ„ì í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
        const ì§ì—…í™˜ê¸‰ = calcì§ì—…í™˜ê¸‰(user.ì§ì—…ê²°ì •);  // :contentReference[oaicite:1]{index=1}

        // 5) ìµœì¢… í™˜ê¸‰ ê²½í—˜ì¹˜ = ì „ì§í™˜ê¸‰ + ì§ì—…í™˜ê¸‰
        const totalí™˜ê¸‰ = ì „ì§í™˜ê¸‰ + ì§ì—…í™˜ê¸‰;

        // 6) ê¸°ì¡´ ê²½í—˜ì¹˜ + í™˜ê¸‰ëœ ê²½í—˜ì¹˜
        const ê¸°ì¡´ê²½í—˜ì¹˜ = user.ê²½í—˜ì¹˜ ?? 0;
        const í™˜ê¸‰í›„ê²½í—˜ì¹˜ = ê¸°ì¡´ê²½í—˜ì¹˜ + totalí™˜ê¸‰;

        // 7) ìœ ë¬¼ëª©ë¡ì—ì„œ "ë¼ˆë‹¤êµ¬" 1ê°œ ì°¨ê°
        const updatedìœ ë¬¼ëª©ë¡ = {
            ...ìœ ë¬¼ëª©ë¡,
            'ë¼ˆë‹¤êµ¬': í˜„ì¬ë¼ˆë‹¤êµ¬ê°œìˆ˜ - 1
        };

        // 8) ì „ì§ì •ë³´ ì´ˆê¸°í™”: ëª¨ë“  í‚¤ë¥¼ 0ìœ¼ë¡œ ë³€ê²½
        const ì´ˆê¸°ì „ì§ì •ë³´ = {};
        for (const key of Object.keys(ì „ì§ì •ë³´)) {
            ì´ˆê¸°ì „ì§ì •ë³´[key] = 0;
        }

        const ìƒˆì „ì§ê³µê²©ë ¥ = 1;

        const ìƒˆë ˆë²¨ = Math.floor(í™˜ê¸‰í›„ê²½í—˜ì¹˜ / 1000) + 1;

        const ìƒˆë ˆë²¨ê³µê²©ë ¥ = 10 + (ìƒˆë ˆë²¨ - 1);

        user.ê²½í—˜ì¹˜ = í™˜ê¸‰í›„ê²½í—˜ì¹˜;
        user.ì „ì§ì •ë³´ = ì´ˆê¸°ì „ì§ì •ë³´;
        user.ì „ì§ê³µê²©ë ¥ = ìƒˆì „ì§ê³µê²©ë ¥;
        user.ë ˆë²¨ = ìƒˆë ˆë²¨;
        user.ë ˆë²¨ê³µê²©ë ¥ = ìƒˆë ˆë²¨ê³µê²©ë ¥;
        user.ìœ ë¬¼ëª©ë¡ = updatedìœ ë¬¼ëª©ë¡;

        const ìƒˆìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(user);  // :contentReference[oaicite:2]{index=2}

        const { error: updateError } = await supabaseAdmin
            .from('users')
            .update({
                ì „ì§ì •ë³´: ì´ˆê¸°ì „ì§ì •ë³´,
                ì§ì—…ê²°ì •: null,
                ê²½í—˜ì¹˜: í™˜ê¸‰í›„ê²½í—˜ì¹˜,
                ìœ ë¬¼ëª©ë¡: updatedìœ ë¬¼ëª©ë¡,
                ì „ì§ê³µê²©ë ¥: ìƒˆì „ì§ê³µê²©ë ¥,
                ë ˆë²¨: ìƒˆë ˆë²¨,
                ë ˆë²¨ê³µê²©ë ¥: ìƒˆë ˆë²¨ê³µê²©ë ¥,
                ìµœì¢…ê³µê²©ë ¥: ìƒˆìµœì¢…ê³µê²©ë ¥
            })
            .eq('ìœ ì €UID', ìœ ì €UID);

        if (updateError) {
            return res.status(500).json({ ì˜¤ë¥˜: 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + updateError.message });
        }

        // 14) í´ë¼ì´ì–¸íŠ¸ì— ë°˜í™˜
        return res.json({
            ê²½í—˜ì¹˜: í™˜ê¸‰í›„ê²½í—˜ì¹˜,
            ë ˆë²¨: ìƒˆë ˆë²¨,
            ì „ì§ê³µê²©ë ¥: ìƒˆì „ì§ê³µê²©ë ¥,
            ë ˆë²¨ê³µê²©ë ¥: ìƒˆë ˆë²¨ê³µê²©ë ¥,
            ìµœì¢…ê³µê²©ë ¥: ìƒˆìµœì¢…ê³µê²©ë ¥,
            ìœ ë¬¼ëª©ë¡: updatedìœ ë¬¼ëª©ë¡
        });
    } catch (e) {
        return res.status(500).json({ ì˜¤ë¥˜: 'ì„œë²„ ì˜¤ë¥˜: ' + e.message });
    }
});





function ìµœê³ ì „ì§ëª…(ì „ì§ì •ë³´) {
    const ì „ì§ìˆœì„œ = ["ë°±ì¸ì¥", "ì˜¤ë°±ì¸ì¥", "ì²œì¸ì¥", "ë§Œì¸ì¥", "ë¶€ì¥êµ°", "ì¥êµ°", "ëŒ€ì¥êµ°", "ëŒ€ì‚¬ë§ˆ", "ìŠ¹ìƒ", "í›„", "ê³µ", "ì œí›„", "ì™•", "í™©ì œ", "ì²œí™©", "ì œí™©", "íƒœí™©", "ì²œì œ"];

    let ë§ˆì§€ë§‰ì§ìœ„ = null;
    for (const ì§ìœ„ of ì „ì§ìˆœì„œ) {
        if (ì „ì§ì •ë³´?.[ì§ìœ„] === 1) {
            ë§ˆì§€ë§‰ì§ìœ„ = ì§ìœ„;
        } else {
            break;
        }
    }
    return ë§ˆì§€ë§‰ì§ìœ„;
}

app.post("/gamble-Equipment", async (req, res) => {
    const { ìœ ì €UID, ì¢…ë¥˜ } = req.body;
    const ë¹„ìš© = 100000;

    try {
        // 1) ìœ ì € ì¡°íšŒ
        const { data: ìœ ì €, error } = await supabaseAdmin
            .from("users")
            .select("*")
            .eq("ìœ ì €UID", ìœ ì €UID)
            .single();
        if (error || !ìœ ì €) {
            return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });
        }

        // 2) ê³ ê¸‰Â·ì—°ì†ê³ ê¸‰ í‹°ì¼“ ì°¨ê° (í•œ ë²ˆë§Œ)
        if (ì¢…ë¥˜ === "ê³ ê¸‰") {
            const í‹°ì¼“ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["í‹°ì¼“"] || 0;
            if (í‹°ì¼“ < 1) {
                return res.status(400).json({ ì˜¤ë¥˜: "í‹°ì¼“ì´ ë¶€ì¡±í•©ë‹ˆë‹¤" });
            }
            ìœ ì €.ìœ ë¬¼ëª©ë¡["í‹°ì¼“"] = í‹°ì¼“ - 1;
        } else if (ì¢…ë¥˜ === "ì—°ì†ê³ ê¸‰") {
            const í‹°ì¼“ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["í‹°ì¼“"] || 0;
            if (í‹°ì¼“ < 10) {
                return res.status(400).json({ ì˜¤ë¥˜: "í‹°ì¼“ì´ ë¶€ì¡±í•©ë‹ˆë‹¤" });
            }
            ìœ ì €.ìœ ë¬¼ëª©ë¡["í‹°ì¼“"] = í‹°ì¼“ - 10;
        } else if (ì¢…ë¥˜ === "ì¼ë°˜") {
            if (ìœ ì €.ê³¨ë“œ < ë¹„ìš©) {
                return res.status(400).json({ ì˜¤ë¥˜: "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤" });
            }
        } else if (ì¢…ë¥˜ === "ì—°ì†ì¼ë°˜") {
            if (ìœ ì €.ê³¨ë“œ < 10 * ë¹„ìš©) {
                return res.status(400).json({ ì˜¤ë¥˜: "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤" });
            }
        }

        let íšŸìˆ˜;
        if (ì¢…ë¥˜ === "ì—°ì†ê³ ê¸‰") {
            íšŸìˆ˜ = 11;                           // â† 11íšŒ ë½‘ê¸°
        } else if (ì¢…ë¥˜ === "ì—°ì†ì¼ë°˜") {
            íšŸìˆ˜ = 10;
        } else {
            íšŸìˆ˜ = 1;
        }

        const results = [];

        // 4) ë“œë ë¡œì§ ë°˜ë³µ ì²˜ë¦¬
        for (let i = 0; i < íšŸìˆ˜; i++) {
            let í¼ì¦ë°œë™ = false;
            if (ì¢…ë¥˜ === "ì¼ë°˜" || ì¢…ë¥˜ === "ì—°ì†ì¼ë°˜") {
                const í¼ì¦ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["í¼ì¦"] || 0;
                í¼ì¦ë°œë™ = Math.random() < 0.001 * í¼ì¦;  // í¼ì¦ ë°œë™ ì—¬ë¶€ ê²°ì •

                if (!í¼ì¦ë°œë™) {
                    if (ìœ ì €.ê³¨ë“œ < ë¹„ìš©) {
                        return res.status(400).json({ ì˜¤ë¥˜: "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤" });
                    }
                    ìœ ì €.ê³¨ë“œ -= ë¹„ìš©;
                }
            }

            const í´ë¡œë²„ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["í´ë¡œë²„"] || 0;
            const ë³´ì • = 1 + 0.001 * í´ë¡œë²„;
            let í™•ë¥ í‘œ;
            if (ì¢…ë¥˜ === "ê³ ê¸‰" || ì¢…ë¥˜ === "ì—°ì†ê³ ê¸‰") {
                í™•ë¥ í‘œ = [
                    { ë“±ê¸‰: "íƒ€ë½", í™•ë¥ : ë³´ì • * (1 - Math.pow(1 - 1 / 25600, 500)) },
                    { ë“±ê¸‰: "íƒœì´ˆ", í™•ë¥ : ë³´ì • * (1 - Math.pow(1 - 1 / 12800, 500)) },
                    { ë“±ê¸‰: "ê³ ëŒ€", í™•ë¥ : ë³´ì • * (1 - Math.pow(1 - 1 / 6400, 500)) },
                    { ë“±ê¸‰: "ì‹ í™”", í™•ë¥ : ë³´ì • * (1 - Math.pow(1 - 1 / 3200, 500)) },
                    { ë“±ê¸‰: "ë ˆì–´", í™•ë¥ : ë³´ì • * (1 - Math.pow(1 - 1 / 1600, 500)) }
                ];
            } else {
                í™•ë¥ í‘œ = [
                    { ë“±ê¸‰: "íƒœì´ˆ", í™•ë¥ : ë³´ì • * (1 - Math.pow(1 - 1 / 12800, 500)) },
                    { ë“±ê¸‰: "ê³ ëŒ€", í™•ë¥ : ë³´ì • * (1 - Math.pow(1 - 1 / 6400, 500)) },
                    { ë“±ê¸‰: "ì‹ í™”", í™•ë¥ : ë³´ì • * (1 - Math.pow(1 - 1 / 3200, 500)) },
                    { ë“±ê¸‰: "ë ˆì–´", í™•ë¥ : ë³´ì • * (1 - Math.pow(1 - 1 / 1600, 500)) },
                    { ë“±ê¸‰: "ì¼ë°˜", í™•ë¥ : ë³´ì • * (1 - Math.pow(1 - 1 / 800, 500)) }
                ];
            }

            // 4-3) ëœë¤ìœ¼ë¡œ ë“±ê¸‰ ì„ íƒ
            let r = Math.random(), ëˆ„ì  = 0;
            let ë½‘íŒë“±ê¸‰ = í™•ë¥ í‘œ[í™•ë¥ í‘œ.length - 1].ë“±ê¸‰;
            for (const í•­ëª© of í™•ë¥ í‘œ) {
                ëˆ„ì  += í•­ëª©.í™•ë¥ ;
                if (r < ëˆ„ì ) {
                    ë½‘íŒë“±ê¸‰ = í•­ëª©.ë“±ê¸‰;
                    break;
                }
            }

            // 4-4) ì¥ë¹„ ë“œëÂ·í•©ì„±
            const ì¥ë¹„ë§µ = {
                "ì¼ë°˜": { ì´ë¦„: "ë¦´ë¦¬íŠ¸ì˜ ë…ë‹ˆ", ê³µê²©ë ¥: 30 },
                "ë ˆì–´": { ì´ë¦„: "ë””ì•„ë¸”ë¡œì˜ ë¿”", ê³µê²©ë ¥: 63 },
                "ì‹ í™”": { ì´ë¦„: "ë ˆë¹„ì•„íƒ„ì˜ ë¹„ëŠ˜", ê³µê²©ë ¥: 132 },
                "ê³ ëŒ€": { ì´ë¦„: "ë²¨ì œë¶€ë¸Œì˜ ê¼¬ë¦¬", ê³µê²©ë ¥: 276 },
                "íƒœì´ˆ": { ì´ë¦„: "ì‚¬íƒ„ì˜ ë‚ ê°œ", ê³µê²©ë ¥: 576 },
                "íƒ€ë½": { ì´ë¦„: "ë£¨ì‹œí¼ì˜ ì‹¬ì¥", ê³µê²©ë ¥: 1200 }
            };
            const ë“œëì¥ë¹„ = ì¥ë¹„ë§µ[ë½‘íŒë“±ê¸‰];

            const ì¥ë¹„ëª©ë¡ = ìœ ì €.ì¥ë¹„ëª©ë¡ || [];
            const í‚¤ = `${ë“œëì¥ë¹„.ì´ë¦„}|${ë½‘íŒë“±ê¸‰}`;
            let ê¸°ì¡´ = ì¥ë¹„ëª©ë¡.find(e => e.ì´ë¦„ === ë“œëì¥ë¹„.ì´ë¦„ && e.ë“±ê¸‰ === ë½‘íŒë“±ê¸‰);
            let ì²´ë ¥ì¦ê°€ = 0;

            if (ê¸°ì¡´) {
                ê¸°ì¡´.ìˆ˜ëŸ‰++;
            } else {
                ì¥ë¹„ëª©ë¡.push({
                    ì´ë¦„: ë“œëì¥ë¹„.ì´ë¦„,
                    ë“±ê¸‰: ë½‘íŒë“±ê¸‰,
                    ê³µê²©ë ¥: ë“œëì¥ë¹„.ê³µê²©ë ¥,
                    ê°•í™”: 0,
                    ìˆ˜ëŸ‰: 0
                });
            }

            ìœ ì €.ì¥ë¹„ëª©ë¡ = ì¥ë¹„ëª©ë¡;
            const maxê³µê²©ë ¥ = Math.max(...ì¥ë¹„ëª©ë¡.map(e => e.ê³µê²©ë ¥));
            ìœ ì €.ì¥ë¹„ê³µê²©ë ¥ = maxê³µê²©ë ¥;

            // ìœ ì €.ì¥ë¹„ê³µê²©ë ¥ = (ìœ ì €.ì¥ë¹„ê³µê²©ë ¥ || 0) + ë“œëì¥ë¹„.ê³µê²©ë ¥;
            ìœ ì €.ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìœ ì €);



            if (ë½‘íŒë“±ê¸‰ === "íƒœì´ˆ" || ë½‘íŒë“±ê¸‰ === "íƒ€ë½") {
                const ë¬¸êµ¬ = `${ë“œëì¥ë¹„.ì´ë¦„}(ì„)ë¥¼ íšë“í–ˆë‹¤!`;
                await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
                    ìœ ì €UID: ìœ ì €.ìœ ì €UID,
                    ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
                    ë¬¸êµ¬
                });
            }

            results.push({
                ì¥ë¹„: { ...ë“œëì¥ë¹„, ë“±ê¸‰: ë½‘íŒë“±ê¸‰ },
                í¼ì¦ë°œë™,
                ë‚¨ì€ê³¨ë“œ: ìœ ì €.ê³¨ë“œ,
                ë‚¨ì€í‹°ì¼“: ìœ ì €.ìœ ë¬¼ëª©ë¡?.["í‹°ì¼“"] || 0
            });
        }





        await supabaseAdmin
            .from("users")
            .update({
                ê³¨ë“œ: ìœ ì €.ê³¨ë“œ,
                ìœ ë¬¼ëª©ë¡: ìœ ì €.ìœ ë¬¼ëª©ë¡,
                ì¥ë¹„ëª©ë¡: ìœ ì €.ì¥ë¹„ëª©ë¡,
                ì¥ë¹„ê³µê²©ë ¥: ìœ ì €.ì¥ë¹„ê³µê²©ë ¥,
                ìµœëŒ€ì²´ë ¥: ìœ ì €.ìµœëŒ€ì²´ë ¥,
                ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥
            })
            .eq("ìœ ì €UID", ìœ ì €UID);

        return res.json({ ìœ ì €ë°ì´í„°: ìœ ì €, results });
    } catch (e) {
        console.error(e);
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤" });
    }
});


app.post("/gamble-Relic", async (req, res) => {
    const { ìœ ì €UID, ì¢…ë¥˜ = "ì¼ë°˜" } = req.body;
    const ë¹„ìš© = 100000;
    const maxCounts = {
        "í”Œë¼ì›Œ": 9,
        "ë¼ˆë‹¤êµ¬": 9,
        "ì—´ì‡ ": 9,
        "ìŠ¤í”¼ì»¤": 9,
        "ì•ˆê²½": 9,
        "ìƒëŸ¬ë“œ": 0,
        "ìŠ¤í”¼ì»¤": 0,
    };
    try {
        const { data: ìœ ì €, error } = await supabaseAdmin
            .from("users")
            .select("*")
            .eq("ìœ ì €UID", ìœ ì €UID)
            .single();

        if (error || !ìœ ì €) {
            return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });
        }

        const í›„ë³´ = Object.keys(ë ˆì–´ìœ ë¬¼ë°ì´í„°).filter(ì´ë¦„ => {
            const ë³´ìœ  = ìœ ì €.ìœ ë¬¼ëª©ë¡?.[ì´ë¦„] || 0;
            const max = maxCounts[ì´ë¦„] ?? 99;
            return ë³´ìœ  < max;
        });

        if (í›„ë³´.length === 0) {
            return res.status(400).json({ ì˜¤ë¥˜: "ë” ì´ìƒ íšë“ ê°€ëŠ¥í•œ ìœ ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤" });
        }

        const íšŸìˆ˜ = ì¢…ë¥˜ === "ì—°ì†ì¼ë°˜" ? 10 : 1;
        const results = [];

        if (ì¢…ë¥˜ === "ì¼ë°˜") {
            if (ìœ ì €.ê³¨ë“œ < ë¹„ìš©) {
                return res.status(400).json({ ì˜¤ë¥˜: "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤" });
            }
        } else if (ì¢…ë¥˜ === "ì—°ì†ì¼ë°˜") {
            if (ìœ ì €.ê³¨ë“œ < 10 * ë¹„ìš©) {
                return res.status(400).json({ ì˜¤ë¥˜: "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤" });
            }
        }

        for (let i = 0; i < íšŸìˆ˜; i++) {
            const í¼ì¦ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["í¼ì¦"] || 0;
            const í¼ì¦ë°œë™ = Math.random() < 0.001 * í¼ì¦;

            if (!í¼ì¦ë°œë™) {
                ìœ ì €.ê³¨ë“œ -= ë¹„ìš©;
            }

            // 3) ëœë¤ìœ¼ë¡œ ìœ ë¬¼ ì„ íƒ
            const ìœ ë¬¼ì´ë¦„ = í›„ë³´[Math.floor(Math.random() * í›„ë³´.length)];

            // 4) ìœ ë¬¼ëª©ë¡ ì—…ë°ì´íŠ¸ (ìµœëŒ€ 99ê°œê¹Œì§€)
            const ìœ ë¬¼ëª©ë¡ë³µì‚¬ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡ };
            ìœ ë¬¼ëª©ë¡ë³µì‚¬[ìœ ë¬¼ì´ë¦„] = (ìœ ë¬¼ëª©ë¡ë³µì‚¬[ìœ ë¬¼ì´ë¦„] || 0) + 1;

            // await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `${ìœ ë¬¼ì´ë¦„} íšë“`);

            // 5) ê²°ê³¼ ë°°ì—´ì— ì €ì¥
            results.push({
                ìœ ë¬¼ì´ë¦„,
                í¼ì¦ë°œë™,
                ë‚¨ì€ê³¨ë“œ: ìœ ì €.ê³¨ë“œ,
            });

            const max = maxCounts[ìœ ë¬¼ì´ë¦„] ?? 99;
            if (ìœ ë¬¼ëª©ë¡ë³µì‚¬[ìœ ë¬¼ì´ë¦„] >= max) {
                const idx = í›„ë³´.indexOf(ìœ ë¬¼ì´ë¦„);
                if (idx !== -1) í›„ë³´.splice(idx, 1);
            }

            // 7) ìœ ì € ê°ì²´ì—ë„ ìœ ë¬¼ëª©ë¡ ë°˜ì˜
            ìœ ì €.ìœ ë¬¼ëª©ë¡ = ìœ ë¬¼ëª©ë¡ë³µì‚¬;


            // await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `${ìœ ë¬¼ì´ë¦„} ë½‘ê¸°ë¡œ íšë“ =${ìœ ë¬¼ëª©ë¡ë³µì‚¬[ìœ ë¬¼ì´ë¦„]}`);

            // 8) ë” ì´ìƒ í›„ë³´ê°€ ì—†ìœ¼ë©´ ë°˜ë³µ ì¢…ë£Œ
            if (í›„ë³´.length === 0) break;
        }

        // 9) DBì— ìœ ì € ì •ë³´(ê³¨ë“œ, ìœ ë¬¼ëª©ë¡) ì—…ë°ì´íŠ¸
        await supabaseAdmin
            .from("users")
            .update({
                ê³¨ë“œ: ìœ ì €.ê³¨ë“œ,
                ìœ ë¬¼ëª©ë¡: ìœ ì €.ìœ ë¬¼ëª©ë¡,
            })
            .eq("ìœ ì €UID", ìœ ì €UID);

        // 10) ì‘ë‹µìœ¼ë¡œ ìµœì‹  ìœ ì €ë°ì´í„°ì™€ ê²°ê³¼ ë°°ì—´ ì „ë‹¬
        const ìœ ì €ë°ì´í„° = {
            ...ìœ ì €,
            ê³¨ë“œ: ìœ ì €.ê³¨ë“œ,
            ìœ ë¬¼ëª©ë¡: ìœ ì €.ìœ ë¬¼ëª©ë¡,
        };


        return res.json({
            ê²°ê³¼: "ì„±ê³µ",
            ìœ ì €ë°ì´í„°,
            results,
        });
    } catch (e) {
        console.error(e);
        return res.status(500).json({
            ì˜¤ë¥˜: "ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
        });
    }
});






app.post('/synthesize-item', async (req, res) => {
    const { ìœ ì €UID } = req.body;
    if (!ìœ ì €UID) {
        return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });
    }

    // í•„ìš”í•œ í•„ë“œ í•¨ê»˜ ì¡°íšŒ
    const { data: user, error: fetchError } = await supabaseAdmin
        .from('users')
        .select('ìœ ì €ì•„ì´ë””, ì¥ë¹„ëª©ë¡, ë ˆë²¨ê³µê²©ë ¥, ì „ì§ê³µê²©ë ¥, í«ë‹¨ê³„, ìœ ë¬¼ëª©ë¡')
        .eq('ìœ ì €UID', ìœ ì €UID)
        .single();
    if (fetchError || !user) {
        return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });
    }
    let equipmentList = user.ì¥ë¹„ëª©ë¡ || [];

    const gradeOrder = ['ì¼ë°˜', 'ë ˆì–´', 'ì‹ í™”', 'ê³ ëŒ€', 'íƒœì´ˆ', 'íƒ€ë½'];
    const gradeMap = {
        ì¼ë°˜: { ì´ë¦„: 'ë¦´ë¦¬íŠ¸ì˜ ë…ë‹ˆ', ê³µê²©ë ¥: 30 },
        ë ˆì–´: { ì´ë¦„: 'ë””ì•„ë¸”ë¡œì˜ ë¿”', ê³µê²©ë ¥: 63 },
        ì‹ í™”: { ì´ë¦„: 'ë ˆë¹„ì•„íƒ„ì˜ ë¹„ëŠ˜', ê³µê²©ë ¥: 132 },
        ê³ ëŒ€: { ì´ë¦„: 'ë²¨ì œë¶€ë¸Œì˜ ê¼¬ë¦¬', ê³µê²©ë ¥: 276 },
        íƒœì´ˆ: { ì´ë¦„: 'ì‚¬íƒ„ì˜ ë‚ ê°œ', ê³µê²©ë ¥: 576 },
        íƒ€ë½: { ì´ë¦„: 'ë£¨ì‹œí¼ì˜ ì‹¬ì¥', ê³µê²©ë ¥: 1200 }
    };

    for (let i = 0; i < gradeOrder.length - 1; i++) {
        const currentGrade = gradeOrder[i];
        const nextGrade = gradeOrder[i + 1];
        const currentItem = equipmentList.find(item => item.ë“±ê¸‰ === currentGrade);
        const nextItem = equipmentList.find(item => item.ë“±ê¸‰ === nextGrade);
        const currentQty = currentItem ? currentItem.ìˆ˜ëŸ‰ : 0;
        const synthCount = Math.floor(currentQty / 3);
        if (synthCount > 0) {
            // í•˜ìœ„ ì¥ë¹„ ìˆ˜ëŸ‰ ì°¨ê°
            currentItem.ìˆ˜ëŸ‰ -= synthCount * 3;



            if (nextItem) {
                // ê¸°ì¡´ ìƒìœ„ ì¥ë¹„ ìˆ˜ëŸ‰ ì¦ê°€
                nextItem.ìˆ˜ëŸ‰ += synthCount;
            } else {
                // ì‹ ê·œ ìƒìœ„ ì¥ë¹„ ìƒì„± ì‹œ ìˆ˜ìˆ˜ë£Œ 1ê°œ ì œí•˜ê³  ìƒì„±
                const createdQty = synthCount > 0 ? synthCount - 1 : 0;
                equipmentList.push({
                    ì´ë¦„: gradeMap[nextGrade].ì´ë¦„,
                    ê³µê²©ë ¥: gradeMap[nextGrade].ê³µê²©ë ¥,
                    ë“±ê¸‰: nextGrade,
                    ê°•í™”: 0,
                    ìˆ˜ëŸ‰: createdQty
                });


            }


            if ((nextGrade === "íƒœì´ˆ" || nextGrade === "íƒ€ë½")) {
                const ë¬¸êµ¬ = `${gradeMap[nextGrade].ì´ë¦„}(ì„)ë¥¼ í•©ì„±í–ˆë‹¤!`;
                await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
                    ìœ ì €UID,
                    ìœ ì €ì•„ì´ë””: user.ìœ ì €ì•„ì´ë””,
                    ë¬¸êµ¬
                });

                // await ë¡œê·¸ê¸°ë¡(user.ìœ ì €ì•„ì´ë””, `${gradeMap[nextGrade].ì´ë¦„}ì„(ë¥¼) í•©ì„±í–ˆë‹¤`);

            }
        }
    }

    // ì¥ë¹„ê³µê²©ë ¥(ìµœëŒ“ê°’) ê³„ì‚°
    const ì¥ë¹„ê³µê²©ë ¥ = equipmentList.reduce(
        (maxAttack, item) => item.ê³µê²©ë ¥ > maxAttack ? item.ê³µê²©ë ¥ : maxAttack,
        0
    );
    // ìœ ì € ê°ì²´ì— ì¥ë¹„ê³µê²©ë ¥ ë°˜ì˜
    user.ì¥ë¹„ê³µê²©ë ¥ = ì¥ë¹„ê³µê²©ë ¥;
    // ìµœì¢…ê³µê²©ë ¥ ê³„ì‚° í•¨ìˆ˜ ì‚¬ìš©
    const ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(user);

    // DB ì—…ë°ì´íŠ¸
    const { error: updateError } = await supabaseAdmin
        .from('users')
        .update({ ì¥ë¹„ëª©ë¡: equipmentList, ì¥ë¹„ê³µê²©ë ¥, ìµœì¢…ê³µê²©ë ¥ })
        .eq('ìœ ì €UID', ìœ ì €UID);
    if (updateError) {
        return res.status(500).json({ ì˜¤ë¥˜: 'ì„œë²„ ì˜¤ë¥˜ë¡œ í•©ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
    }

    return res.json({ ì¥ë¹„ëª©ë¡: equipmentList, ì¥ë¹„ê³µê²©ë ¥, ìµœì¢…ê³µê²©ë ¥ });
});








app.post("/upgrade-corrupted-item", async (req, res) => {
    const { ìœ ì €UID, ì´ë¦„, ë“±ê¸‰ } = req.body;
    if (!ìœ ì €UID || !ì´ë¦„ || !ë“±ê¸‰) {
        return res.status(400).json({ ì˜¤ë¥˜: "í•„ìˆ˜ ê°’ ëˆ„ë½" });
    }

    const { data: ìœ ì €, error: userErr } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();
    if (userErr || !ìœ ì €) {
        return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });
    }

    const ì¥ë¹„ëª©ë¡ = ìœ ì €.ì¥ë¹„ëª©ë¡ || [];
    const ëŒ€ìƒ = ì¥ë¹„ëª©ë¡.find(e => e.ì´ë¦„ === ì´ë¦„ && e.ë“±ê¸‰ === ë“±ê¸‰);
    if (!ëŒ€ìƒ) {
        return res.status(404).json({ ì˜¤ë¥˜: "ì¥ë¹„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ" });
    }
    if (ë“±ê¸‰ !== "íƒ€ë½") {
        return res.status(400).json({ ì˜¤ë¥˜: "íƒ€ë½ ì¥ë¹„ë§Œ ê°•í™” ê°€ëŠ¥í•©ë‹ˆë‹¤" });
    }
    if ((ëŒ€ìƒ.ìˆ˜ëŸ‰ || 0) < 1) {
        return res.status(400).json({ ì˜¤ë¥˜: "ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤" });
    }
    const current = ëŒ€ìƒ.ê°•í™” || 0;

    // âŒ 11ê°• ì´ìƒ ì°¨ë‹¨
    if (current > 10) {
        return res.status(400).json({ ì˜¤ë¥˜: "ë” ì´ìƒ ê°•í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" });
    }

    let successRate;

    if (current === 10) {
        // 10ê°•ì¼ ë•ŒëŠ” ë¬´ì¡°ê±´ 1%
        successRate = 1;

        const íœíƒ€ê·¸ë¨ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["íœíƒ€ê·¸ë¨"] || 0;
        const íœíƒ€ê·¸ë¨ë³´ì • = íœíƒ€ê·¸ë¨ê°œìˆ˜ * 0.01;
        successRate += íœíƒ€ê·¸ë¨ë³´ì •;

    } else {
        // ì¼ë°˜ ê°•í™”ëŠ” ë³´ì • í¬í•¨
        successRate = 100 - current * 10;

        const ë§ì¹˜ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ë§ì¹˜"] || 0;
        const ë§ì¹˜ë³´ì • = ë§ì¹˜ê°œìˆ˜ * 0.1;
        successRate += ë§ì¹˜ë³´ì •;

        const ì‹¤íŒ¨ì¹´ìš´íŠ¸ë³´ì • = Math.min(ìœ ì €.ì‹¤íŒ¨ì¹´ìš´íŠ¸ || 0, 20);
        successRate += ì‹¤íŒ¨ì¹´ìš´íŠ¸ë³´ì •;

        if (successRate > 100) successRate = 100;
    }


    if (Math.random() * 100 > successRate) {

        const ëª¨ë£¨ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ëª¨ë£¨"] || 0;
        const ëª¨ë£¨í™•ë¥  = ëª¨ë£¨ê°œìˆ˜ * 0.1; // ì˜ˆ: 5ê°œë©´ 0.5%

        const ì¬ë£Œì†Œëª¨ë¬´ì‹œ = Math.random() * 100 < ëª¨ë£¨í™•ë¥ ;

        if (!ì¬ë£Œì†Œëª¨ë¬´ì‹œ) {
            ëŒ€ìƒ.ìˆ˜ëŸ‰ -= 1;
        }

        const ì‹¤íŒ¨ì¹´ìš´íŠ¸ = (ìœ ì €.ì‹¤íŒ¨ì¹´ìš´íŠ¸ || 0) + 1;

        const { error: updFailErr } = await supabaseAdmin
            .from("users")
            .update({ ì¥ë¹„ëª©ë¡, ì‹¤íŒ¨ì¹´ìš´íŠ¸ })
            .eq("ìœ ì €UID", ìœ ì €UID);
        if (updFailErr) {
            return res.status(500).json({ ì˜¤ë¥˜: "ê°•í™” ì‹¤íŒ¨ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ" });
        }

        // await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `ë£¨ì‹œí¼ì˜ ì‹¬ì¥ +${ëŒ€ìƒ.ê°•í™” + 1}ê°• ì‹¤íŒ¨`);

        const ë¬¸êµ¬ = (current === 10)
            ? `ë£¨ì‹œí¼ì˜ ì‹¬ì¥ ì§„í™” ì‹¤íŒ¨..`
            : `ë£¨ì‹œí¼ì˜ ì‹¬ì¥ +${ëŒ€ìƒ.ê°•í™” + 1}ê°• ì‹¤íŒ¨..`;

        await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
            ìœ ì €UID: ìœ ì €.ìœ ì €UID,
            ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
            ë¬¸êµ¬
        });
        return res.status(400).json({
            ì˜¤ë¥˜: `ê°•í™” ì‹¤íŒ¨. ì¬ë£Œê°€ ì¦ë°œí–ˆìŠµë‹ˆë‹¤`,
            ìˆ˜ëŸ‰: ëŒ€ìƒ.ìˆ˜ëŸ‰,
            ì‹¤íŒ¨ì¹´ìš´íŠ¸
        });
    }

    ëŒ€ìƒ.ìˆ˜ëŸ‰ -= 1;

    if (current === 10) {
        const ê¸°ì¡´ = ì¥ë¹„ëª©ë¡.find(e => e.ì´ë¦„ === "ë² íˆëª¨ìŠ¤ì˜ í—ˆë¬¼" && e.ë“±ê¸‰ === "ì§„í™”");
        if (ê¸°ì¡´) {
            ê¸°ì¡´.ìˆ˜ëŸ‰ = (ê¸°ì¡´.ìˆ˜ëŸ‰ || 0) + 1;
        } else {
            ì¥ë¹„ëª©ë¡.push({
                ì´ë¦„: "ë² íˆëª¨ìŠ¤ì˜ í—ˆë¬¼",
                ë“±ê¸‰: "ì§„í™”",
                ê°•í™”: 0,
                ê³µê²©ë ¥: 10000,
                ìˆ˜ëŸ‰: 0
            });
        }

        // âœ… ë£¨ì‹œí¼ ì´ˆê¸°í™”
        ëŒ€ìƒ.ê°•í™” = 0;
        ëŒ€ìƒ.ê³µê²©ë ¥ = 1200;
    }
    else {
        // ì¼ë°˜ ê°•í™” ì„±ê³µ
        ëŒ€ìƒ.ê°•í™” = current + 1;

        const ê¸°ì¤€ê³µê²©ë ¥ = 1200;
        const ì¦ê°€ë¹„ìœ¨ = ëŒ€ìƒ.ê°•í™” / 10;
        ëŒ€ìƒ.ê³µê²©ë ¥ += ê¸°ì¤€ê³µê²©ë ¥ * ì¦ê°€ë¹„ìœ¨;
    }

    const maxAtk = Math.max(...ì¥ë¹„ëª©ë¡.map(e => e.ê³µê²©ë ¥));
    ìœ ì €.ì¥ë¹„ê³µê²©ë ¥ = maxAtk;
    ìœ ì €.ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìœ ì €);

    const { error: updErr1 } = await supabaseAdmin
        .from("users")
        .update({ ì¥ë¹„ëª©ë¡, ì¥ë¹„ê³µê²©ë ¥: ìœ ì €.ì¥ë¹„ê³µê²©ë ¥, ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥ })
        .eq("ìœ ì €UID", ìœ ì €UID);
    if (updErr1) {
        return res.status(500).json({ ì˜¤ë¥˜: "ê°•í™” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ" });
    }

    // if (current === 10) {
    //     await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `ë£¨ì‹œí¼ì˜ ì‹¬ì¥ ì§„í™” ì„±ê³µ`);

    // } else {
    //     await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `ë£¨ì‹œí¼ì˜ ì‹¬ì¥ +${ëŒ€ìƒ.ê°•í™”}ê°•ì— ì„±ê³µ`);

    // }


    const ë¬¸êµ¬ = (current === 10)
        ? `ë£¨ì‹œí¼ì˜ ì‹¬ì¥ì„ ì§„í™”ì‹œì¼œ ë² íˆëª¨ìŠ¤ì˜ í—ˆë¬¼ íšë“!`
        : `ë£¨ì‹œí¼ì˜ ì‹¬ì¥ +${ëŒ€ìƒ.ê°•í™”}ê°•ì— ì„±ê³µí–ˆë‹¤!`;

    await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
        ìœ ì €UID: ìœ ì €.ìœ ì €UID,
        ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
        ë¬¸êµ¬
    });

    res.json({
        ì´ë¦„: ëŒ€ìƒ.ì´ë¦„,
        ë“±ê¸‰: ëŒ€ìƒ.ë“±ê¸‰,
        ìˆ˜ëŸ‰: ëŒ€ìƒ.ìˆ˜ëŸ‰,
        ê°•í™”: ëŒ€ìƒ.ê°•í™”,
        ê³µê²©ë ¥: ëŒ€ìƒ.ê³µê²©ë ¥,
        ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥,
        ìœ ì €ë°ì´í„°: {
            ...ìœ ì €,
            ì¥ë¹„ëª©ë¡,
            ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥
        }
    });
});







app.post("/attack-dungeon", async (req, res) => {
    const { ìœ ì €UID } = req.body;
    if (!ìœ ì €UID) return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();
    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });



    const ì—´ì‡  = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ì—´ì‡ "] || 0;
    if (ì—´ì‡  < 1) {
        return res.status(400).json({ ì˜¤ë¥˜: "ì—´ì‡ ê°€ í•„ìš”í•©ë‹ˆë‹¤" });
    }


    const level = ìœ ì €.ì§€í•˜ë˜ì „;
    const ëª¬ìŠ¤í„° = {
        ì´ë¦„: `???`,
        ì²´ë ¥: 5000 * level,
        ë°©ì–´ë ¥: 500 * level
    };

    ìœ ì €.ë‚¨ì€ì²´ë ¥ = ìœ ì €.ìµœëŒ€ì²´ë ¥;

    let í˜„ì¬í„´ = 1;

    const ì „íˆ¬ë¡œê·¸ = [];
    const ê²°ê³¼ = ì „íˆ¬ì‹œë®¬ë ˆì´ì…˜(ìœ ì €, ëª¬ìŠ¤í„°, ì „íˆ¬ë¡œê·¸, í˜„ì¬í„´);

    let ìƒˆë¡œìš´ë ˆë²¨ = level;
    let ë“œëí‹°ì¼“ = false;
    if (ê²°ê³¼.ê²°ê³¼ === "ìŠ¹ë¦¬") {
        ìƒˆë¡œìš´ë ˆë²¨ = level + 1;
        const oldTickets = Number(ìœ ì €.ìœ ë¬¼ëª©ë¡?.í‹°ì¼“ || 0);
        ìœ ì €.ìœ ë¬¼ëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡, í‹°ì¼“: oldTickets + 1 };
        ë“œëí‹°ì¼“ = true;
    }


    ìœ ì €.ìœ ë¬¼ëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡, ì—´ì‡ : ì—´ì‡  - 1 };

    await supabaseAdmin
        .from("users")
        .update({
            ì§€í•˜ë˜ì „: ìƒˆë¡œìš´ë ˆë²¨,
            ìœ ë¬¼ëª©ë¡: ìœ ì €.ìœ ë¬¼ëª©ë¡
        })
        .eq("ìœ ì €UID", ìœ ì €UID);

    return res.json({
        ê²°ê³¼: ê²°ê³¼.ê²°ê³¼,
        ìƒˆë¡œìš´ë ˆë²¨,
        ëª¬ìŠ¤í„°,
        ë“œëí‹°ì¼“,
        ìœ ë¬¼ëª©ë¡: ìœ ì €.ìœ ë¬¼ëª©ë¡,
        ì „íˆ¬ë¡œê·¸,
        ìœ ì €ë°ì´í„°: { ...ìœ ì € },

    });
});



app.post("/get-chat", async (req, res) => {
    try {
        const { data: ì±„íŒ…, error } = await supabaseAdmin
            .from("ê´‘ì¥")
            .select("ìœ ì €ì•„ì´ë””, ë‚´ìš©, ì‹œê°, ë§ˆë²•ì˜íŒ”ë ˆíŠ¸")
            .order("ì‹œê°", { ascending: false })
            .limit(50);


        if (error) {
            console.error("ì¿¼ë¦¬ ì˜¤ë¥˜:", error);
            return res.status(500).json({ ì˜¤ë¥˜: error.message });
        }

        return res.json({ ì±„íŒ… });
    } catch (e) {
        console.error("ì±„íŒ… ë¡œë“œ ì˜¤ë¥˜:", e);
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ" });
    }
});



app.post("/save-chat", async (req, res) => {
    const { ìœ ì €UID, ìœ ì €ì•„ì´ë””, ë©”ì‹œì§€ } = req.body;
    if (!ìœ ì €UID || !ìœ ì €ì•„ì´ë”” || !ë©”ì‹œì§€) {
        return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID / ìœ ì €ì•„ì´ë”” / ë©”ì‹œì§€ ëˆ„ë½" });
    }

    const { data: ìœ ì €, error: userErr } = await supabaseAdmin
        .from("users")
        .select("ìœ ë¬¼ëª©ë¡, ë§ˆë²•ì˜íŒ”ë ˆíŠ¸")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (userErr || !ìœ ì €) {
        return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });
    }

    const ìœ ë¬¼ëª©ë¡ = ìœ ì €.ìœ ë¬¼ëª©ë¡ || {};
    const ìŠ¤í”¼ì»¤ = ìœ ë¬¼ëª©ë¡["ìŠ¤í”¼ì»¤"] || 0;

    if (ìŠ¤í”¼ì»¤ < 1) {
        return res.status(400).json({ ì˜¤ë¥˜: "ìŠ¤í”¼ì»¤ê°€ ì—†ìŠµë‹ˆë‹¤" });
    }

    // 1ê°œ ì°¨ê°
    ìœ ë¬¼ëª©ë¡["ìŠ¤í”¼ì»¤"] = ìŠ¤í”¼ì»¤ - 1;

    try {
        // 1) ê´‘ì¥ í…Œì´ë¸”ì— ë©”ì‹œì§€ ì €ì¥
        const { error: insertErr } = await supabaseAdmin
            .from("ê´‘ì¥")
            .insert([{
                ìœ ì €ì•„ì´ë””,
                ë‚´ìš©: ë©”ì‹œì§€,
                ë§ˆë²•ì˜íŒ”ë ˆíŠ¸: ìœ ì €.ë§ˆë²•ì˜íŒ”ë ˆíŠ¸ || ""
            }]);

        if (insertErr) {
            console.error("ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨:", insertErr);
            return res.status(500).json({ ì˜¤ë¥˜: insertErr.message });
        }

        // 2) ìœ ì € í…Œì´ë¸”ì—ì„œ ìŠ¤í”¼ì»¤ -1 ë°˜ì˜
        const { error: updateErr } = await supabaseAdmin
            .from("users")
            .update({ ìœ ë¬¼ëª©ë¡ })
            .eq("ìœ ì €UID", ìœ ì €UID);

        if (updateErr) {
            console.error("ìŠ¤í”¼ì»¤ ì°¨ê° ì‹¤íŒ¨:", updateErr);
            return res.status(500).json({ ì˜¤ë¥˜: updateErr.message });
        }

        return res.json({
            ì„±ê³µ: true,
            ìœ ë¬¼ëª©ë¡  // â† í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•¨ê»˜ ì „ì†¡
        });

    } catch (e) {
        console.error("ì„œë²„ ì˜¤ë¥˜:", e);
        return res.status(500).json({ ì˜¤ë¥˜: "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ" });
    }
});



app.post("/get-events", async (req, res) => {
    const { data, error } = await supabaseAdmin
        .from("ì´ë²¤íŠ¸ê¸°ë¡")
        .select("ìœ ì €ì•„ì´ë””, ì¼ì–´ë‚œì¼, ì¼ì–´ë‚œì¼ì‹œê°")
        .neq("ìœ ì €ì•„ì´ë””", "í…ŒìŠ¤íŠ¸ì•„ì´ë””")
        .order("ì¼ì–´ë‚œì¼ì‹œê°", { ascending: false })
        .limit(50);

    if (error) {
        return res.status(500).json({ ì˜¤ë¥˜: "ì¡°íšŒ ì‹¤íŒ¨", ìƒì„¸: error.message });
    }

    res.json({ ê¸°ë¡: data });
});




app.post("/obtain-accessory", async (req, res) => {
    const { ìœ ì €UID, ì´ë¦„ } = req.body;
    if (!ìœ ì €UID || !ì´ë¦„) return res.status(400).json({ ì˜¤ë¥˜: "í•„ìˆ˜ ì •ë³´ ëˆ„ë½" });

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì—†ìŒ" });

    const ëª©ë¡ = ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ëª©ë¡ || [];

    if (ëª©ë¡.find(a => a.ì´ë¦„ === ì´ë¦„)) {
        return res.status(400).json({ ì˜¤ë¥˜: "ì´ë¯¸ ë³´ìœ  ì¤‘" });
    }

    // âœ… ê³¨ë“œ ì²´í¬
    if ((ìœ ì €.ê³¨ë“œ || 0) < 1000000) {
        return res.status(400).json({ ì˜¤ë¥˜: "ê³¨ë“œ ë¶€ì¡±" });
    }

    // âœ… ê³¨ë“œ ì°¨ê°
    const ì°¨ê°ëœê³¨ë“œ = ìœ ì €.ê³¨ë“œ - 1000000;

    ëª©ë¡.push({
        ì´ë¦„,
        ë“±ê¸‰: 1,
        ê°•í™”: 0,
        ì¥ì°©: 0
    });

    const ë¬¸êµ¬ = `ì•…ì„¸ì‚¬ë¦¬ ${ì´ë¦„}(ì„)ë¥¼ íšë“í–ˆë‹¤!`;
    await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
        ìœ ì €UID: ìœ ì €.ìœ ì €UID,
        ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
        ë¬¸êµ¬
    });

    // await ë¡œê·¸ê¸°ë¡(ìœ ì €.ìœ ì €ì•„ì´ë””, `${ì´ë¦„} ìŠµë“`);


    const { error: ì—…ë°ì´íŠ¸ì˜¤ë¥˜ } = await supabaseAdmin
        .from("users")
        .update({ ì•…ì„¸ì‚¬ë¦¬ëª©ë¡: ëª©ë¡, ê³¨ë“œ: ì°¨ê°ëœê³¨ë“œ })
        .eq("ìœ ì €UID", ìœ ì €UID);

    if (ì—…ë°ì´íŠ¸ì˜¤ë¥˜) return res.status(500).json({ ì˜¤ë¥˜: "ì—…ë°ì´íŠ¸ ì‹¤íŒ¨" });

    res.json({
        ë©”ì‹œì§€: "íšë“ ì™„ë£Œ",
        ì—…ë°ì´íŠ¸ëœì•…ì„¸ëª©ë¡: ëª©ë¡,
        í˜„ì¬ê³¨ë“œ: ì°¨ê°ëœê³¨ë“œ
    });
});



app.post("/equip-accessory", async (req, res) => {
    const { ìœ ì €UID, ì´ë¦„ } = req.body;
    if (!ìœ ì €UID || !ì´ë¦„) return res.status(400).json({ ì˜¤ë¥˜: "í•„ìˆ˜ ì •ë³´ ëˆ„ë½" });

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });


    const ëª©ë¡ = ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ëª©ë¡ || [];

    // í˜„ì¬ ì¥ì°©ëœ ì•…ì„¸ì‚¬ë¦¬ ê°œìˆ˜
    const ì¥ì°©ëœìˆ˜ = (ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ëª©ë¡ || []).filter(a => a.ì¥ì°© === 1).length;
    const ì¥ë¹„ì¹¸ìˆ˜ = ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ì¥ë¹„ì¹¸ ?? 1;


    const ì•ˆê²½ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ì•ˆê²½"] || 0;
    if (ì•ˆê²½ê°œìˆ˜ < 1) {
        return res.status(403).json({ ì˜¤ë¥˜: "ìœ ë¬¼. ì•ˆê²½ì´ í•„ìš”í•©ë‹ˆë‹¤" });
    }

    if (ì¥ì°©ëœìˆ˜ >= ì¥ë¹„ì¹¸ìˆ˜) {
        return res.status(403).json({ ì˜¤ë¥˜: "ì¥ë¹„ì¹¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤" });
    }


    // ìƒˆ ëª©ë¡ êµ¬ì„± (ê¸°ì¡´ ì¥ì°© ìƒíƒœ ìœ ì§€, ìƒˆ ì¥ë¹„ë§Œ ì¥ì°©)
    const ìƒˆëª©ë¡ = ëª©ë¡.map(a => {
        if (a.ì´ë¦„ === ì´ë¦„) {
            return { ...a, ì¥ì°©: 1 };
        }
        return a;
    });

    const ìœ ì €ë³µì‚¬ = { ...ìœ ì €, ì•…ì„¸ì‚¬ë¦¬ëª©ë¡: ìƒˆëª©ë¡ };
    const ìµœëŒ€ì²´ë ¥ = ìµœëŒ€ì²´ë ¥ê³„ì‚°(ìœ ì €ë³µì‚¬);
    const ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìœ ì €ë³µì‚¬);


    const ìœ ë¬¼ë³µì‚¬ = { ...(ìœ ì €.ìœ ë¬¼ëª©ë¡ || {}) };
    ìœ ë¬¼ë³µì‚¬["ì•ˆê²½"] = Math.max(0, (ìœ ë¬¼ë³µì‚¬["ì•ˆê²½"] || 0) - 1);



    // âœ… ì„œë²„ì— ì €ì¥
    const { error: ì—…ë°ì´íŠ¸ì˜¤ë¥˜ } = await supabaseAdmin
        .from("users")
        .update({
            ì•…ì„¸ì‚¬ë¦¬ëª©ë¡: ìƒˆëª©ë¡,
            ìµœëŒ€ì²´ë ¥: ìµœëŒ€ì²´ë ¥,
            ìµœì¢…ê³µê²©ë ¥: ìµœì¢…ê³µê²©ë ¥,
            ìœ ë¬¼ëª©ë¡: ìœ ë¬¼ë³µì‚¬
        })
        .eq("ìœ ì €UID", ìœ ì €UID);

    if (ì—…ë°ì´íŠ¸ì˜¤ë¥˜) return res.status(500).json({ ì˜¤ë¥˜: "ì—…ë°ì´íŠ¸ ì‹¤íŒ¨" });


    const ë¬¸êµ¬ = `ì•…ì„¸ì‚¬ë¦¬ ${ì´ë¦„} ì¥ì°©`;
    await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
        ìœ ì €UID: ìœ ì €.ìœ ì €UID,
        ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
        ë¬¸êµ¬
    });



    // await ë¡œê·¸ê¸°ë¡(ìœ ì €UID, `${ì´ë¦„} ì¥ì°©`);

    // âœ… í´ë¼ì´ì–¸íŠ¸ë¡œë„ ë°˜í™˜
    res.json({
        ë©”ì‹œì§€: "ì¥ì°© ì™„ë£Œ",
        ì—…ë°ì´íŠ¸ëœì•…ì„¸ëª©ë¡: ìƒˆëª©ë¡,
        ìµœëŒ€ì²´ë ¥,
        ìµœì¢…ê³µê²©ë ¥,
        ê°±ì‹ ëœìœ ë¬¼ëª©ë¡: ìœ ë¬¼ë³µì‚¬,
        ì•…ì„¸ì‚¬ë¦¬ì¥ë¹„ì¹¸: ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ì¥ë¹„ì¹¸ ?? 1
    });
});

app.post("/unequip-accessory", async (req, res) => {
    const { ìœ ì €UID, ì´ë¦„ } = req.body;
    if (!ìœ ì €UID || !ì´ë¦„) return res.status(400).json({ ì˜¤ë¥˜: "í•„ìˆ˜ ì •ë³´ ëˆ„ë½" });

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });

    const ëª©ë¡ = ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ëª©ë¡ || [];
    let ë³€ê²½ë¨ = false;

    const ìƒˆëª©ë¡ = ëª©ë¡.map(a => {
        if (a.ì´ë¦„ === ì´ë¦„ && a.ì¥ì°© === 1) {
            ë³€ê²½ë¨ = true;
            return { ...a, ì¥ì°©: 0 };
        }
        return a;
    });

    if (!ë³€ê²½ë¨) {
        return res.status(200).json({ ë©”ì‹œì§€: "ì´ë¯¸ ì¥ì°©ë˜ì§€ ì•ŠìŒ", ì—…ë°ì´íŠ¸ëœì•…ì„¸ëª©ë¡: ìƒˆëª©ë¡ });
    }

    const ìœ ì €ë³µì‚¬ = { ...ìœ ì €, ì•…ì„¸ì‚¬ë¦¬ëª©ë¡: ìƒˆëª©ë¡ };
    const ìµœëŒ€ì²´ë ¥ = ìµœëŒ€ì²´ë ¥ê³„ì‚°(ìœ ì €ë³µì‚¬);
    const ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìœ ì €ë³µì‚¬);

    const { error: ì—…ë°ì´íŠ¸ì˜¤ë¥˜ } = await supabaseAdmin
        .from("users")
        .update({
            ì•…ì„¸ì‚¬ë¦¬ëª©ë¡: ìƒˆëª©ë¡,
            ìµœëŒ€ì²´ë ¥,
            ìµœì¢…ê³µê²©ë ¥
        })
        .eq("ìœ ì €UID", ìœ ì €UID);

    if (ì—…ë°ì´íŠ¸ì˜¤ë¥˜) return res.status(500).json({ ì˜¤ë¥˜: "ì—…ë°ì´íŠ¸ ì‹¤íŒ¨" });

    const ë¬¸êµ¬ = `ì•…ì„¸ì‚¬ë¦¬ ${ì´ë¦„} ì¥ì°© í•´ì œ`;
    await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
        ìœ ì €UID: ìœ ì €.ìœ ì €UID,
        ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
        ë¬¸êµ¬
    });

    // await ë¡œê·¸ê¸°ë¡(ìœ ì €UID, `${ì´ë¦„} ì¥ì°© í•´ì œ`);

    res.json({
        ë©”ì‹œì§€: "ì¥ì°© í•´ì œ ì™„ë£Œ",
        ì—…ë°ì´íŠ¸ëœì•…ì„¸ëª©ë¡: ìƒˆëª©ë¡,
        ìµœëŒ€ì²´ë ¥,
        ìµœì¢…ê³µê²©ë ¥,
        ê°±ì‹ ëœìœ ë¬¼ëª©ë¡: ìœ ì €.ìœ ë¬¼ëª©ë¡,
        ì•…ì„¸ì‚¬ë¦¬ì¥ë¹„ì¹¸: ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ì¥ë¹„ì¹¸ ?? 1
    });
});



app.post("/upgrade-accessory-slot", async (req, res) => {
    const { ìœ ì €UID, ëª©í‘œì¹¸ìˆ˜ } = req.body;
    if (!ìœ ì €UID || !ëª©í‘œì¹¸ìˆ˜) {
        return res.status(400).json({ ì˜¤ë¥˜: "í•„ìˆ˜ ì •ë³´ ëˆ„ë½" });
    }

    if (![2, 3].includes(ëª©í‘œì¹¸ìˆ˜)) {
        return res.status(400).json({ ì˜¤ë¥˜: "ì˜ëª»ëœ ì¥ë¹„ì¹¸ ìˆ˜" });
    }

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("ì•…ì„¸ì‚¬ë¦¬ì¥ë¹„ì¹¸, ê³¨ë“œ, ìœ ì €ì•„ì´ë””")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) {
        return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });
    }

    const í˜„ì¬ì¹¸ìˆ˜ = ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ì¥ë¹„ì¹¸ ?? 1;
    if (ëª©í‘œì¹¸ìˆ˜ <= í˜„ì¬ì¹¸ìˆ˜) {
        return res.status(400).json({ ì˜¤ë¥˜: "ì´ë¯¸ í™•ì¥ë˜ì—ˆê±°ë‚˜ ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤" });
    }

    const ë¹„ìš© = ëª©í‘œì¹¸ìˆ˜ === 2 ? 10000000 : 20000000;
    if ((ìœ ì €.ê³¨ë“œ || 0) < ë¹„ìš©) {
        return res.status(403).json({ ì˜¤ë¥˜: "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤" });
    }

    const ìƒˆê³¨ë“œ = ìœ ì €.ê³¨ë“œ - ë¹„ìš©;

    const { error: ì—…ë°ì´íŠ¸ì˜¤ë¥˜ } = await supabaseAdmin
        .from("users")
        .update({
            ì•…ì„¸ì‚¬ë¦¬ì¥ë¹„ì¹¸: ëª©í‘œì¹¸ìˆ˜,
            ê³¨ë“œ: ìƒˆê³¨ë“œ
        })
        .eq("ìœ ì €UID", ìœ ì €UID);

    if (ì—…ë°ì´íŠ¸ì˜¤ë¥˜) {
        return res.status(500).json({ ì˜¤ë¥˜: "ì—…ë°ì´íŠ¸ ì‹¤íŒ¨" });
    }

    // await ë¡œê·¸ê¸°ë¡(ìœ ì €UID, `ì•…ì„¸ì‚¬ë¦¬ ì¥ë¹„ì¹¸ ${ëª©í‘œì¹¸ìˆ˜}ì¹¸ìœ¼ë¡œ í™•ì¥`);
    await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
        ìœ ì €UID,
        ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
        ë¬¸êµ¬: `ì¥ë¹„ì¹¸ ${ëª©í‘œì¹¸ìˆ˜}ì¹¸ìœ¼ë¡œ í™•ì¥`
    });

    res.json({
        ë©”ì‹œì§€: "ì¥ë¹„ì¹¸ í™•ì¥ ì™„ë£Œ",
        í˜„ì¬ê³¨ë“œ: ìƒˆê³¨ë“œ,
        ì•…ì„¸ì‚¬ë¦¬ì¥ë¹„ì¹¸: ëª©í‘œì¹¸ìˆ˜
    });
});

app.post("/upgrade-accessory", async (req, res) => {
    const { ìœ ì €UID, ì´ë¦„, ë¹„ìš© } = req.body;

    if (!ìœ ì €UID || !ì´ë¦„ || !ë¹„ìš©) {
        return res.status(400).json({ ì˜¤ë¥˜: "í•„ìˆ˜ ì •ë³´ ëˆ„ë½" });
    }

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) {
        return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });
    }

    const ëª©ë¡ = ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ëª©ë¡ || [];
    const ëŒ€ìƒ = ëª©ë¡.find(a => a.ì´ë¦„ === ì´ë¦„);

    if (!ëŒ€ìƒ) {
        return res.status(404).json({ ì˜¤ë¥˜: "ì•…ì„¸ì‚¬ë¦¬ë¥¼ ë³´ìœ í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤" });
    }

    const í˜„ì¬ë“±ê¸‰ = ëŒ€ìƒ.ë“±ê¸‰ || 1;

    if (í˜„ì¬ë“±ê¸‰ >= 6) {
        return res.status(400).json({ ì˜¤ë¥˜: "ìµœê³  ë“±ê¸‰ì…ë‹ˆë‹¤" });
    }

    const ì˜ˆìƒë¹„ìš© = (í˜„ì¬ë“±ê¸‰ + 1) * 1000000;

    if (ë¹„ìš© !== ì˜ˆìƒë¹„ìš©) {
        return res.status(400).json({ ì˜¤ë¥˜: "ë¹„ìš© ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤" });
    }

    if ((ìœ ì €.ê³¨ë“œ || 0) < ë¹„ìš©) {
        return res.status(403).json({ ì˜¤ë¥˜: "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤" });
    }

    // ë“±ê¸‰ +1 ì ìš©
    const ìƒˆëª©ë¡ = ëª©ë¡.map(a => {
        if (a.ì´ë¦„ === ì´ë¦„) {
            return { ...a, ë“±ê¸‰: (a.ë“±ê¸‰ || 0) + 1 };
        }
        return a;
    });

    const ìƒˆê³¨ë“œ = ìœ ì €.ê³¨ë“œ - ë¹„ìš©;

    const ìœ ì €ë³µì‚¬ = { ...ìœ ì €, ì•…ì„¸ì‚¬ë¦¬ëª©ë¡: ìƒˆëª©ë¡ };
    const ìµœëŒ€ì²´ë ¥ = ìµœëŒ€ì²´ë ¥ê³„ì‚°(ìœ ì €ë³µì‚¬);
    const ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìœ ì €ë³µì‚¬);

    const ë“±ê¸‰ì´ë¦„ë§¤í•‘ = {
        1: "ì¼ë°˜",
        2: "ë ˆì–´",
        3: "ì‹ í™”",
        4: "ê³ ëŒ€",
        5: "íƒœì´ˆ",
        6: "íƒ€ë½"
    };
    const í˜„ì¬ë“±ê¸‰ì´ë¦„ = ë“±ê¸‰ì´ë¦„ë§¤í•‘[í˜„ì¬ë“±ê¸‰ + 1] || `${í˜„ì¬ë“±ê¸‰ + 1}ë‹¨ê³„`;

    const { error: ì—…ë°ì´íŠ¸ì—ëŸ¬ } = await supabaseAdmin
        .from("users")
        .update({
            ì•…ì„¸ì‚¬ë¦¬ëª©ë¡: ìƒˆëª©ë¡,
            ê³¨ë“œ: ìƒˆê³¨ë“œ,
            ìµœëŒ€ì²´ë ¥,
            ìµœì¢…ê³µê²©ë ¥
        })
        .eq("ìœ ì €UID", ìœ ì €UID);

    if (ì—…ë°ì´íŠ¸ì—ëŸ¬) {
        return res.status(500).json({ ì˜¤ë¥˜: "ì—…ë°ì´íŠ¸ ì‹¤íŒ¨" });
    }

    // await ë¡œê·¸ê¸°ë¡(ìœ ì €UID, `${ì´ë¦„} ë“±ê¸‰ì—… (+${í˜„ì¬ë“±ê¸‰ + 1})`);
    await ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({
        ìœ ì €UID,
        ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
        ë¬¸êµ¬: `${ì´ë¦„} ì•…ì„¸ì‚¬ë¦¬ ${í˜„ì¬ë“±ê¸‰ì´ë¦„}(ìœ¼)ë¡œ ë“±ê¸‰ì—…`
    });

    return res.json({
        ë©”ì‹œì§€: "ë“±ê¸‰ì—… ì„±ê³µ",
        ì—…ë°ì´íŠ¸ëœì•…ì„¸ëª©ë¡: ìƒˆëª©ë¡,
        í˜„ì¬ê³¨ë“œ: ìƒˆê³¨ë“œ,
        ìµœëŒ€ì²´ë ¥,
        ìµœì¢…ê³µê²©ë ¥,
        í˜„ì¬ë“±ê¸‰: í˜„ì¬ë“±ê¸‰ + 1,
        í˜„ì¬ë“±ê¸‰ì´ë¦„
    });
});


app.post("/use-Sword", async (req, res) => {
    const { ìœ ì €UID } = req.body;
    if (!ìœ ì €UID) {
        return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });
    }

    const { data: ìœ ì €, error: ì¡°íšŒì—ëŸ¬ } = await supabaseAdmin
        .from("users")
        .select("*")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (ì¡°íšŒì—ëŸ¬ || !ìœ ì €) {
        return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì •ë³´ ì—†ìŒ" });
    }

    const ìœ ë¬¼ëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡ };
    const ì†Œë“œìˆ˜ëŸ‰ = ìœ ë¬¼ëª©ë¡["ì†Œë“œ"] || 0;

    if (ì†Œë“œìˆ˜ëŸ‰ < 3) {
        return res.status(400).json({ ì˜¤ë¥˜: "ì†Œë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤" });
    }

    // âœ… ìœ ë¬¼ ë³€ê²½
    ìœ ë¬¼ëª©ë¡["ì†Œë“œ"] = ì†Œë“œìˆ˜ëŸ‰ - 3;
    ìœ ë¬¼ëª©ë¡["ìŠ¤í”¼ì–´"] = (ìœ ë¬¼ëª©ë¡["ìŠ¤í”¼ì–´"] || 0) + 1;

    // âœ… ë³€ê²½ ì ìš© í›„ ê³µê²©ë ¥ ì¬ê³„ì‚°
    ìœ ì €.ìœ ë¬¼ëª©ë¡ = ìœ ë¬¼ëª©ë¡;
    const ìµœì¢…ê³µê²©ë ¥ = ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìœ ì €);

    const { error: ì €ì¥ì—ëŸ¬ } = await supabaseAdmin
        .from("users")
        .update({
            ìœ ë¬¼ëª©ë¡,
            ìµœì¢…ê³µê²©ë ¥
        })
        .eq("ìœ ì €UID", ìœ ì €UID);

    if (ì €ì¥ì—ëŸ¬) {
        return res.status(500).json({ ì˜¤ë¥˜: "ê³µê²©ë ¥ ì €ì¥ ì‹¤íŒ¨" });
    }

    return res.json({ ìœ ë¬¼ëª©ë¡, ìµœì¢…ê³µê²©ë ¥ });
});


app.post("/receive-mail", async (req, res) => {
    const { ìœ ì €UID, ìš°í¸ì¸ë±ìŠ¤ } = req.body;
    if (ìœ ì €UID == null || ìš°í¸ì¸ë±ìŠ¤ == null) {
        return res.status(400).json({ ì˜¤ë¥˜: "í•„ìˆ˜ ê°’ ëˆ„ë½" });
    }

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("ìš°í¸í•¨, ìœ ë¬¼ëª©ë¡")
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì—†ìŒ" });

    const ìš°í¸í•¨ = ìœ ì €.ìš°í¸í•¨ || [];
    if (ìš°í¸ì¸ë±ìŠ¤ < 0 || ìš°í¸ì¸ë±ìŠ¤ >= ìš°í¸í•¨.length)
        return res.status(400).json({ ì˜¤ë¥˜: "ì˜ëª»ëœ ì¸ë±ìŠ¤" });


    const ìš°í¸ = ìš°í¸í•¨[ìš°í¸ì¸ë±ìŠ¤];
    const ìœ ë¬¼ëª©ë¡ = { ...ìœ ì €.ìœ ë¬¼ëª©ë¡ };

    if (!(ìš°í¸.ì´ë¦„ in ì‹ í™”ìœ ë¬¼ë°ì´í„°)) {
        return res.status(400).json({ ì˜¤ë¥˜: "ì˜ëª»ëœ ìš°í¸ì…ë‹ˆë‹¤. ì£¼ì¸ì¥ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”" });
    }


    ìœ ë¬¼ëª©ë¡[ìš°í¸.ì´ë¦„] = (ìœ ë¬¼ëª©ë¡[ìš°í¸.ì´ë¦„] || 0) + (ìš°í¸.ìˆ˜ëŸ‰ || 1);
    ìš°í¸í•¨.splice(ìš°í¸ì¸ë±ìŠ¤, 1); // ìˆ˜ë ¹í•œ ìš°í¸ ì‚­ì œ

    const { error: updateErr } = await supabaseAdmin
        .from("users")
        .update({ ìœ ë¬¼ëª©ë¡, ìš°í¸í•¨ })
        .eq("ìœ ì €UID", ìœ ì €UID);

    if (updateErr) return res.status(500).json({ ì˜¤ë¥˜: "ì—…ë°ì´íŠ¸ ì‹¤íŒ¨" });

    return res.json({ ìœ ë¬¼ëª©ë¡, ìš°í¸í•¨ });
});


app.post("/refresh-mailbox", async (req, res) => {
    const { ìœ ì €UID } = req.body;

    if (!ìœ ì €UID) {
        return res.status(400).json({ ì˜¤ë¥˜: "ìœ ì €UID ëˆ„ë½" });
    }

    const { data: ìœ ì €, error } = await supabaseAdmin
        .from("users")
        .select("ìš°í¸í•¨") // ğŸ¯ ìš°í¸í•¨ë§Œ ì„ íƒ
        .eq("ìœ ì €UID", ìœ ì €UID)
        .single();

    if (error || !ìœ ì €) {
        return res.status(404).json({ ì˜¤ë¥˜: "ìœ ì € ì—†ìŒ" });
    }

    return res.json({ ìš°í¸í•¨: ìœ ì €.ìš°í¸í•¨ || [] });
});











































app.listen(3000, () => {
});




































// ë¡œê·¸ ê¸°ë¡ í•¨ìˆ˜
async function ë¡œê·¸ê¸°ë¡(ìœ ì €ì•„ì´ë””, ë‚´ìš©) {
    const now = new Date().toLocaleString("ko-KR", {
        timeZone: "Asia/Seoul",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
    });

    const ì ‘ë‘ì–´ = `${now} | `;
    await supabaseAdmin.from("logs").insert([
        {
            ìœ ì €ì•„ì´ë””,
            ë‚´ìš©: ì ‘ë‘ì–´ + ë‚´ìš©
        }
    ]);
}




async function ì´ë²¤íŠ¸ê¸°ë¡ì¶”ê°€({ ìœ ì €UID, ìœ ì €ì•„ì´ë””, ë¬¸êµ¬ }) {
    const ì‹¤ì œë¬¸êµ¬ = `${ìœ ì €ì•„ì´ë””} (ì´)ê°€ ${ë¬¸êµ¬}`;
    const { error } = await supabaseAdmin.from("ì´ë²¤íŠ¸ê¸°ë¡").insert([
        { ìœ ì €UID, ìœ ì €ì•„ì´ë””, ì¼ì–´ë‚œì¼: ì‹¤ì œë¬¸êµ¬ }
    ]);

    if (error) {
        console.error("ì´ë²¤íŠ¸ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:", error);
    }
}


function í¬ë¦¬í‹°ì»¬ë°°ìœ¨ê³„ì‚°(ìœ ì €) {
    const ìŠ¤í‚¬ = ìœ ì €.ìŠ¤í‚¬ || {};
    const ë ˆë²¨ = ìŠ¤í‚¬["í¬ë¦¬í‹°ì»¬"] || 0;
    if (ë ˆë²¨ <= 0) return 1; // ë°°ìš´ ê²Œ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 1ë°°

    // ê° ë ˆë²¨ë‹¹ 10% â†’ 0.1 ì¦ê°€, ê¸°ë³¸ ë°°ìœ¨ 1
    return 1 + ë ˆë²¨ * 0.1;
}

function ë²„ì„œì»¤ë°°ìœ¨ê³„ì‚°(ìœ ì €) {
    const ìŠ¤í‚¬ = ìœ ì €.ìŠ¤í‚¬ || {};
    const ë ˆë²¨ = ìŠ¤í‚¬["ë²„ì„œì»¤"] || 0;

    return {
        ë°°ìœ¨: ë ˆë²¨ > 0 ? 1.1 * ë ˆë²¨ + 1.1 : 1, // ê¸°ë³¸ 1ë°°
        ì²´ë ¥ì†Œëª¨: ë ˆë²¨
    };
}

function ë²„ë‹ë°°ìœ¨ê³„ì‚°(ìœ ì €, í˜„ì¬HP, ìµœëŒ€HP) {
    const ìŠ¤í‚¬ = ìœ ì €.ìŠ¤í‚¬ || {};
    const ë ˆë²¨ = ìŠ¤í‚¬["ë²„ë‹"] || 0;

    // ì²´ë ¥ì´ 50% ì´ìƒì´ë©´ ë°œë™ ì•ˆ í•¨
    if (í˜„ì¬HP > ìµœëŒ€HP * 0.5) return 1;

    return ë ˆë²¨ > 0 ? 1 + ë ˆë²¨ * 0.2 : 1;
}

function ë¸Œë¡œí°ë°©ì–´ë¬´ì‹œìœ¨ê³„ì‚°(ìœ ì €) {
    const ìŠ¤í‚¬ = ìœ ì €.ìŠ¤í‚¬ || {};
    const ë ˆë²¨ = ìŠ¤í‚¬["ë¸Œë¡œí°"] || 0;
    return ë ˆë²¨ * 0.04;
}

function ë°ë¯¸ì§€ê³„ì‚°(ìœ ì €, ëª¬ìŠ¤í„°, ìŠ¤í‚¬ê²°ê³¼) {
    let ë°©ì–´ë ¥ = ëª¬ìŠ¤í„°.ë°©ì–´ë ¥ || 0;

    // 1) ì‰´ë“œë°´ ë³´ì •
    const ì‰´ë“œë°´ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ì‰´ë“œë°´"] || 0;
    const ë³´ì • = 1 - 0.01 * ì‰´ë“œë°´ê°œìˆ˜;

    if (ìŠ¤í‚¬ê²°ê³¼.ë°©ì–´ë¬´ì‹œìœ¨ > 0) {
        ë°©ì–´ë ¥ = Math.floor(ë°©ì–´ë ¥ * (1 - ìŠ¤í‚¬ê²°ê³¼.ë°©ì–´ë¬´ì‹œìœ¨) * ë³´ì •);
    } else {
        ë°©ì–´ë ¥ = Math.floor(ë°©ì–´ë ¥ * ë³´ì •);
    }

    // 3) ëœë¤ ë³´ì • ë° ê¸°ë³¸/ëœë¤ ë°ë¯¸ì§€ ê³„ì‚°
    const ëœë¤ë³´ì • = Math.random() * 0.4 + 0.8;
    const ê¸°ë³¸ë°ë¯¸ì§€ = Math.max(0, ìœ ì €.ìµœì¢…ê³µê²©ë ¥ - ë°©ì–´ë ¥);
    const ëœë¤ë°ë¯¸ì§€ = Math.floor(ê¸°ë³¸ë°ë¯¸ì§€ * ëœë¤ë³´ì •);

    // 4) í¬ë¦¬í‹°ì»¬Â·ë²„ì„œì»¤Â·ë²„ë‹ ë“±ì˜ ë°°ìœ¨ í•©ì„±
    const ìµœì¢…ë°°ìœ¨ = (ìŠ¤í‚¬ê²°ê³¼.í¬ë¦¬í‹°ì»¬ë°°ìœ¨) * (ìŠ¤í‚¬ê²°ê³¼.ë²„ì„œì»¤ë°°ìœ¨) * (ìŠ¤í‚¬ê²°ê³¼.ë²„ë‹ë°°ìœ¨);

    const ê²°ì •ê°ì²´ = ìœ ì €.ì§ì—…ê²°ì • || {};
    const ê³„ì—´í‚¤ = Object.keys(ê²°ì •ê°ì²´)[0];  // ì˜ˆ: "ê¶ìˆ ", "ë§ˆìˆ " ë“±

    let ì§ì—…ì¶”ê°€ë°°ìœ¨ = 1;
    if (ê³„ì—´í‚¤ === "ë§ˆìˆ ") {
        const ë‹¨ê³„ = ê²°ì •ê°ì²´[ê³„ì—´í‚¤];  // 1~6
        const ë§ˆìˆ ë°°ìœ¨ = [1.2, 1.4, 1.6, 1.8, 2.0, 2.6];
        if (ë‹¨ê³„ >= 1 && ë‹¨ê³„ <= ë§ˆìˆ ë°°ìœ¨.length) {
            ì§ì—…ì¶”ê°€ë°°ìœ¨ = ë§ˆìˆ ë°°ìœ¨[ë‹¨ê³„ - 1];
        }
    }

    // 6) ìµœì¢…ë°ë¯¸ì§€ ê³„ì‚° (ì›ë˜ ë°ë¯¸ì§€ * ë§ˆìˆ ì¶”ê°€ë°°ìœ¨)
    const ìµœì¢…ë°ë¯¸ì§€ = Math.floor(ëœë¤ë°ë¯¸ì§€ * ìµœì¢…ë°°ìœ¨ * ì§ì—…ì¶”ê°€ë°°ìœ¨);

    return ìµœì¢…ë°ë¯¸ì§€;
}


function ì „íˆ¬ì‹œë®¬ë ˆì´ì…˜(ìœ ì €, ëª¬ìŠ¤í„°, ì „íˆ¬ë¡œê·¸, ì‹œì‘í„´, ë³´ìŠ¤ì „ = false) {
    let ìœ ì €HP = ìœ ì €.ë‚¨ì€ì²´ë ¥;
    let ëˆ„ì ë°ë¯¸ì§€ = 0;
    const í•˜íŠ¸ë§ˆì´ë„ˆìŠ¤ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["í•˜íŠ¸ë§ˆì´ë„ˆìŠ¤"] || 0;
    const ë³´ì • = 1 - 0.001 * í•˜íŠ¸ë§ˆì´ë„ˆìŠ¤;
    ëª¬ìŠ¤í„°.ì²´ë ¥ = Math.floor(ëª¬ìŠ¤í„°.ì²´ë ¥ * ë³´ì •);
    let ëª¬ìŠ¤í„°HP = ëª¬ìŠ¤í„°.ì²´ë ¥;
    let í˜„ì¬í„´ = ì‹œì‘í„´;

    const ì‹ ìˆ íšŒë³µëŸ‰ = [1, 2, 3, 4, 5, 8];
    const ì‹ ìˆ ì„±ê³µí™•ë¥  = 0.15;

    const ê²€ìˆ í™•ë¥  = [0.10, 0.20, 0.30, 0.40, 0.50, 0.80];

    const ê¶ìˆ ë¬´ì‹œí™•ë¥  = [0.05, 0.10, 0.15, 0.20, 0.25, 0.40];

    while (ìœ ì €HP > 0 && (ë³´ìŠ¤ì „ || ëª¬ìŠ¤í„°HP > 0)) {
        ëª¬ìŠ¤í„°HP = Math.max(0, ëª¬ìŠ¤í„°HP);
        ìœ ì €HP = Math.max(0, ìœ ì €HP);


        const ê²°ì •ê°ì²´ = ìœ ì €.ì§ì—…ê²°ì • || {};
        const ê³„ì—´í‚¤ = Object.keys(ê²°ì •ê°ì²´)[0];




        const ìŠ¤íƒ­ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ìŠ¤íƒ­"] || 0;
        const ë¬´ì‹œí™•ë¥  = ìŠ¤íƒ­ê°œìˆ˜ * 0.001;

        const ìŒì–‘ = ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ëª©ë¡?.find(a => a.ì´ë¦„ === "ìŒì–‘" && a.ì¥ì°© === 1);
        const ìŒì–‘í™•ë¥  = ìŒì–‘ ? ìŒì–‘.ë“±ê¸‰ * 0.05 : 0;


        let ê¶ìˆ í™•ë¥  = 0;

        if (ê³„ì—´í‚¤ === "ê¶ìˆ ") {
            const ë‹¨ê³„ = ê²°ì •ê°ì²´[ê³„ì—´í‚¤]; // 1 ~ 6
            if (ë‹¨ê³„ >= 1 && ë‹¨ê³„ <= ê¶ìˆ ë¬´ì‹œí™•ë¥ .length) {
                ê¶ìˆ í™•ë¥  = ê¶ìˆ ë¬´ì‹œí™•ë¥ [ë‹¨ê³„ - 1];
            }
        }


        const ì „ì²´ë¬´ì‹œí™•ë¥  = ë¬´ì‹œí™•ë¥  + ìŒì–‘í™•ë¥  + ê¶ìˆ í™•ë¥ ;

        if (!(Math.random() < ì „ì²´ë¬´ì‹œí™•ë¥ )) {
            ìœ ì €HP--;
        }



        if (ê³„ì—´í‚¤ === "ì‹ ìˆ ") {
            const ë‹¨ê³„ = ê²°ì •ê°ì²´[ê³„ì—´í‚¤];      // 1 ~ 6
            if (ë‹¨ê³„ >= 1 && ë‹¨ê³„ <= ì‹ ìˆ íšŒë³µëŸ‰.length) {
                if (Math.random() < ì‹ ìˆ ì„±ê³µí™•ë¥ ) {
                    ìœ ì €HP += ì‹ ìˆ íšŒë³µëŸ‰[ë‹¨ê³„ - 1];
                    ìœ ì €HP = Math.min(ìœ ì €HP, ìœ ì €.ìµœëŒ€ì²´ë ¥);
                }
            }
        }

        const í¬ë¦¬í‹°ì»¬ë°°ìœ¨ = í¬ë¦¬í‹°ì»¬ë°°ìœ¨ê³„ì‚°(ìœ ì €);
        const { ë°°ìœ¨: ë²„ì„œì»¤ë°°ìœ¨, ì²´ë ¥ì†Œëª¨ } = ë²„ì„œì»¤ë°°ìœ¨ê³„ì‚°(ìœ ì €);
        const ë²„ë‹ë°°ìœ¨ = ë²„ë‹ë°°ìœ¨ê³„ì‚°(ìœ ì €, ìœ ì €HP, ìœ ì €.ìµœëŒ€ì²´ë ¥);
        const ë°©ì–´ë¬´ì‹œìœ¨ = ë¸Œë¡œí°ë°©ì–´ë¬´ì‹œìœ¨ê³„ì‚°(ìœ ì €);

        const ë°ë¯¸ì§€ = ë°ë¯¸ì§€ê³„ì‚°(ìœ ì €, ëª¬ìŠ¤í„°, {
            í¬ë¦¬í‹°ì»¬ë°°ìœ¨,
            ë²„ì„œì»¤ë°°ìœ¨,
            ë²„ë‹ë°°ìœ¨,
            ë°©ì–´ë¬´ì‹œìœ¨
        });

        ìœ ì €HP -= ì²´ë ¥ì†Œëª¨;






        if (!ë³´ìŠ¤ì „) {
            ëª¬ìŠ¤í„°HP -= ë°ë¯¸ì§€;
            ëª¬ìŠ¤í„°HP = Math.max(0, ëª¬ìŠ¤í„°HP);
        }

        ëˆ„ì ë°ë¯¸ì§€ += ë°ë¯¸ì§€;

        const ë°œë™ì•„ì´ì½˜ = [];
        if (í¬ë¦¬í‹°ì»¬ë°°ìœ¨ > 1) ë°œë™ì•„ì´ì½˜.push("í¬ë¦¬í‹°ì»¬ì•„ì´ì½˜");
        if (ë²„ì„œì»¤ë°°ìœ¨ > 1) ë°œë™ì•„ì´ì½˜.push("ë²„ì„œì»¤ì•„ì´ì½˜");
        if (ë²„ë‹ë°°ìœ¨ > 1) ë°œë™ì•„ì´ì½˜.push("ë²„ë‹ì•„ì´ì½˜");
        if (ë°©ì–´ë¬´ì‹œìœ¨ > 0) ë°œë™ì•„ì´ì½˜.push("ë¸Œë¡œí°ì•„ì´ì½˜");

        const ì‰´ë“œë°´ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ì‰´ë“œë°´"] || 0;
        const ë°©ì–´ë³´ì • = 1 - 0.01 * ì‰´ë“œë°´ê°œìˆ˜;

        const ëª¬ìŠ¤í„°ë°©ì–´ë ¥ê³„ì‚° = Math.floor(
            (ëª¬ìŠ¤í„°.ë°©ì–´ë ¥ || 0) *
            (1 - ë°©ì–´ë¬´ì‹œìœ¨) *
            ë°©ì–´ë³´ì •
        );





        // â”€â”€ ê²€ìˆ  ì¶”ê°€ê³µê²© ë¡œì§ â”€â”€
        let ì¶”ê°€ê³µê²©íšŸìˆ˜ = 0;  // ê¸°ë³¸ê°’ 0ìœ¼ë¡œ ì´ˆê¸°í™”

        if (ê³„ì—´í‚¤ === "ê²€ìˆ ") {
            const ë‹¨ê³„ = ê²°ì •ê°ì²´[ê³„ì—´í‚¤];  // 1~6
            if (ë‹¨ê³„ >= 1 && ë‹¨ê³„ <= ê²€ìˆ í™•ë¥ .length) {
                const í™•ë¥  = ê²€ìˆ í™•ë¥ [ë‹¨ê³„ - 1];
                if (Math.random() < í™•ë¥ ) {
                    const íšŸìˆ˜ = Math.floor(Math.random() * 4) + 1;
                    ì¶”ê°€ê³µê²©íšŸìˆ˜ = íšŸìˆ˜;

                    for (let i = 0; i < íšŸìˆ˜; i++) {
                        if (!ë³´ìŠ¤ì „) {
                            ëª¬ìŠ¤í„°HP -= ë°ë¯¸ì§€;
                            ëª¬ìŠ¤í„°HP = Math.max(0, ëª¬ìŠ¤í„°HP);
                        }

                        ëˆ„ì ë°ë¯¸ì§€ += ë°ë¯¸ì§€;

                    }
                }
            }
        }

        // â”€â”€ ì „íˆ¬ë¡œê·¸ì— ê¸°ë³¸ ê³µê²© ë¡œê·¸ + ì¶”ê°€ê³µê²©íšŸìˆ˜ë§Œ í‘¸ì‰¬ â”€â”€
        ì „íˆ¬ë¡œê·¸.push({
            í„´: í˜„ì¬í„´,
            íƒ€ì…: "ê³µê²©",
            ìœ ì €ì•„ì´ë””: ìœ ì €.ìœ ì €ì•„ì´ë””,
            ìœ ì €ê³µê²©ë ¥: ìœ ì €.ê³µê²©ë ¥,
            ìœ ì €ìµœì¢…ê³µê²©ë ¥: ìœ ì €.ìµœì¢…ê³µê²©ë ¥,
            ìœ ì €ì²´ë ¥: ìœ ì €HP,
            ìœ ì €ìµœëŒ€ì²´ë ¥: ìœ ì €.ìµœëŒ€ì²´ë ¥,
            ëª¬ìŠ¤í„°ì´ë¦„: ëª¬ìŠ¤í„°.ì´ë¦„,
            ëª¬ìŠ¤í„°ì²´ë ¥: ë³´ìŠ¤ì „ ? ëª¬ìŠ¤í„°.ì²´ë ¥ : ëª¬ìŠ¤í„°HP,
            ëª¬ìŠ¤í„°ìµœëŒ€ì²´ë ¥: ëª¬ìŠ¤í„°.ì²´ë ¥,
            ëª¬ìŠ¤í„°ë°©ì–´ë ¥: ëª¬ìŠ¤í„°ë°©ì–´ë ¥ê³„ì‚°,
            ì•„ì´ì½˜: ë°œë™ì•„ì´ì½˜,
            íš¨ê³¼: `${ë°ë¯¸ì§€}`,
            ì¶”ê°€ê³µê²©íšŸìˆ˜  // ì˜ˆ: 2ë©´ { ì¶”ê°€ê³µê²©íšŸìˆ˜: 2 }ë¡œ ë“¤ì–´ê°
        });

        í˜„ì¬í„´++;
    }

    return {
        ê²°ê³¼: ìœ ì €HP <= 0 ? "íŒ¨ë°°" : "ìŠ¹ë¦¬",
        ìœ ì €ë‚¨ì€ì²´ë ¥: ìœ ì €HP,
        ëª¬ìŠ¤í„°ë‚¨ì€ì²´ë ¥: ëª¬ìŠ¤í„°HP,
        ëˆ„ì ë°ë¯¸ì§€
    };
}


function ì¥ë¹„ë“œëíŒì •(ëª¬ìŠ¤í„°, ìœ ì €) {
    const ê³ ì •ë“œë = {
        "ì¼ë°˜": { ì´ë¦„: "ë¦´ë¦¬íŠ¸ì˜ ë…ë‹ˆ", ê³µê²©ë ¥: 30 },
        "ë ˆì–´": { ì´ë¦„: "ë””ì•„ë¸”ë¡œì˜ ë¿”", ê³µê²©ë ¥: 63 },
        "ì‹ í™”": { ì´ë¦„: "ë ˆë¹„ì•„íƒ„ì˜ ë¹„ëŠ˜", ê³µê²©ë ¥: 132 },
        "ê³ ëŒ€": { ì´ë¦„: "ë²¨ì œë¶€ë¸Œì˜ ê¼¬ë¦¬", ê³µê²©ë ¥: 276 },
        "íƒœì´ˆ": { ì´ë¦„: "ì‚¬íƒ„ì˜ ë‚ ê°œ", ê³µê²©ë ¥: 576 },
        "íƒ€ë½": { ì´ë¦„: "ë£¨ì‹œí¼ì˜ ì‹¬ì¥", ê³µê²©ë ¥: 1200 },
    };

    const ë“œë = ê³ ì •ë“œë[ëª¬ìŠ¤í„°.íƒ€ì…];
    const ë“œëí™•ë¥  = 1; // ê¸°ë³¸ 100% ë“œë. ë‚˜ì¤‘ì— ì¡°ê±´ë¶€ë¡œ ë°”ê¿”ë„ ë¨

    if (!ë“œë || Math.random() > ë“œëí™•ë¥ ) return null;

    return {
        ì´ë¦„: ë“œë.ì´ë¦„,
        ê³µê²©ë ¥: ë“œë.ê³µê²©ë ¥,
        ë“±ê¸‰: ëª¬ìŠ¤í„°.íƒ€ì…,
        ê°•í™”: 0,
        ìˆ˜ëŸ‰: 0
    };
}

function ìœ ë¬¼ë“œëíŒì •(ëª¬ìŠ¤í„°, ìœ ì €) {
    // ìœ ë¬¼ë³„ ìµœëŒ€ ë³´ìœ  ê°œìˆ˜ ë§µ
    const maxCounts = {

    };

    const í›„ë³´ìœ ë¬¼ = Object.keys(ì¼ë°˜ìœ ë¬¼ë°ì´í„°).filter(ìœ ë¬¼ì´ë¦„ => {
        const ë³´ìœ ëŸ‰ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.[ìœ ë¬¼ì´ë¦„] || 0;
        // ë§µì— ì„¤ì •ëœ ìµœëŒ€ì¹˜ê°€ ìˆìœ¼ë©´ ê·¸ ê°’ì„, ì—†ìœ¼ë©´ 99ë¥¼ ê¸°ë³¸ìœ¼ë¡œ
        const max = maxCounts[ìœ ë¬¼ì´ë¦„] ?? 99;
        return ë³´ìœ ëŸ‰ < max;
    });

    const ë“œëí™•ë¥  = 0.003;
    if (í›„ë³´ìœ ë¬¼.length > 0 && Math.random() < ë“œëí™•ë¥ ) {
        // ëœë¤ìœ¼ë¡œ ë“œë ìœ ë¬¼ ì„ íƒ
        const ëœë¤ìœ ë¬¼ = í›„ë³´ìœ ë¬¼[Math.floor(Math.random() * í›„ë³´ìœ ë¬¼.length)];
        return ëœë¤ìœ ë¬¼;
    }

    return null; // ë“œë ì•ˆë¨
}

function ë³´ìƒê³„ì‚°(ì¸µ, ìœ ì €, ëª¬ìŠ¤í„°) {
    let ê²½í—˜ì¹˜ = 400;
    let ê°ì†Œìœ¨ = 0.2;
    for (let i = 1; i < ìœ ì €.ë ˆë²¨; i++) {
        ê²½í—˜ì¹˜ *= (1 - ê°ì†Œìœ¨);
        ê°ì†Œìœ¨ *= 0.9;
    }

    const ë³´ì •ê³„ìˆ˜ = 0.9 + Math.random() * 0.2;
    ê²½í—˜ì¹˜ = Math.floor(ê²½í—˜ì¹˜ * ë³´ì •ê³„ìˆ˜);

    let ê³¨ë“œ = Math.floor(Math.random() * 100) + (ì¸µ - 1) * 100;
    let ìˆ™ë ¨ë„ = Math.floor(ì¸µ * 1);


    // let ì¶”ê°€ê²½í—˜ì¹˜ = 0;
    // let ì¶”ê°€ê³¨ë“œ = 0;
    // let ì¶”ê°€ìˆ™ë ¨ë„ = 0;

    // if (ëª¬ìŠ¤í„°.íƒ€ì… === "ê²½í—˜") {
    //     ì¶”ê°€ê²½í—˜ì¹˜ = ê²½í—˜ì¹˜ * 19;
    //     ê²½í—˜ì¹˜ *= 20;
    // }

    // if (ëª¬ìŠ¤í„°.íƒ€ì… === "í™©ê¸ˆ") {
    //     ì¶”ê°€ê³¨ë“œ = ê³¨ë“œ * 19;
    //     ê³¨ë“œ *= 20;
    // }

    // if (ëª¬ìŠ¤í„°.íƒ€ì… === "ê³„ì‹œ") {
    //     ì¶”ê°€ìˆ™ë ¨ë„ = ìˆ™ë ¨ë„ * 19;
    //     ìˆ™ë ¨ë„ *= 20;
    // }

    // return { ê²½í—˜ì¹˜, ê³¨ë“œ, ìˆ™ë ¨ë„, ì¶”ê°€ê³¨ë“œ, ì¶”ê°€ìˆ™ë ¨ë„, ì¶”ê°€ê²½í—˜ì¹˜ };
    return { ê²½í—˜ì¹˜, ê³¨ë“œ, ìˆ™ë ¨ë„ };
}

function ë ˆë²¨ì—…íŒì •(í˜„ì¬ê²½í—˜ì¹˜, í˜„ì¬ë ˆë²¨) {
    const ìƒˆë ˆë²¨ = Math.floor(í˜„ì¬ê²½í—˜ì¹˜ / 1000) + 1;

    const ì¦ê°€ëŸ‰ = ìƒˆë ˆë²¨ - í˜„ì¬ë ˆë²¨;
    const ë ˆë²¨ê³µê²©ë ¥ = ì¦ê°€ëŸ‰ * 1;
    return {
        ìƒˆë ˆë²¨,
        ì¦ê°€í•œë ˆë²¨: ì¦ê°€ëŸ‰,
        ì¦ê°€í•œê³µê²©ë ¥: ì¦ê°€ëŸ‰ * 1,
        ë ˆë²¨ê³µê²©ë ¥
    };
}

function ë“œë ˆì¸íšŒë³µ(ìœ ì €) {
    const ìŠ¤í‚¬ = ìœ ì €.ìŠ¤í‚¬ || {};
    const ë“œë ˆì¸ë ˆë²¨ = ìŠ¤í‚¬["ë“œë ˆì¸"] || 0;

    // ë ˆë²¨ë§Œí¼ íšŒë³µ
    return ë“œë ˆì¸ë ˆë²¨;
}

function ì•„ì´ì–¸ë°”ë””íšŒë³µ(ìœ ì €) {
    const ìŠ¤í‚¬ = ìœ ì €.ìŠ¤í‚¬ || {};
    const ì•„ì´ì–¸ë ˆë²¨ = ìŠ¤í‚¬["ì•„ì´ì–¸ë°”ë””"] || 0;

    return ì•„ì´ì–¸ë ˆë²¨; // ê° ë ˆë²¨ë‹¹ +1 íšŒë³µ
}

function ì¸ì‚¬ì´íŠ¸ì¶”ê°€ìˆ™ë ¨ë„(ìœ ì €) {
    const ìŠ¤í‚¬ = ìœ ì €.ìŠ¤í‚¬ || {};
    const ì¸ì‚¬ì´íŠ¸ë ˆë²¨ = ìŠ¤í‚¬["ì¸ì‚¬ì´íŠ¸"] || 0;

    return ì¸ì‚¬ì´íŠ¸ë ˆë²¨; // ë ˆë²¨ 1ë‹¹ ì¶”ê°€ìˆ™ë ¨ë„ 1
}

function ì¸í…”ë¦¬ì „ìŠ¤ì¶”ê°€ê²½í—˜ì¹˜ë°°ìœ¨(ìœ ì €) {
    const ìŠ¤í‚¬ = ìœ ì €.ìŠ¤í‚¬ || {};
    const ì¸í…”ë¦¬ë ˆë²¨ = ìŠ¤í‚¬["ì¸í…”ë¦¬ì „ìŠ¤"] || 0;

    // ë ˆë²¨ë‹¹ 10% â†’ ê³±ì…ˆìš© 1.0 + ë ˆë²¨ * 0.1
    return 1 + ì¸í…”ë¦¬ë ˆë²¨ * 0.1;
}

function íšë“ê¸ˆí™”ë°œêµ´(ìœ ì €) {
    const ìŠ¤í‚¬ = ìœ ì €.ìŠ¤í‚¬ || {};
    const ë°œêµ´ë ˆë²¨ = ìŠ¤í‚¬["ë°œêµ´"] || 0;

    // ê° ë ˆë²¨ë‹¹ 10% ì¦ê°€ â†’ ê³±ì…ˆ ë°°ìœ¨ë¡œ 1.0 + (ë ˆë²¨ Ã— 0.1)
    return 1 + ë°œêµ´ë ˆë²¨ * 0.1;
}

function ì „íˆ¬ë³´ìƒë°˜ì˜(ìœ ì €, ë³´ìƒ, íšŒë³µëŸ‰, ë ˆë²¨ì—…ì •ë³´, ì „íˆ¬ì²´ë ¥) {
    const ìƒˆìœ ì € = { ...ìœ ì € };

    ìƒˆìœ ì €.ìœ ì €UID = ìœ ì €.ìœ ì €UID;
    ìƒˆìœ ì €.ê²½í—˜ì¹˜ += ë³´ìƒ.ê²½í—˜ì¹˜;
    ìƒˆìœ ì €.ê³¨ë“œ += ë³´ìƒ.ê³¨ë“œ;
    ìƒˆìœ ì €.ìˆ™ë ¨ë„ += ë³´ìƒ.ìˆ™ë ¨ë„;

    ìƒˆìœ ì €.ë ˆë²¨ += ë ˆë²¨ì—…ì •ë³´.ì¦ê°€í•œë ˆë²¨;
    ìƒˆìœ ì €.ë ˆë²¨ê³µê²©ë ¥ += ë ˆë²¨ì—…ì •ë³´.ì¦ê°€í•œê³µê²©ë ¥;
    ìƒˆìœ ì €.ë‚¨ì€ì²´ë ¥ = Math.min(
        ìƒˆìœ ì €.ìµœëŒ€ì²´ë ¥,
        ì „íˆ¬ì²´ë ¥ + íšŒë³µëŸ‰
    );

    return ìƒˆìœ ì €;
}

function ì¼ë°˜ì•…ë§ˆë¶ˆëŸ¬ì˜¤ê¸°(ì¸µ) {
    const ì¼ë°˜ëª¬ìŠ¤í„°ì´ë¦„ = [
        "ë””ë‚˜ë¥´", "ì—ë¦¬ê³¤", "ë„ë ˆì•Œ", "í¬ë¡œì…€", "ë£¨í˜ìŠ¤", "ë²¨", "ì‹œì—ë¥´", "ì„¸ë ˆìš°ìŠ¤", "ë²„ì•Œë² ë¦¬ìŠ¤", "ë°œë¼í¬",
        "ë¡œë…¸ë² ", "ìê°„", "ì•ˆë“œë¼ë©œë¦¬ìš°ìŠ¤", "ë‹ˆë² ë¡œìŠ¤", "ì—ì´ëª¬", "ë¼ì—ìŠ¤", "ì•„ë¼íƒ€ë°”", "ë°”í‹°ë°”ìŠ¤", "ì•„ëª¬", "ì•ˆë“œë¡œë§ë¦¬ìš°ìŠ¤",
        "ë°”í”¼ë©”íŠ¸", "ì˜¤ë¡œì´ì•„ìŠ¤", "ì˜¤ì„¸", "ì•„ë¯¸", "ë°ì¹´ë¸Œë¦¬ì•„", "ë²¨ë¦¬ì•Œ", "ë””ì¹´ë¦¬ë¸Œ", "ì„¸ì´ë¥´", "ì˜¤ë¡œë²„ìŠ¤", "ë¬´ë£¨ë¬´ë¥´",
        "ì¹´ì´ë¯¸", "ì•Œë¡œì„¸ìŠ¤", "ìƒ¤ë¥´ë‚˜í¬", "ìƒ¤í¬", "ì‚¬ë¸Œë‚™", "ë¼í•˜ë¸Œ", "ë§í¬ë¥´ìŠ¤", "í•˜ìš°ë ˆìŠ¤", "í”¼ë‹‰ìŠ¤", "ë¶€ì•Œ",
        "í‘¸ë¥´ì¹´ìŠ¤", "ê°€í”„", "ì•„ìŠ¤ëª¨ë°ìš°ìŠ¤", "í¬ë¥´ì¹´ìŠ¤", "ë³´ë½ìŠ¤", "ê¸€ë¼ì‹œì•„ë¼ë³¼ë¼ìŠ¤", "ë‚˜ë² ë¦¬ìš°ìŠ¤", "ì•„ì´ëª¬", "í”„ë£¨í‘¸ìŠ¤", "ì‚´ë¡œìŠ¤",
        "í•˜í”„ë¦¬", "í˜ë‹ˆì•…ìŠ¤", "ë‹¤ì´ëª¬", "ìŠ¤í‹¸", "ë§ˆë¥´ì½”ì‹œì•„ìŠ¤", "ë³´íŠ¸ìŠ¤", "ì œíŒŒë¥´", "ì—˜ë¦¬ê³ ìŠ¤", "ë ˆë¦¬ì–´", "ë² ë ˆíŠ¸",
        "ì‹œíŠ¸ë¦¬", "êµ¬ì‹œì˜¨", "ë¶€ì—ë¥´", "ì¹´ì„", "í¬ë¥´ë„¤ìš°ìŠ¤", "ë¶€ë„¤", "ì•„ëª¬", "ë§ˆë¼ë°”ìŠ¤", "í‘¸ë¥´ì†", "ë§íŒŒìŠ¤",
        "íŒŒì„", "ë°”ë¥´ë°”í† ìŠ¤"
    ];

    const ëœë¤ê°€ì¤‘ì¹˜ = () => (Math.random() * 0.2 + 0.9); // 0.9 ~ 1.1 ëœë¤

    const ì¼ë°˜ëª©ë¡ = ì¼ë°˜ëª¬ìŠ¤í„°ì´ë¦„.map((ì´ë¦„, i) => {
        const ê¸°ì¤€ì²´ë ¥ = ì¸µ === 1 ? 30 : 30 * Math.pow(10, ì¸µ - 1);
        const ê¸°ì¤€ë°©ì–´ë ¥ = ì¸µ === 1 ? 1 : Math.pow(10, ì¸µ - 1);

        return {
            ì´ë¦„,
            ì²´ë ¥: Math.floor(ê¸°ì¤€ì²´ë ¥ * ëœë¤ê°€ì¤‘ì¹˜()),
            ë°©ì–´ë ¥: Math.floor(ê¸°ì¤€ë°©ì–´ë ¥ * ëœë¤ê°€ì¤‘ì¹˜()),
            íƒ€ì…: "ì¼ë°˜"
        };
    });

    const ê¸°ì¤€ëª¬ìŠ¤í„° = ì¼ë°˜ëª©ë¡[Math.floor(Math.random() * ì¼ë°˜ëª©ë¡.length)];

    return ê¸°ì¤€ëª¬ìŠ¤í„°;
}

function ë ˆì–´ì•…ë§ˆë¶ˆëŸ¬ì˜¤ê¸°(ì¸µ, ì´ë¦„) {
    const ì´ë¦„ë§µ = {
        "ë£¨ì‹œí¼": { ì²´ë ¥ê³„ìˆ˜: 3.2, ë°©ì–´ê³„ìˆ˜: 1.6, íƒ€ì…: "íƒ€ë½" },
        "ì‚¬íƒ„": { ì²´ë ¥ê³„ìˆ˜: 2.0, ë°©ì–´ê³„ìˆ˜: 1.5, íƒ€ì…: "íƒœì´ˆ" },
        "ë²¨ì œë¶€ë¸Œ": { ì²´ë ¥ê³„ìˆ˜: 1.8, ë°©ì–´ê³„ìˆ˜: 1.4, íƒ€ì…: "ê³ ëŒ€" },
        "ë ˆë¹„ì•„íƒ„": { ì²´ë ¥ê³„ìˆ˜: 1.6, ë°©ì–´ê³„ìˆ˜: 1.3, íƒ€ì…: "ì‹ í™”" },
        "ë””ì•„ë¸”ë¡œ": { ì²´ë ¥ê³„ìˆ˜: 1.2, ë°©ì–´ê³„ìˆ˜: 1.1, íƒ€ì…: "ë ˆì–´" },
        "ë¦´ë¦¬íŠ¸": { ì²´ë ¥ê³„ìˆ˜: 1, ë°©ì–´ê³„ìˆ˜: 1, íƒ€ì…: "ì¼ë°˜" },
        "ê²½ê³ ë¸”ë¦°": { ì²´ë ¥ê³„ìˆ˜: 1.1, ë°©ì–´ê³„ìˆ˜: 1.1, íƒ€ì…: "ê²½í—˜" },
        "í™©ê¸ˆê³ ë¸”ë¦°": { ì²´ë ¥ê³„ìˆ˜: 0.8, ë°©ì–´ê³„ìˆ˜: 0.8, íƒ€ì…: "í™©ê¸ˆ" },
        "ìˆ™ê³ ë¸”ë¦°": { ì²´ë ¥ê³„ìˆ˜: 1.4, ë°©ì–´ê³„ìˆ˜: 1.2, íƒ€ì…: "ê³„ì‹œ" },
    };

    const ì„¤ì • = ì´ë¦„ë§µ[ì´ë¦„];
    if (!ì„¤ì •) return null;

    const ê¸°ì¤€ì²´ë ¥ = ì¸µ === 1 ? 30 : 30 * Math.pow(10, ì¸µ - 1);
    const ê¸°ì¤€ë°©ì–´ë ¥ = ì¸µ === 1 ? 1 : Math.pow(10, ì¸µ - 1);

    const ëœë¤ê°€ì¤‘ì¹˜ = () => (Math.random() * 0.2 + 0.9);

    return {
        ì´ë¦„,
        ì²´ë ¥: Math.floor(ê¸°ì¤€ì²´ë ¥ * ì„¤ì •.ì²´ë ¥ê³„ìˆ˜ * ëœë¤ê°€ì¤‘ì¹˜()),
        ë°©ì–´ë ¥: Math.floor(ê¸°ì¤€ë°©ì–´ë ¥ * ì„¤ì •.ë°©ì–´ê³„ìˆ˜ * ëœë¤ê°€ì¤‘ì¹˜()),
        íƒ€ì…: ì„¤ì •.íƒ€ì…
    };
}

function ìµœì¢…ê³µê²©ë ¥ê³„ì‚°(ìœ ì €) {
    const ë ˆë²¨ê³µê²©ë ¥ = ìœ ì €.ë ˆë²¨ê³µê²©ë ¥ || 10;
    const ì¥ë¹„ê³µê²©ë ¥ = ìœ ì €.ì¥ë¹„ê³µê²©ë ¥ || 0;
    const ì „ì§ê³µê²©ë ¥ = ìœ ì €.ì „ì§ê³µê²©ë ¥ || 1;
    const í«ë‹¨ê³„ì›ë³¸ = ìœ ì €.í«ë‹¨ê³„ || 0;
    const í«ë°°ìœ¨ = 1 + 0.1 * í«ë‹¨ê³„ì›ë³¸;

    const ì†Œë“œê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ì†Œë“œ"] || 0;
    const ìŠ¤í”¼ì–´ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ìŠ¤í”¼ì–´"] || 0;

    const ë£¬ê²€ = ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ëª©ë¡?.find(a => a.ì´ë¦„ === "ë£¬ê²€" && a.ì¥ì°© === 1);
    const ë£¬ê²€ë°°ìœ¨ = ë£¬ê²€ ? (1 + ë£¬ê²€.ë“±ê¸‰ * 0.05) : 1;

    const ì†Œë“œë°°ìœ¨ = 1 + 0.01 * ì†Œë“œê°œìˆ˜;
    const ìŠ¤í”¼ì–´ë°°ìœ¨ = 1 + 0.02 * ìŠ¤í”¼ì–´ê°œìˆ˜;

    const ìµœì¢…ê³µê²©ë ¥ = (ë ˆë²¨ê³µê²©ë ¥ + ì¥ë¹„ê³µê²©ë ¥)
        * (ì „ì§ê³µê²©ë ¥ * 0.1 + 0.9)
        * ì†Œë“œë°°ìœ¨
        * ìŠ¤í”¼ì–´ë°°ìœ¨
        * í«ë°°ìœ¨
        * ë£¬ê²€ë°°ìœ¨;

    return Math.round(ìµœì¢…ê³µê²©ë ¥);
}


function ìµœëŒ€ì²´ë ¥ê³„ì‚°(ìœ ì €) {
    const í•˜íŠ¸ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["í•˜íŠ¸í”ŒëŸ¬ìŠ¤"] || 0;
    const ë³´ì • = 1 + 0.01 * í•˜íŠ¸ê°œìˆ˜;

    const ì•…ì„¸ëª©ë¡ = ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ëª©ë¡ || [];
    const ìº¡í‹´ = ì•…ì„¸ëª©ë¡.find(a => a.ì´ë¦„ === "ìº¡í‹´" && a.ì¥ì°© === 1);
    const ì¶”ê°€ì²´ë ¥ = ìº¡í‹´ ? ìº¡í‹´.ë“±ê¸‰ : 0;

    return Math.round((10 + ì¶”ê°€ì²´ë ¥) * ë³´ì •);
}

function ë ˆì–´ëª¬ìŠ¤í„°ë“±ì¥íŒì •(ìœ ì €) {
    const ê³ ìŠ¤íŠ¸ê°œìˆ˜ = ìœ ì €.ìœ ë¬¼ëª©ë¡?.["ê³ ìŠ¤íŠ¸"] || 0;
    const ê³ ìŠ¤íŠ¸ë³´ì • = 1 + 0.01 * ê³ ìŠ¤íŠ¸ê°œìˆ˜;

    const ë“œë¦¼ìºì²˜ = ìœ ì €.ì•…ì„¸ì‚¬ë¦¬ëª©ë¡?.find(a => a.ì´ë¦„ === "ë“œë¦¼ìºì²˜" && a.ì¥ì°© === 1);
    const ë“œë¦¼ìºì²˜ë³´ì • = ë“œë¦¼ìºì²˜ ? (1 + 0.05 * ë“œë¦¼ìºì²˜.ë“±ê¸‰) : 1;

    const ë³´ì • = ê³ ìŠ¤íŠ¸ë³´ì • * ë“œë¦¼ìºì²˜ë³´ì •;

    const í›„ë³´ = [
        { ì´ë¦„: "ë£¨ì‹œí¼", í™•ë¥ : ë³´ì • * (1 / 25600) },
        { ì´ë¦„: "ì‚¬íƒ„", í™•ë¥ : ë³´ì • * (1 / 12800) },
        { ì´ë¦„: "ë²¨ì œë¶€ë¸Œ", í™•ë¥ : ë³´ì • * (1 / 6400) },
        { ì´ë¦„: "ë ˆë¹„ì•„íƒ„", í™•ë¥ : ë³´ì • * (1 / 3200) },
        { ì´ë¦„: "ë””ì•„ë¸”ë¡œ", í™•ë¥ : ë³´ì • * (1 / 1600) },
        { ì´ë¦„: "ë¦´ë¦¬íŠ¸", í™•ë¥ : ë³´ì • * (1 / 800) },
        { ì´ë¦„: "ê²½ê³ ë¸”ë¦°", í™•ë¥ : ë³´ì • * (1 / 200) },
        { ì´ë¦„: "í™©ê¸ˆê³ ë¸”ë¦°", í™•ë¥ : ë³´ì • * (1 / 200) },
        { ì´ë¦„: "ìˆ™ê³ ë¸”ë¦°", í™•ë¥ : ë³´ì • * (1 / 200) },
    ];

    const ì´í•© = í›„ë³´.reduce((í•©, í•­ëª©) => í•© + í•­ëª©.í™•ë¥ , 0);
    const ë‚¨ì€í™•ë¥  = Math.max(0, 1 - ì´í•©);  // null í™•ë¥ 

    if (ë‚¨ì€í™•ë¥  > 0) í›„ë³´.push({ ì´ë¦„: null, í™•ë¥ : ë‚¨ì€í™•ë¥  });

    const r = Math.random();
    let ëˆ„ì  = 0;
    for (const í•­ëª© of í›„ë³´) {
        ëˆ„ì  += í•­ëª©.í™•ë¥ ;
        if (r < ëˆ„ì ) return í•­ëª©.ì´ë¦„;
    }
    return null;
}

const ì¼ë°˜ìœ ë¬¼ë°ì´í„° = {
    "ì†Œë“œ": { ì„¤ëª…: "ê³µê²©ë ¥ì´ ì¦ê°€í•©ë‹ˆë‹¤(*1%)" },
    "í•˜íŠ¸í”ŒëŸ¬ìŠ¤": { ì„¤ëª…: "ì²´ë ¥ì´ ì¦ê°€í•©ë‹ˆë‹¤(*1%)" },
    "ê³ ìŠ¤íŠ¸": { ì„¤ëª…: "íˆë“ ëª¬ìŠ¤í„° ë“±ì¥ë¥ ì´ ì¦ê°€í•©ë‹ˆë‹¤(*1%)" },
    "ì‰´ë“œë°´": { ì„¤ëª…: "ì•…ë§ˆë“¤ì˜ ë°©ì–´ë ¥ì„ ê°ì†Œì‹œí‚µë‹ˆë‹¤(*1%)" },
    "í•˜íŠ¸ë§ˆì´ë„ˆìŠ¤": { ì„¤ëª…: "ì•…ë§ˆë“¤ì˜ ì²´ë ¥ ê°ì†Œ(*0.1%)" },
    "í´ë¡œë²„": { ì„¤ëª…: "ì¥ë¹„ ë„ë°•í™•ë¥ ì´ ì¦ê°€í•©ë‹ˆë‹¤(*0.1%)" },
    "ëª¨ë˜ì‹œê³„": { ì„¤ëª…: "ìŠ¤íƒœë¯¸ë„ˆ ì†Œëª¨ë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤(0.1%)" },
    "ì•”í¬ë¼": { ì„¤ëª…: "ë³´ìŠ¤ì „ ìŠ¤íƒœë¯¸ë„ˆ ì†Œëª¨ëŸ‰ ê°ì†Œ(1%)" },
    "í¼ì¦": { ì„¤ëª…: "ë„ë°•ë¹„ìš©ì„ ë¬´ì‹œí•©ë‹ˆë‹¤(0.1%)" },
    "ìŠ¤íƒ­": { ì„¤ëª…: "í™”ë ¤í•œ ë°œì¬ê°„ìœ¼ë¡œ ì²´ë ¥ì†Œëª¨ë¬´ì‹œ(0.1%)" },
    "ë§ì¹˜": { ì„¤ëª…: "ë£¨ì‹œí¼ì˜ ì‹¬ì¥ ê°•í™”í™•ë¥  ì¦ê°€(+0.1%)" },
    "ëª¨ë£¨": { ì„¤ëª…: "ì¦ë°œë˜ëŠ” ì¬ë£Œë¥¼ ì¬ì¡°ë¦½í•©ë‹ˆë‹¤(0.1%)" },
    "íœíƒ€ê·¸ë¨": { ì„¤ëª…: "ì§„í™” í™•ë¥ ì„ ì¦ê°€ì‹œí‚µë‹ˆë‹¤(+0.01%)" },
};
const ë ˆì–´ìœ ë¬¼ë°ì´í„° = {
    "ì†Œë“œ": { ì„¤ëª…: "ê³µê²©ë ¥ì´ ì¦ê°€í•©ë‹ˆë‹¤(*1%)" },
    "í•˜íŠ¸í”ŒëŸ¬ìŠ¤": { ì„¤ëª…: "ì²´ë ¥ì´ ì¦ê°€í•©ë‹ˆë‹¤(*1%)" },
    "ê³ ìŠ¤íŠ¸": { ì„¤ëª…: "íˆë“ ëª¬ìŠ¤í„° ë“±ì¥ë¥ ì´ ì¦ê°€í•©ë‹ˆë‹¤(*1%)" },
    "ì‰´ë“œë°´": { ì„¤ëª…: "ì•…ë§ˆë“¤ì˜ ë°©ì–´ë ¥ì„ ê°ì†Œì‹œí‚µë‹ˆë‹¤(*1%)" },
    "í•˜íŠ¸ë§ˆì´ë„ˆìŠ¤": { ì„¤ëª…: "ì•…ë§ˆë“¤ì˜ ì²´ë ¥ ê°ì†Œ(*0.1%)" },
    "í´ë¡œë²„": { ì„¤ëª…: "ì¥ë¹„ ë„ë°•í™•ë¥ ì´ ì¦ê°€í•©ë‹ˆë‹¤(*0.1%)" },
    "ëª¨ë˜ì‹œê³„": { ì„¤ëª…: "ìŠ¤íƒœë¯¸ë„ˆ ì†Œëª¨ë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤(0.1%)" },
    "ì•”í¬ë¼": { ì„¤ëª…: "ë³´ìŠ¤ì „ ìŠ¤íƒœë¯¸ë„ˆ ì†Œëª¨ëŸ‰ ê°ì†Œ(1%)" },
    "í¼ì¦": { ì„¤ëª…: "ë„ë°•ë¹„ìš©ì„ ë¬´ì‹œí•©ë‹ˆë‹¤(0.1%)" },
    "ìŠ¤íƒ­": { ì„¤ëª…: "í™”ë ¤í•œ ë°œì¬ê°„ìœ¼ë¡œ ì²´ë ¥ì†Œëª¨ë¬´ì‹œ(0.1%)" },
    "í”Œë¼ì›Œ": { ì„¤ëª…: "ìŠ¤í‚¬ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤" },
    "ë¼ˆë‹¤êµ¬": { ì„¤ëª…: "ì§ì—…ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤" },
    "í‹°ì¼“": { ì„¤ëª…: "ê³ ê¸‰ì¥ë¹„ë„ë°•ì— ì‚¬ìš©ë©ë‹ˆë‹¤" },
    "ìƒëŸ¬ë“œ": { ì„¤ëª…: "ìŠ¤íƒœë¯¸ë„ˆë¥¼ ì¶©ì „í•©ë‹ˆë‹¤(+60)" },
    "ì—´ì‡ ": { ì„¤ëª…: "ì§€í•˜ë˜ì „ì— ì§„ì…í•©ë‹ˆë‹¤" },
    "ìŠ¤í”¼ì»¤": { ì„¤ëª…: "ê´‘ì¥ì—ì„œ ì†Œë¦¬ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤" },
    "ë§ì¹˜": { ì„¤ëª…: "ë£¨ì‹œí¼ì˜ ì‹¬ì¥ ê°•í™”í™•ë¥  ì¦ê°€(+0.1%)" },
    "ëª¨ë£¨": { ì„¤ëª…: "ì¦ë°œë˜ëŠ” ì¬ë£Œë¥¼ ì¬ì¡°ë¦½í•©ë‹ˆë‹¤(0.1%)" },
    "íœíƒ€ê·¸ë¨": { ì„¤ëª…: "ì§„í™” í™•ë¥ ì„ ì¦ê°€ì‹œí‚µë‹ˆë‹¤(+0.01%)" },
    "ì•ˆê²½": { ì„¤ëª…: "ì•…ì„¸ì‚¬ë¦¬ë¥¼ ë°”ê¿”ë‚„ ìˆ˜ ìˆìŠµë‹ˆë‹¤" },
};
const ì‹ í™”ìœ ë¬¼ë°ì´í„° = {
    "ì†Œë“œ": { ì„¤ëª…: "ê³µê²©ë ¥ì´ ì¦ê°€í•©ë‹ˆë‹¤(*1%)" },
    "í•˜íŠ¸í”ŒëŸ¬ìŠ¤": { ì„¤ëª…: "ì²´ë ¥ì´ ì¦ê°€í•©ë‹ˆë‹¤(*1%)" },
    "ê³ ìŠ¤íŠ¸": { ì„¤ëª…: "íˆë“ ëª¬ìŠ¤í„° ë“±ì¥ë¥ ì´ ì¦ê°€í•©ë‹ˆë‹¤(*1%)" },
    "ì‰´ë“œë°´": { ì„¤ëª…: "ì•…ë§ˆë“¤ì˜ ë°©ì–´ë ¥ì„ ê°ì†Œì‹œí‚µë‹ˆë‹¤(*1%)" },
    "í•˜íŠ¸ë§ˆì´ë„ˆìŠ¤": { ì„¤ëª…: "ì•…ë§ˆë“¤ì˜ ì²´ë ¥ ê°ì†Œ(*0.1%)" },
    "í´ë¡œë²„": { ì„¤ëª…: "ì¥ë¹„ ë„ë°•í™•ë¥ ì´ ì¦ê°€í•©ë‹ˆë‹¤(*0.1%)" },
    "ëª¨ë˜ì‹œê³„": { ì„¤ëª…: "ìŠ¤íƒœë¯¸ë„ˆ ì†Œëª¨ë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤(0.1%)" },
    "ì•”í¬ë¼": { ì„¤ëª…: "ë³´ìŠ¤ì „ ìŠ¤íƒœë¯¸ë„ˆ ì†Œëª¨ëŸ‰ ê°ì†Œ(1%)" },
    "í¼ì¦": { ì„¤ëª…: "ë„ë°•ë¹„ìš©ì„ ë¬´ì‹œí•©ë‹ˆë‹¤(0.1%)" },
    "ìŠ¤íƒ­": { ì„¤ëª…: "í™”ë ¤í•œ ë°œì¬ê°„ìœ¼ë¡œ ì²´ë ¥ì†Œëª¨ë¬´ì‹œ(0.1%)" },
    "í”Œë¼ì›Œ": { ì„¤ëª…: "ìŠ¤í‚¬ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤" },
    "ë¼ˆë‹¤êµ¬": { ì„¤ëª…: "ì§ì—…ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤" },
    "í‹°ì¼“": { ì„¤ëª…: "ê³ ê¸‰ì¥ë¹„ë„ë°•ì— ì‚¬ìš©ë©ë‹ˆë‹¤" },
    "ìƒëŸ¬ë“œ": { ì„¤ëª…: "ìŠ¤íƒœë¯¸ë„ˆë¥¼ ì¶©ì „í•©ë‹ˆë‹¤(+60)" },
    "ì—´ì‡ ": { ì„¤ëª…: "ì§€í•˜ë˜ì „ì— ì§„ì…í•©ë‹ˆë‹¤" },
    "ìŠ¤í”¼ì»¤": { ì„¤ëª…: "ê´‘ì¥ì—ì„œ ì†Œë¦¬ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤" },
    "ë§ˆë²•ì˜íŒ”ë ˆíŠ¸": { ì„¤ëª…: "ì•„ì´ë””ë¥¼ ì—¼ìƒ‰í•©ë‹ˆë‹¤" },
    "í–„ë²„ê±°": { ì„¤ëª…: "ìŠ¤íƒœë¯¸ë„ˆë¥¼ ì¶©ì „í•©ë‹ˆë‹¤(+300)" },
    "ë§ì¹˜": { ì„¤ëª…: "ë£¨ì‹œí¼ì˜ ì‹¬ì¥ ê°•í™”í™•ë¥  ì¦ê°€(+0.1%)" },
    "ëª¨ë£¨": { ì„¤ëª…: "ì¦ë°œë˜ëŠ” ì¬ë£Œë¥¼ ì¬ì¡°ë¦½í•©ë‹ˆë‹¤(0.1%)" },
    "íœíƒ€ê·¸ë¨": { ì„¤ëª…: "ì§„í™” í™•ë¥ ì„ ì¦ê°€ì‹œí‚µë‹ˆë‹¤(+0.01%)" },
    "ì•ˆê²½": { ì„¤ëª…: "ì•…ì„¸ì‚¬ë¦¬ë¥¼ ë°”ê¿”ë‚„ ìˆ˜ ìˆìŠµë‹ˆë‹¤" },
    "ìŠ¤í”¼ì–´": { ì„¤ëª…: "ê³µê²©ë ¥ì´ ì¦ê°€í•©ë‹ˆë‹¤(*2%)" },
};


// ğŸŸ¡ ì •ì  íŒŒì¼ ê²½ë¡œ ì„¤ì •
app.use(express.static(path.join(__dirname)));

